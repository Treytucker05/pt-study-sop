%% PT Study SOP - Complete Session Flow (M0-M6)
%% Detailed breakdown of the session lifecycle

flowchart TD
    Start([Session Start]) --> M0["M0: PLANNING<br/>━━━━━━━━━━━━━━━<br/>No teaching until:<br/>1. Target declared (exam/block/time)<br/>2. Sources listed (source-lock)<br/>3. Plan sketched (3-5 steps)<br/>4. Weak anchors identified<br/>   (interleaving check)<br/>5. Pre-test given"]

    M0 -->|✓ Planning Complete| M1["M1: ENTRY<br/>━━━━━━━━━━━━━━━<br/>State Check:<br/>- Focus level (1-10)<br/>- Topic & materials<br/>- Time available<br/><br/>Mode Selection:<br/>- Core (new material)<br/>- Sprint (test-first)<br/>- Light (micro: 10-15 min)<br/>- Quick Sprint (20-30 min)<br/>- Drill (repeated misses)"]

    M1 -->|✓ Mode Selected| M2["M2: PRIME<br/>Map the Territory<br/>━━━━━━━━━━━━━━━<br/>Do NOT teach details yet<br/><br/>1. H1 Scan<br/>   System > Subsystem ><br/>   Component > Element<br/>2. Bucket into 2-4 groups<br/>   (spatial/mechanism/<br/>    compare/workflow)<br/>3. Select first bucket<br/>4. Pre-questions (1-3 or 60-120s brain dump)"]

    M2 -->|✓ Map Complete| M3_M5["M3-M5: ENCODE + BUILD<br/>Behavior modulated by Mode<br/>━━━━━━━━━━━━━━━━━━<br/><br/>M3: ENCODE<br/>───────────"]

    M3_M5 --> M3["KWIK Flow per hook:<br/>1. Sound (phonetic seed)<br/>2. Function (true action)<br/>3. Image (tied to function)<br/>4. Resonance (learner approval)<br/>5. Lock (card/log)<br/><br/>Rules:<br/>- Seed-Lock: learner attempts first<br/>- Function before Image<br/>- Never skip resonance"]

    M3 -->|✓ Bucket Encoded| M4["M4: BUILD<br/>Practice & Transfer<br/>━━━━━━━━━━━━━━━<br/>1. L2 Teach-back GATE<br/>   (must pass before L4)<br/>2. Progressive Ladder<br/>   Guided → Faded →<br/>   Independent → Interleaved<br/>3. 50% rule: if accuracy<br/>   drops below 50%,<br/>   step back one tier<br/>4. Capture all misses"]

    M4 -->|✓ Practice Complete| M5_Engine{Content<br/>Type?}

    M5_Engine -->|Anatomy| M5_Anat["M5: MODES apply across<br/>M2-M4 behavior<br/>━━━━━━━━━━━━━━━<br/><br/>ANATOMY ENGINE<br/>───────────────<br/>Sequence:<br/>1. Bones (scaffold)<br/>2. Landmarks (attachment points)<br/>   - Visual > Spatial ><br/>     Neighbors > Attachments<br/>3. Attachments (map origins/insertions)<br/>4. Actions<br/>5. Nerves<br/>6. Arterial Supply<br/>7. Clinical<br/><br/>Drawing Protocol:<br/>Bone outline → landmarks →<br/>muscle lines → O/I labels →<br/>action arrows<br/><br/>Rollback on miss:<br/>Visual → Attachments →<br/>Re-layer OIANA+"]

    M5_Engine -->|Concept| M5_Concept["CONCEPT ENGINE<br/>───────────────<br/>Sequence:<br/>1. Definition (L2 plain-language)<br/>2. Context (hierarchy placement)<br/>3. Mechanism (input > process > output)<br/>4. Differentiation<br/>   (near neighbor comparison)<br/>5. Application (one problem)<br/><br/>Rules:<br/>- Generation-first<br/>- Keep concise (6 bullets max)<br/>- L2 teach-back gate<br/>  before L4 detail"]

    M5_Anat --> M6["M6: WRAP<br/>Close & Schedule<br/>━━━━━━━━━━━━━━━<br/><br/>Exit Ticket (mandatory):<br/>1. Free recall blurt (2 min, no notes)<br/>2. Muddiest point<br/>3. Next action hook<br/><br/>Session Ledger (mandatory):<br/>- session_date (YYYY-MM-DD)<br/>- covered (semicolon-separated)<br/>- not_covered (semicolon-separated)<br/>- weak_anchors<br/>- artifacts_created<br/>- timebox_min<br/><br/>Card Wrap (if created):<br/>- Error classification<br/>- Weak anchor flags<br/>- Source tags<br/><br/>❌ NO spacing schedule output<br/>   (handled by Dashboard/Planner)"]

    M5_Concept --> M6

    M6 -->|✓ Session Complete| PostSession["Post-Session:<br/>Progress Tracking<br/>━━━━━━━━━━━━━━━<br/>Update Progress Tracker:<br/>- Module / Topic / LO<br/>- Status (Solid = 2 retrieval successes)<br/>- Last session date<br/>- Next action<br/>- Next review date"]

    PostSession -->|Weekly Review| Weekly["Weekly Review (10 min)<br/>━━━━━━━━━━━━━━━━━<br/>1. Scan 'Needs review' rows<br/>2. Pick 1-2 to interleave<br/>3. Update spacing dates<br/><br/>3+2 Rotation:<br/>- Study 3 classes (1 session each)<br/>- Review 2 weakest anchors<br/>- Repeat"]

    Weekly -->|Plan Next| End(["Next Session"])

    style M0 fill:#ff6b6b,stroke:#333,color:#fff
    style M1 fill:#ff8787,stroke:#333,color:#fff
    style M2 fill:#ffab91,stroke:#333,color:#000
    style M3_M5 fill:#ffcc80,stroke:#333,color:#000
    style M3 fill:#fff59d,stroke:#333,color:#000
    style M4 fill:#c5e1a5,stroke:#333,color:#000
    style M5_Anat fill:#b2dfdb,stroke:#333,color:#000
    style M5_Concept fill:#b2dfdb,stroke:#333,color:#000
    style M6 fill:#b3e5fc,stroke:#333,color:#000
    style PostSession fill:#c8e6c9,stroke:#333,color:#000
    style Weekly fill:#e1bee7,stroke:#333,color:#000
