<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Arcade Page Builder</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  :root {
    --primary: #ef4444;
    --primary-dim: rgba(239,68,68,0.3);
    --primary-bg: rgba(239,68,68,0.08);
    --bg: #0a0a0a;
    --surface: rgba(0,0,0,0.7);
    --surface-light: rgba(20,20,20,0.9);
    --border: rgba(239,68,68,0.4);
    --text: #e5e5e5;
    --muted: #737373;
    --yellow: #eab308;
    --blue: #60a5fa;
    --green: #4ade80;
    --purple: #a78bfa;
    --cyan: #22d3ee;
    --font-arcade: 'Courier New', monospace;
    --font-terminal: 'Consolas', 'Courier New', monospace;
    --grid: 8px;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-terminal);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* â•â•â• TOP TOOLBAR â•â•â• */
  .toolbar {
    height: 40px;
    background: #111;
    border-bottom: 2px solid var(--primary);
    display: flex;
    align-items: center;
    padding: 0 10px;
    gap: 8px;
    flex-shrink: 0;
    z-index: 1000;
  }
  .toolbar h1 {
    font-family: var(--font-arcade);
    font-size: 12px;
    color: var(--primary);
    letter-spacing: 2px;
    white-space: nowrap;
  }
  .sep { width: 1px; height: 18px; background: var(--primary-dim); flex-shrink: 0; }

  .tb-btn {
    background: transparent;
    border: 1px solid var(--primary-dim);
    color: var(--text);
    font-family: var(--font-arcade);
    font-size: 10px;
    padding: 3px 8px;
    cursor: pointer;
    letter-spacing: 1px;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .tb-btn:hover { background: var(--primary-bg); border-color: var(--primary); color: var(--primary); }
  .tb-btn.active { background: var(--primary); color: #000; border-color: var(--primary); }
  .tb-btn.danger { border-color: rgba(239,68,68,0.5); }
  .tb-btn.danger:hover { background: rgba(239,68,68,0.2); color: #ef4444; }

  .tb-copy {
    margin-left: auto;
    background: var(--primary);
    color: #000;
    border: none;
    font-family: var(--font-arcade);
    font-size: 10px;
    padding: 5px 14px;
    cursor: pointer;
    letter-spacing: 1px;
    font-weight: bold;
  }
  .tb-copy:hover { filter: brightness(1.2); }

  /* â•â•â• MAIN LAYOUT â•â•â• */
  .main {
    flex: 1;
    display: flex;
    min-height: 0;
  }

  /* â•â•â• PALETTE SIDEBAR â•â•â• */
  .palette {
    width: 220px;
    background: #0d0d0d;
    border-right: 2px solid var(--primary-dim);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    flex-shrink: 0;
    z-index: 50;
  }
  .palette-header {
    padding: 8px 10px;
    font-family: var(--font-arcade);
    font-size: 10px;
    color: var(--primary);
    letter-spacing: 2px;
    border-bottom: 1px solid var(--primary-dim);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .palette-scroll {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
  }
  .palette-scroll::-webkit-scrollbar { width: 4px; }
  .palette-scroll::-webkit-scrollbar-thumb { background: var(--primary-dim); }

  .pal-section {
    border-bottom: 1px solid rgba(239,68,68,0.1);
  }
  .pal-section-header {
    padding: 6px 10px;
    font-family: var(--font-arcade);
    font-size: 9px;
    color: var(--muted);
    letter-spacing: 2px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    user-select: none;
  }
  .pal-section-header:hover { color: var(--primary); background: rgba(239,68,68,0.03); }
  .pal-section-header .arrow { font-size: 8px; transition: transform 0.15s; }
  .pal-section-header .arrow.open { transform: rotate(90deg); }
  .pal-section-body { padding: 4px 8px 8px; display: flex; flex-direction: column; gap: 4px; }
  .pal-section-body.closed { display: none; }

  .pal-item {
    padding: 6px 8px;
    background: rgba(0,0,0,0.4);
    border: 1px solid rgba(255,255,255,0.06);
    cursor: grab;
    font-size: 11px;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.12s;
    user-select: none;
  }
  .pal-item:hover {
    border-color: var(--primary-dim);
    background: rgba(239,68,68,0.05);
  }
  .pal-item:active { cursor: grabbing; opacity: 0.7; }
  .pal-item .icon { font-size: 13px; width: 18px; text-align: center; flex-shrink: 0; }
  .pal-item .label { font-family: var(--font-terminal); font-size: 10px; color: var(--text); }
  .pal-item .hint { font-family: var(--font-terminal); font-size: 9px; color: var(--muted); margin-left: auto; }

  /* â•â•â• CANVAS â•â•â• */
  .canvas {
    flex: 1;
    position: relative;
    overflow: hidden;
    background:
      radial-gradient(circle at 50% 50%, rgba(239,68,68,0.02) 0%, transparent 70%),
      repeating-linear-gradient(0deg, transparent, transparent calc(var(--grid) - 1px), rgba(239,68,68,0.03) var(--grid)),
      repeating-linear-gradient(90deg, transparent, transparent calc(var(--grid) - 1px), rgba(239,68,68,0.03) var(--grid));
  }
  .canvas.drop-active {
    background-color: rgba(239,68,68,0.02);
  }

  /* â•â•â• PANEL â•â•â• */
  .panel {
    position: absolute;
    background: var(--surface);
    border: 2px solid var(--primary);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-width: 120px;
    min-height: 48px;
  }
  .panel.dragging { box-shadow: 0 0 20px rgba(239,68,68,0.25); z-index: 100; }
  .panel.selected { box-shadow: 0 0 0 2px rgba(239,68,68,0.5), 0 0 16px rgba(239,68,68,0.15); z-index: 99; }
  .panel.drop-target { border-color: var(--green); box-shadow: 0 0 12px rgba(74,222,128,0.3); }

  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 3px 8px;
    background: rgba(239,68,68,0.1);
    border-bottom: 1px solid var(--primary-dim);
    cursor: move;
    user-select: none;
    min-height: 24px;
    gap: 6px;
  }
  .panel-header .title {
    font-family: var(--font-arcade);
    font-size: 10px;
    color: var(--primary);
    letter-spacing: 2px;
  }
  .panel-header .dims {
    font-size: 9px;
    color: var(--muted);
    font-family: var(--font-terminal);
  }
  .panel-header .close-btn {
    width: 14px; height: 14px;
    display: flex; align-items: center; justify-content: center;
    font-size: 10px; color: var(--muted);
    cursor: pointer; border: none; background: none;
    opacity: 0; transition: opacity 0.15s;
  }
  .panel-header:hover .close-btn { opacity: 1; }
  .panel-header .close-btn:hover { color: var(--primary); }

  .panel-body {
    flex: 1;
    overflow: auto;
    position: relative;
  }

  /* resize handles */
  .rh { position: absolute; z-index: 10; }
  .rh.n  { top:-3px; left:6px; right:6px; height:6px; cursor:n-resize; }
  .rh.s  { bottom:-3px; left:6px; right:6px; height:6px; cursor:s-resize; }
  .rh.e  { right:-3px; top:6px; bottom:6px; width:6px; cursor:e-resize; }
  .rh.w  { left:-3px; top:6px; bottom:6px; width:6px; cursor:w-resize; }
  .rh.ne { top:-3px; right:-3px; width:10px; height:10px; cursor:ne-resize; }
  .rh.nw { top:-3px; left:-3px; width:10px; height:10px; cursor:nw-resize; }
  .rh.se { bottom:-3px; right:-3px; width:10px; height:10px; cursor:se-resize; }
  .rh.sw { bottom:-3px; left:-3px; width:10px; height:10px; cursor:sw-resize; }

  /* â•â•â• DROP ZONE inside panels â•â•â• */
  .drop-zone {
    min-height: 16px;
    border: 1px dashed transparent;
    transition: border-color 0.12s, background 0.12s;
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    align-items: center;
    padding: 3px 6px;
  }
  .drop-zone.highlight { border-color: var(--green); background: rgba(74,222,128,0.05); }
  .drop-zone.vertical { flex-direction: column; align-items: stretch; }

  /* â•â•â• DRAGGABLE ITEMS â•â•â• */
  .drag-item {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    cursor: grab;
    user-select: none;
    transition: outline 0.1s;
    position: relative;
  }
  .drag-item:active { cursor: grabbing; }
  .drag-item.dragging-item { opacity: 0.5; outline: 1px dashed var(--primary); }

  /* â•â•â• COMPONENT STYLES â•â•â• */

  /* Buttons */
  .c-btn-primary {
    padding: 4px 14px;
    font-family: var(--font-arcade);
    font-size: 10px;
    letter-spacing: 1px;
    background: var(--primary);
    border: 2px solid var(--primary);
    color: #000;
    font-weight: bold;
    white-space: nowrap;
  }
  .c-btn-ghost {
    padding: 4px 12px;
    font-family: var(--font-terminal);
    font-size: 11px;
    background: transparent;
    border: 1px solid var(--primary-dim);
    color: var(--text);
    white-space: nowrap;
  }
  .c-btn-outline {
    padding: 4px 12px;
    font-family: var(--font-arcade);
    font-size: 10px;
    letter-spacing: 1px;
    background: transparent;
    border: 2px solid var(--primary);
    color: var(--primary);
    white-space: nowrap;
  }
  .c-btn-icon {
    width: 28px; height: 28px;
    display: inline-flex; align-items: center; justify-content: center;
    background: transparent;
    border: 1px solid var(--primary-dim);
    color: var(--muted);
    font-size: 13px;
  }

  /* Inputs */
  .c-input {
    padding: 4px 10px;
    font-family: var(--font-terminal);
    font-size: 11px;
    background: rgba(0,0,0,0.5);
    border: 1px solid var(--primary-dim);
    color: var(--muted);
    white-space: nowrap;
    min-width: 100px;
  }
  .c-input-search {
    padding: 4px 10px 4px 24px;
    font-family: var(--font-terminal);
    font-size: 11px;
    background: rgba(0,0,0,0.5);
    border: 1px solid var(--primary-dim);
    color: var(--muted);
    white-space: nowrap;
    position: relative;
    min-width: 120px;
  }
  .c-select {
    padding: 4px 10px;
    font-family: var(--font-terminal);
    font-size: 11px;
    background: rgba(0,0,0,0.5);
    border: 1px solid var(--primary-dim);
    color: var(--text);
    white-space: nowrap;
  }
  .c-textarea {
    padding: 6px 10px;
    font-family: var(--font-terminal);
    font-size: 11px;
    background: rgba(0,0,0,0.4);
    border: 1px solid var(--primary-dim);
    color: var(--muted);
    min-height: 60px;
    width: 100%;
    white-space: pre-wrap;
  }

  /* Chips & Badges */
  .c-chip {
    padding: 3px 10px;
    font-family: var(--font-arcade);
    font-size: 9px;
    letter-spacing: 1px;
    border: 2px solid var(--primary-dim);
    background: rgba(0,0,0,0.5);
    color: rgba(239,68,68,0.8);
    white-space: nowrap;
  }
  .c-chip.on { background: var(--primary); color: #000; border-color: var(--primary); }
  .c-badge {
    padding: 1px 6px;
    font-family: var(--font-arcade);
    font-size: 9px;
    letter-spacing: 1px;
    border: 1px solid var(--primary-dim);
    color: var(--primary);
    white-space: nowrap;
  }
  .c-badge.green { border-color: rgba(74,222,128,0.5); color: var(--green); }
  .c-badge.blue { border-color: rgba(96,165,250,0.5); color: var(--blue); }

  /* Toggle */
  .c-toggle-group { display: inline-flex; gap: 0; }
  .c-toggle-btn {
    padding: 3px 10px;
    font-family: var(--font-terminal);
    font-size: 10px;
    border: 1px solid var(--primary-dim);
    background: rgba(0,0,0,0.5);
    color: var(--muted);
    white-space: nowrap;
  }
  .c-toggle-btn.on { background: var(--primary-bg); color: var(--primary); border-color: var(--primary); }

  /* Checkbox */
  .c-check {
    display: inline-flex; align-items: center; gap: 5px;
    font-family: var(--font-terminal); font-size: 11px; color: var(--muted); white-space: nowrap;
  }
  .c-check .box {
    width: 13px; height: 13px;
    border: 1px solid var(--primary-dim);
    background: rgba(0,0,0,0.4);
    display: inline-flex; align-items: center; justify-content: center;
  }

  /* Labels & Text */
  .c-label {
    font-family: var(--font-arcade);
    font-size: 10px;
    color: var(--primary);
    letter-spacing: 2px;
    white-space: nowrap;
  }
  .c-label-muted {
    font-family: var(--font-arcade);
    font-size: 9px;
    color: var(--muted);
    letter-spacing: 1px;
    white-space: nowrap;
  }
  .c-text {
    font-family: var(--font-terminal);
    font-size: 11px;
    color: var(--text);
    white-space: nowrap;
  }
  .c-text-muted {
    font-family: var(--font-terminal);
    font-size: 11px;
    color: var(--muted);
    white-space: nowrap;
  }

  /* Dividers */
  .c-divider {
    height: 1px;
    background: var(--primary-dim);
    width: 100%;
    flex-shrink: 0;
  }
  .c-divider-thick {
    height: 2px;
    background: var(--primary);
    width: 100%;
    flex-shrink: 0;
  }

  /* Icons with text */
  .c-icon-text {
    display: inline-flex; align-items: center; gap: 4px;
    font-family: var(--font-terminal); font-size: 11px; color: var(--muted);
    white-space: nowrap;
  }

  /* Tree items */
  .c-tree-folder {
    display: flex; align-items: center; gap: 4px;
    padding: 2px 0;
    font-family: var(--font-terminal); font-size: 11px; white-space: nowrap; width: 100%;
  }
  .c-tree-file {
    display: flex; align-items: center; gap: 4px;
    padding: 2px 0 2px 14px;
    font-family: var(--font-terminal); font-size: 11px; white-space: nowrap; width: 100%;
  }
  .c-tree-folder .box, .c-tree-file .box {
    width: 11px; height: 11px;
    border: 1px solid var(--primary-dim);
    background: rgba(0,0,0,0.4);
    flex-shrink: 0;
  }

  /* Session chip */
  .c-session {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 3px 8px;
    border: 1px solid rgba(255,255,255,0.1);
    font-family: var(--font-terminal); font-size: 10px; color: var(--muted);
    white-space: nowrap;
  }
  .c-session .dot {
    width: 5px; height: 5px; border-radius: 50%;
  }
  .c-session .dot.green { background: var(--green); }
  .c-session .dot.gray { background: var(--muted); }

  /* Stat block */
  .c-stat {
    display: inline-flex; flex-direction: column; align-items: center; gap: 2px;
    padding: 6px 12px;
    border: 1px solid var(--primary-dim);
    background: rgba(0,0,0,0.3);
    min-width: 60px;
  }
  .c-stat .val { font-family: var(--font-arcade); font-size: 16px; color: var(--primary); }
  .c-stat .lbl { font-family: var(--font-terminal); font-size: 9px; color: var(--muted); letter-spacing: 1px; }

  /* Progress bar */
  .c-progress {
    height: 6px;
    background: rgba(0,0,0,0.4);
    border: 1px solid var(--primary-dim);
    width: 100%;
    position: relative;
  }
  .c-progress .fill {
    position: absolute;
    left: 0; top: 0; bottom: 0;
    background: var(--primary);
    width: 65%;
  }

  /* Chat bubble */
  .c-chat-user {
    padding: 6px 10px;
    background: rgba(239,68,68,0.1);
    border: 1px solid var(--primary-dim);
    font-family: var(--font-terminal); font-size: 11px; color: var(--text);
    max-width: 80%;
    align-self: flex-end;
  }
  .c-chat-ai {
    padding: 6px 10px;
    background: rgba(0,0,0,0.4);
    border: 1px solid rgba(255,255,255,0.08);
    font-family: var(--font-terminal); font-size: 11px; color: var(--text);
    max-width: 80%;
    align-self: flex-start;
  }

  /* Scroll area indicator */
  .c-scroll-area {
    border: 1px solid var(--primary-dim);
    background: rgba(0,0,0,0.2);
    padding: 4px;
    min-height: 40px;
    width: 100%;
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .c-scroll-area::after {
    content: 'â†• scroll';
    position: absolute;
    right: 4px;
    top: 4px;
    font-size: 8px;
    color: var(--muted);
    opacity: 0.5;
  }

  /* â•â•â• GHOST (drag preview) â•â•â• */
  .drag-ghost {
    position: fixed;
    pointer-events: none;
    z-index: 10000;
    opacity: 0.8;
    transform: scale(1.02);
    filter: drop-shadow(0 0 8px rgba(239,68,68,0.4));
  }

  /* â•â•â• INFO BAR â•â•â• */
  .info-bar {
    height: 32px;
    background: #111;
    border-top: 1px solid var(--primary-dim);
    display: flex;
    align-items: center;
    padding: 0 12px;
    gap: 16px;
    font-size: 10px;
    color: var(--muted);
    flex-shrink: 0;
    z-index: 1000;
  }
  .info-bar .val { color: var(--primary); font-weight: bold; }

  /* â•â•â• PROMPT BAR â•â•â• */
  .prompt-bar {
    background: #111;
    border-top: 1px solid var(--primary-dim);
    padding: 6px 12px;
    display: none;
    font-size: 10px;
    color: var(--text);
    gap: 8px;
    align-items: flex-start;
    flex-shrink: 0;
    max-height: 140px;
  }
  .prompt-bar.visible { display: flex; }
  .prompt-bar pre {
    flex: 1;
    white-space: pre-wrap;
    font-family: var(--font-terminal);
    font-size: 10px;
    max-height: 120px;
    overflow-y: auto;
  }
  .prompt-bar button {
    background: var(--primary-dim);
    border: none;
    color: var(--text);
    font-size: 9px;
    padding: 2px 8px;
    cursor: pointer;
    font-family: var(--font-arcade);
  }
</style>
</head>
<body>

<!-- â•â•â• TOOLBAR â•â•â• -->
<div class="toolbar">
  <h1>PAGE BUILDER</h1>
  <div class="sep"></div>
  <button class="tb-btn" onclick="loadPage('tutor-setup')">TUTOR SETUP</button>
  <button class="tb-btn" onclick="loadPage('tutor-chat')">TUTOR CHAT</button>
  <button class="tb-btn" onclick="loadPage('empty')">BLANK</button>
  <div class="sep"></div>
  <button class="tb-btn" onclick="toggleSnap()" id="snapBtn">SNAP: ON</button>
  <button class="tb-btn danger" onclick="deleteSelected()">DELETE</button>
  <button class="tb-copy" onclick="copyPrompt()">COPY LAYOUT</button>
</div>

<!-- â•â•â• MAIN â•â•â• -->
<div class="main">
  <!-- Palette -->
  <div class="palette" id="palette">
    <div class="palette-header">
      <span>COMPONENTS</span>
      <span style="font-size:9px;color:var(--muted)">drag â†’</span>
    </div>
    <div class="palette-scroll" id="paletteScroll"></div>
  </div>

  <!-- Canvas -->
  <div class="canvas" id="canvas"></div>
</div>

<!-- â•â•â• INFO BAR â•â•â• -->
<div class="info-bar">
  <span>Canvas: <span class="val" id="infoCanvas">--</span></span>
  <span>Selected: <span class="val" id="infoSelected">none</span></span>
  <span>Pos: <span class="val" id="infoPos">--</span></span>
  <span>Size: <span class="val" id="infoSize">--</span></span>
  <span style="margin-left:auto;color:var(--muted)">Drag from palette to add â€¢ headers to move â€¢ edges to resize â€¢ items to reorder</span>
</div>

<!-- â•â•â• PROMPT BAR â•â•â• -->
<div class="prompt-bar" id="promptBar">
  <pre id="promptText"></pre>
  <button onclick="document.getElementById('promptBar').classList.remove('visible')">CLOSE</button>
</div>

<!-- â•â•â• GHOST (for palette drag) â•â•â• -->
<div class="drag-ghost" id="dragGhost" style="display:none"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let snap = true;
const SNAP_SZ = 8;
let panels = {};
let panelCounter = 0;
let selectedPanelId = null;

let dragState = null;     // panel move/resize
let itemDragState = null; // item reorder
let paletteDrag = null;   // dragging from palette

const canvas = document.getElementById('canvas');
const ghost = document.getElementById('dragGhost');

function snapV(v) { return snap ? Math.round(v / SNAP_SZ) * SNAP_SZ : v; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPONENT LIBRARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const COMPONENT_LIB = [
  {
    section: 'WINDOWS',
    icon: 'â—»',
    items: [
      { id: 'win-card', icon: 'â—»', label: 'Card Panel', hint: 'empty', template: 'card' },
      { id: 'win-vault', icon: 'ğŸ“', label: 'Vault Picker', hint: 'files', template: 'vault' },
      { id: 'win-toolbar', icon: 'ğŸ”§', label: 'Toolbar Strip', hint: 'controls', template: 'toolbar' },
      { id: 'win-chat', icon: 'ğŸ’¬', label: 'Chat Window', hint: 'messages', template: 'chat' },
      { id: 'win-artifacts', icon: 'ğŸ“‹', label: 'Artifacts Panel', hint: 'sidebar', template: 'artifacts' },
      { id: 'win-stats', icon: 'ğŸ“Š', label: 'Stats Card', hint: 'metrics', template: 'stats' },
      { id: 'win-sessions', icon: 'ğŸ•', label: 'Session List', hint: 'recent', template: 'sessions' },
      { id: 'win-settings', icon: 'âš™', label: 'Settings Panel', hint: 'config', template: 'settings' },
    ],
  },
  {
    section: 'BUTTONS',
    icon: 'â–£',
    items: [
      { id: 'btn-primary', icon: 'â–£', label: 'Primary Button', hint: 'action', html: '<span class="c-btn-primary">BUTTON</span>' },
      { id: 'btn-outline', icon: 'â–¢', label: 'Outline Button', hint: 'alt', html: '<span class="c-btn-outline">BUTTON</span>' },
      { id: 'btn-ghost', icon: 'â–«', label: 'Ghost Button', hint: 'subtle', html: '<span class="c-btn-ghost">Button</span>' },
      { id: 'btn-icon', icon: 'âŠ¡', label: 'Icon Button', hint: 'compact', html: '<span class="c-btn-icon">âš™</span>' },
      { id: 'btn-start', icon: 'â–¶', label: 'START Button', hint: 'go', html: '<span class="c-btn-primary">START</span>' },
      { id: 'btn-end', icon: 'â¹', label: 'END Button', hint: 'stop', html: '<span class="c-btn-outline">END SESSION</span>' },
    ],
  },
  {
    section: 'INPUTS',
    icon: 'â–­',
    items: [
      { id: 'inp-text', icon: 'â–­', label: 'Text Input', hint: 'type', html: '<span class="c-input">Enter text...</span>' },
      { id: 'inp-search', icon: 'ğŸ”', label: 'Search Input', hint: 'filter', html: '<span class="c-input">ğŸ” Search...</span>' },
      { id: 'inp-select', icon: 'â–¾', label: 'Dropdown', hint: 'pick', html: '<span class="c-select">Select option â–¾</span>' },
      { id: 'inp-textarea', icon: 'â–¤', label: 'Text Area', hint: 'multi', html: '<span class="c-textarea">Multi-line input...</span>' },
      { id: 'inp-topic', icon: 'âœ', label: 'Topic Input', hint: 'tutor', html: '<span class="c-input">Topic...</span>' },
    ],
  },
  {
    section: 'CHIPS & BADGES',
    icon: 'â—‰',
    items: [
      { id: 'chip-course', icon: 'â—‰', label: 'Course Chip', hint: 'toggle', html: '<span class="c-chip">EBP</span>' },
      { id: 'chip-active', icon: 'â—‰', label: 'Active Chip', hint: 'on', html: '<span class="c-chip on">ACTIVE</span>' },
      { id: 'badge-default', icon: 'â—', label: 'Badge', hint: 'label', html: '<span class="c-badge">Core</span>' },
      { id: 'badge-live', icon: 'â—', label: 'Live Badge', hint: 'status', html: '<span class="c-badge green">LIVE</span>' },
      { id: 'badge-info', icon: 'â—', label: 'Info Badge', hint: 'info', html: '<span class="c-badge blue">INFO</span>' },
      { id: 'chip-session', icon: 'â±', label: 'Session Chip', hint: 'recent', html: '<span class="c-session"><span class="dot green"></span>Core<span style="opacity:0.5">5t</span></span>' },
    ],
  },
  {
    section: 'CONTROLS',
    icon: 'â˜°',
    items: [
      { id: 'ctrl-toggle', icon: 'â‡”', label: 'Toggle Group', hint: 'switch', html: '<span class="c-toggle-group"><span class="c-toggle-btn on">A</span><span class="c-toggle-btn">B</span></span>' },
      { id: 'ctrl-check', icon: 'â˜‘', label: 'Checkbox', hint: 'bool', html: '<span class="c-check"><span class="box"></span>Option</span>' },
      { id: 'ctrl-model', icon: 'ğŸ¤–', label: 'Model Toggle', hint: 'AI', html: '<span class="c-toggle-group"><span class="c-toggle-btn on">codex</span><span class="c-toggle-btn">OR</span></span>' },
      { id: 'ctrl-web', icon: 'ğŸŒ', label: 'Web Search', hint: 'toggle', html: '<span class="c-check"><span class="box"></span>Web</span>' },
      { id: 'ctrl-mode', icon: 'ğŸ¯', label: 'Mode Select', hint: 'tutor', html: '<span class="c-select">Mode: LEARN â–¾</span>' },
      { id: 'ctrl-chain', icon: 'ğŸ”—', label: 'Chain Select', hint: 'tutor', html: '<span class="c-select">Chain: First Exposure â–¾</span>' },
    ],
  },
  {
    section: 'TEXT & LABELS',
    icon: 'Aa',
    items: [
      { id: 'txt-header', icon: 'H', label: 'Section Header', hint: 'arcade', html: '<span class="c-label">HEADER</span>' },
      { id: 'txt-label', icon: 'L', label: 'Muted Label', hint: 'small', html: '<span class="c-label-muted">Label</span>' },
      { id: 'txt-body', icon: 'T', label: 'Body Text', hint: 'content', html: '<span class="c-text">Body text content</span>' },
      { id: 'txt-muted', icon: 't', label: 'Muted Text', hint: 'info', html: '<span class="c-text-muted">Muted text</span>' },
      { id: 'txt-icon', icon: 'âŠ›', label: 'Icon + Text', hint: 'meta', html: '<span class="c-icon-text">ğŸ’¬ 5 turns</span>' },
    ],
  },
  {
    section: 'TREE ITEMS',
    icon: 'ğŸŒ¿',
    items: [
      { id: 'tree-folder', icon: 'ğŸ“', label: 'Folder', hint: 'expand', html: '<div class="c-tree-folder"><span class="box"></span><span style="color:var(--muted);font-size:9px">â–¶</span><span style="color:var(--yellow)">ğŸ“</span>Folder Name</div>' },
      { id: 'tree-file', icon: 'ğŸ“„', label: 'File', hint: 'leaf', html: '<div class="c-tree-file"><span class="box"></span><span style="color:var(--blue)">ğŸ“„</span>File.md</div>' },
      { id: 'tree-folder-open', icon: 'ğŸ“‚', label: 'Open Folder', hint: 'exp', html: '<div class="c-tree-folder"><span class="box"></span><span style="color:var(--muted);font-size:9px">â–¼</span><span style="color:var(--yellow)">ğŸ“‚</span>Open Folder</div>' },
    ],
  },
  {
    section: 'DATA DISPLAY',
    icon: 'ğŸ“Š',
    items: [
      { id: 'data-stat', icon: 'ğŸ“Š', label: 'Stat Block', hint: 'number', html: '<span class="c-stat"><span class="val">42</span><span class="lbl">TURNS</span></span>' },
      { id: 'data-progress', icon: 'â”', label: 'Progress Bar', hint: 'bar', html: '<div class="c-progress"><div class="fill"></div></div>' },
      { id: 'data-divider', icon: 'â”€', label: 'Divider', hint: 'line', html: '<span class="c-divider"></span>' },
      { id: 'data-divider-thick', icon: 'â”', label: 'Thick Divider', hint: 'bold', html: '<span class="c-divider-thick"></span>' },
    ],
  },
  {
    section: 'CHAT',
    icon: 'ğŸ’¬',
    items: [
      { id: 'chat-user', icon: 'ğŸ‘¤', label: 'User Message', hint: 'right', html: '<div class="c-chat-user">What is the brachial plexus?</div>' },
      { id: 'chat-ai', icon: 'ğŸ¤–', label: 'AI Response', hint: 'left', html: '<div class="c-chat-ai">The brachial plexus is a network of nerves...</div>' },
      { id: 'chat-input', icon: 'âœ', label: 'Chat Input', hint: 'send', html: '<div style="display:flex;gap:4px;width:100%"><span class="c-input" style="flex:1">Type your message...</span><span class="c-btn-primary">SEND</span></div>' },
    ],
  },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WINDOW TEMPLATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getWindowTemplate(template) {
  switch (template) {
    case 'card': return { title: 'PANEL', w: 300, h: 200, zones: [{ id: 'main', dir: 'v', items: [] }] };
    case 'vault': return {
      title: 'VAULT FILES', w: 500, h: 380,
      zones: [
        { id: 'chips', dir: 'h', items: [
          { html: '<span class="c-chip on">EBP</span>' },
          { html: '<span class="c-chip">ExPhys</span>' },
          { html: '<span class="c-chip">MS1</span>' },
          { html: '<span class="c-chip">Neuro</span>' },
          { html: '<span class="c-chip">TI</span>' },
          { html: '<span class="c-input">ğŸ” Filter...</span>' },
        ]},
        { id: 'tree', dir: 'v', items: [
          { html: '<div class="c-tree-folder"><span class="box"></span><span style="color:var(--muted);font-size:9px">â–¼</span><span style="color:var(--yellow)">ğŸ“‚</span>Evidence Based Practice</div>' },
          { html: '<div class="c-tree-file"><span class="box"></span><span style="color:var(--blue)">ğŸ“„</span>Week 1 - Intro to EBP.md</div>' },
          { html: '<div class="c-tree-file"><span class="box"></span><span style="color:var(--blue)">ğŸ“„</span>Week 2 - PICO Framework.md</div>' },
          { html: '<div class="c-tree-file"><span class="box"></span><span style="color:var(--blue)">ğŸ“„</span>Week 3 - Study Designs.md</div>' },
          { html: '<div class="c-tree-folder"><span class="box"></span><span style="color:var(--muted);font-size:9px">â–¶</span><span style="color:var(--yellow)">ğŸ“</span>Exercise Physiology</div>' },
          { html: '<div class="c-tree-folder"><span class="box"></span><span style="color:var(--muted);font-size:9px">â–¶</span><span style="color:var(--yellow)">ğŸ“</span>Movement Science 1</div>' },
          { html: '<div class="c-tree-folder"><span class="box"></span><span style="color:var(--muted);font-size:9px">â–¼</span><span style="color:var(--yellow)">ğŸ“‚</span>Neuroscience</div>' },
          { html: '<div class="c-tree-file"><span class="box"></span><span style="color:var(--blue)">ğŸ“„</span>Cranial Nerves.md</div>' },
          { html: '<div class="c-tree-file"><span class="box"></span><span style="color:var(--blue)">ğŸ“„</span>Spinal Cord Anatomy.md</div>' },
          { html: '<div class="c-tree-folder"><span class="box"></span><span style="color:var(--muted);font-size:9px">â–¶</span><span style="color:var(--yellow)">ğŸ“</span>Therapeutic Intervention</div>' },
        ]},
        { id: 'footer', dir: 'h', items: [
          { html: '<span class="c-text-muted">3 folders, 2 files</span>' },
          { html: '<span class="c-btn-ghost">âœ• CLEAR</span>' },
        ]},
      ],
    };
    case 'toolbar': return {
      title: 'TOOLBAR', w: 600, h: 44,
      zones: [{ id: 'controls', dir: 'h', items: [
        { html: '<span class="c-select">Mode: LEARN â–¾</span>' },
        { html: '<span class="c-select">Chain: First Exposure â–¾</span>' },
        { html: '<span class="c-input">Topic...</span>' },
        { html: '<span class="c-toggle-group"><span class="c-toggle-btn on">codex</span><span class="c-toggle-btn">OR</span></span>' },
        { html: '<span class="c-check"><span class="box"></span>Web</span>' },
        { html: '<span class="c-btn-primary">START</span>' },
      ]}],
    };
    case 'chat': return {
      title: 'CHAT', w: 450, h: 350,
      zones: [
        { id: 'messages', dir: 'v', items: [
          { html: '<div class="c-chat-user">What muscles make up the rotator cuff?</div>' },
          { html: '<div class="c-chat-ai">The rotator cuff is composed of four muscles: supraspinatus, infraspinatus, teres minor, and subscapularis (SITS).</div>' },
        ]},
        { id: 'input', dir: 'h', items: [
          { html: '<span class="c-input" style="flex:1">Type your message...</span>' },
          { html: '<span class="c-btn-primary">SEND</span>' },
        ]},
      ],
    };
    case 'artifacts': return {
      title: 'ARTIFACTS', w: 260, h: 300,
      zones: [
        { id: 'header', dir: 'h', items: [
          { html: '<span class="c-label">ARTIFACTS</span>' },
          { html: '<span class="c-badge">3</span>' },
        ]},
        { id: 'list', dir: 'v', items: [
          { html: '<div style="padding:4px 8px;border:1px solid var(--primary-dim);width:100%"><span class="c-badge blue">CARD</span> <span class="c-text" style="margin-left:4px">Brachial Plexus</span></div>' },
          { html: '<div style="padding:4px 8px;border:1px solid rgba(255,255,255,0.06);width:100%"><span class="c-badge">NOTE</span> <span class="c-text" style="margin-left:4px">Muscle Origins</span></div>' },
          { html: '<div style="padding:4px 8px;border:1px solid rgba(255,255,255,0.06);width:100%"><span class="c-badge green">MAP</span> <span class="c-text" style="margin-left:4px">Spinal Nerves</span></div>' },
        ]},
      ],
    };
    case 'stats': return {
      title: 'STATS', w: 320, h: 100,
      zones: [{ id: 'stats', dir: 'h', items: [
        { html: '<span class="c-stat"><span class="val">12</span><span class="lbl">TURNS</span></span>' },
        { html: '<span class="c-stat"><span class="val">3</span><span class="lbl">CARDS</span></span>' },
        { html: '<span class="c-stat"><span class="val">45m</span><span class="lbl">TIME</span></span>' },
        { html: '<span class="c-stat"><span class="val">85%</span><span class="lbl">SCORE</span></span>' },
      ]}],
    };
    case 'sessions': return {
      title: 'RECENT SESSIONS', w: 500, h: 36,
      zones: [{ id: 'chips', dir: 'h', items: [
        { html: '<span class="c-label-muted">RECENT:</span>' },
        { html: '<span class="c-session"><span class="dot green"></span>Core<span style="opacity:0.5">5t</span></span>' },
        { html: '<span class="c-session"><span class="dot gray"></span>EBP Sprint<span style="opacity:0.5">3t</span></span>' },
        { html: '<span class="c-session"><span class="dot gray"></span>Neuro Fix<span style="opacity:0.5">8t</span></span>' },
        { html: '<span class="c-session"><span class="dot gray"></span>MS1 Review<span style="opacity:0.5">2t</span></span>' },
      ]}],
    };
    case 'settings': return {
      title: 'SETTINGS', w: 280, h: 240,
      zones: [{ id: 'options', dir: 'v', items: [
        { html: '<span class="c-label">MODE</span>' },
        { html: '<span class="c-select" style="width:100%">Core â–¾</span>' },
        { html: '<span class="c-label">CHAIN</span>' },
        { html: '<span class="c-select" style="width:100%">First Exposure (Core) â–¾</span>' },
        { html: '<span class="c-label">MODEL</span>' },
        { html: '<span class="c-toggle-group"><span class="c-toggle-btn on">codex</span><span class="c-toggle-btn">OR</span></span>' },
        { html: '<span class="c-divider"></span>' },
        { html: '<span class="c-check"><span class="box"></span>Web Search</span>' },
        { html: '<span class="c-btn-primary" style="width:100%;text-align:center">START SESSION</span>' },
      ]}],
    };
    default: return { title: 'PANEL', w: 300, h: 200, zones: [{ id: 'main', dir: 'v', items: [] }] };
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER PALETTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPalette() {
  const container = document.getElementById('paletteScroll');
  container.innerHTML = '';

  COMPONENT_LIB.forEach((section, si) => {
    const sec = document.createElement('div');
    sec.className = 'pal-section';

    const header = document.createElement('div');
    header.className = 'pal-section-header';
    header.innerHTML = `<span>${section.section}</span><span class="arrow open">â–¶</span>`;
    header.onclick = () => {
      const body = sec.querySelector('.pal-section-body');
      const arrow = header.querySelector('.arrow');
      body.classList.toggle('closed');
      arrow.classList.toggle('open');
    };
    sec.appendChild(header);

    const body = document.createElement('div');
    body.className = 'pal-section-body';

    section.items.forEach(item => {
      const el = document.createElement('div');
      el.className = 'pal-item';
      el.dataset.componentId = item.id;
      el.dataset.template = item.template || '';
      el.dataset.html = item.html || '';
      el.innerHTML = `<span class="icon">${item.icon}</span><span class="label">${item.label}</span><span class="hint">${item.hint}</span>`;

      el.addEventListener('mousedown', startPaletteDrag);
      body.appendChild(el);
    });

    sec.appendChild(body);
    container.appendChild(sec);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PALETTE DRAG â†’ CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startPaletteDrag(e) {
  const item = e.currentTarget;
  const template = item.dataset.template;
  const html = item.dataset.html;
  const compId = item.dataset.componentId;

  paletteDrag = { compId, template, html, startX: e.clientX, startY: e.clientY, active: false };

  // Clone for ghost
  ghost.innerHTML = item.innerHTML;
  ghost.style.display = 'flex';
  ghost.style.alignItems = 'center';
  ghost.style.gap = '6px';
  ghost.style.padding = '6px 10px';
  ghost.style.background = 'rgba(239,68,68,0.15)';
  ghost.style.border = '1px solid var(--primary)';
  ghost.style.fontSize = '11px';
  ghost.style.left = e.clientX + 8 + 'px';
  ghost.style.top = e.clientY + 8 + 'px';

  e.preventDefault();
}

document.addEventListener('mousemove', (e) => {
  // Palette drag
  if (paletteDrag) {
    ghost.style.left = e.clientX + 8 + 'px';
    ghost.style.top = e.clientY + 8 + 'px';

    const dx = e.clientX - paletteDrag.startX;
    const dy = e.clientY - paletteDrag.startY;
    if (!paletteDrag.active && (Math.abs(dx) > 5 || Math.abs(dy) > 5)) {
      paletteDrag.active = true;
      canvas.classList.add('drop-active');
    }

    // Highlight drop target panel
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('drop-target'));
    document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('highlight'));
    const target = document.elementFromPoint(e.clientX, e.clientY);
    if (target) {
      const zone = target.closest('.drop-zone');
      if (zone) zone.classList.add('highlight');
      else {
        const panel = target.closest('.panel');
        if (panel) panel.classList.add('drop-target');
      }
    }
    return;
  }

  // Panel drag/resize
  if (dragState) {
    const dx = e.clientX - dragState.startX;
    const dy = e.clientY - dragState.startY;
    const el = panels[dragState.panelId].el;
    const sr = dragState.startRect;

    if (dragState.type === 'move') {
      el.style.left = snapV(sr.x + dx) + 'px';
      el.style.top = snapV(sr.y + dy) + 'px';
    } else {
      let nx = sr.x, ny = sr.y, nw = sr.w, nh = sr.h;
      const d = dragState.dir;
      if (d.includes('e')) nw = Math.max(120, sr.w + dx);
      if (d.includes('w')) { nw = Math.max(120, sr.w - dx); nx = sr.x + sr.w - nw; }
      if (d.includes('s')) nh = Math.max(36, sr.h + dy);
      if (d.includes('n')) { nh = Math.max(36, sr.h - dy); ny = sr.y + sr.h - nh; }
      el.style.left = snapV(nx) + 'px';
      el.style.top = snapV(ny) + 'px';
      el.style.width = snapV(nw) + 'px';
      el.style.height = snapV(nh) + 'px';
    }
    updateDims(dragState.panelId);
    updateInfoBar(dragState.panelId);
    return;
  }

  // Item reorder
  if (itemDragState) {
    const dx = e.clientX - itemDragState.startX;
    const dy = e.clientY - itemDragState.startY;
    if (!itemDragState.moved && (Math.abs(dx) > 4 || Math.abs(dy) > 4)) {
      itemDragState.moved = true;
      itemDragState.el.classList.add('dragging-item');
    }
    if (itemDragState.moved) {
      document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('highlight'));
      const target = document.elementFromPoint(e.clientX, e.clientY);
      const targetZone = target?.closest('.drop-zone');
      if (targetZone) {
        targetZone.classList.add('highlight');
        // Reorder within zone
        const items = [...targetZone.querySelectorAll(':scope > .drag-item')];
        const dragged = itemDragState.el;
        for (const item of items) {
          if (item === dragged) continue;
          const rect = item.getBoundingClientRect();
          const isVert = targetZone.classList.contains('vertical');
          const mid = isVert ? rect.top + rect.height / 2 : rect.left + rect.width / 2;
          const pos = isVert ? e.clientY : e.clientX;
          if (pos < mid) { targetZone.insertBefore(dragged, item); break; }
          else if (item === items[items.length - 1]) targetZone.appendChild(dragged);
        }
      }
    }
  }
});

document.addEventListener('mouseup', (e) => {
  // Palette drop
  if (paletteDrag && paletteDrag.active) {
    ghost.style.display = 'none';
    canvas.classList.remove('drop-active');
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('drop-target'));
    document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('highlight'));

    const cr = canvas.getBoundingClientRect();
    const dropX = e.clientX - cr.left;
    const dropY = e.clientY - cr.top;

    // Dropping on a zone = add component to it
    const target = document.elementFromPoint(e.clientX, e.clientY);
    const targetZone = target?.closest('.drop-zone');

    if (targetZone && paletteDrag.html) {
      // Add item to existing zone
      const itemEl = document.createElement('div');
      itemEl.className = 'drag-item';
      itemEl.innerHTML = paletteDrag.html;
      targetZone.appendChild(itemEl);
    } else if (paletteDrag.template) {
      // Create new window panel
      createPanel(paletteDrag.template, snapV(dropX), snapV(dropY));
    } else if (paletteDrag.html) {
      // Create a tiny card with the item
      const pid = createPanel('card', snapV(dropX), snapV(dropY));
      const zone = panels[pid].el.querySelector('.drop-zone');
      if (zone) {
        const itemEl = document.createElement('div');
        itemEl.className = 'drag-item';
        itemEl.innerHTML = paletteDrag.html;
        zone.appendChild(itemEl);
      }
    }

    paletteDrag = null;
    return;
  }
  if (paletteDrag) {
    ghost.style.display = 'none';
    paletteDrag = null;
    return;
  }

  // Panel drag/resize end
  if (dragState) {
    panels[dragState.panelId].el.classList.remove('dragging');
    dragState = null;
    updatePrompt();
  }

  // Item reorder end
  if (itemDragState) {
    itemDragState.el.classList.remove('dragging-item');
    if (itemDragState.moved) {
      const target = document.elementFromPoint(e.clientX, e.clientY);
      const targetZone = target?.closest('.drop-zone');
      if (targetZone && targetZone !== itemDragState.zone) {
        targetZone.appendChild(itemDragState.el);
      }
      document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('highlight'));
      updatePrompt();
    }
    itemDragState = null;
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CREATE PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function createPanel(template, x, y) {
  const tmpl = getWindowTemplate(template);
  const id = 'p' + (++panelCounter);

  const el = document.createElement('div');
  el.className = 'panel';
  el.id = id;
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  el.style.width = tmpl.w + 'px';
  el.style.height = tmpl.h + 'px';

  // Resize handles
  ['n','s','e','w','ne','nw','se','sw'].forEach(d => {
    const h = document.createElement('div');
    h.className = `rh ${d}`;
    h.dataset.dir = d;
    el.appendChild(h);
  });

  // Header
  const header = document.createElement('div');
  header.className = 'panel-header';
  header.innerHTML = `<span class="title">${tmpl.title}</span><span class="dims">${tmpl.w}Ã—${tmpl.h}</span><button class="close-btn" onclick="removePanel('${id}')" title="Delete">âœ•</button>`;
  el.appendChild(header);

  // Body
  const body = document.createElement('div');
  body.className = 'panel-body';

  tmpl.zones.forEach(zone => {
    const zoneEl = document.createElement('div');
    zoneEl.className = `drop-zone ${zone.dir === 'v' ? 'vertical' : ''}`;
    zoneEl.dataset.zoneId = `${id}-${zone.id}`;

    zone.items.forEach(item => {
      const itemEl = document.createElement('div');
      itemEl.className = 'drag-item';
      if (item.html) itemEl.innerHTML = item.html;
      zoneEl.appendChild(itemEl);
    });

    body.appendChild(zoneEl);
  });

  el.appendChild(body);
  canvas.appendChild(el);

  panels[id] = { el, template, title: tmpl.title };
  selectPanel(id);
  updateDims(id);
  return id;
}

function removePanel(id) {
  if (panels[id]) {
    panels[id].el.remove();
    delete panels[id];
    if (selectedPanelId === id) selectPanel(null);
  }
}

function deleteSelected() {
  if (selectedPanelId) removePanel(selectedPanelId);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANVAS MOUSE HANDLERS (move/resize/select)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
canvas.addEventListener('mousedown', (e) => {
  if (paletteDrag) return;

  const handle = e.target.closest('.rh');
  if (handle) {
    const panel = handle.closest('.panel');
    const id = panel.id;
    selectPanel(id);
    dragState = {
      type: 'resize', panelId: id,
      startX: e.clientX, startY: e.clientY,
      startRect: { x: parseInt(panel.style.left), y: parseInt(panel.style.top), w: parseInt(panel.style.width), h: parseInt(panel.style.height) },
      dir: handle.dataset.dir,
    };
    panel.classList.add('dragging');
    e.preventDefault();
    return;
  }

  const header = e.target.closest('.panel-header');
  if (header && !e.target.closest('.close-btn')) {
    const panel = header.closest('.panel');
    const id = panel.id;
    selectPanel(id);
    dragState = {
      type: 'move', panelId: id,
      startX: e.clientX, startY: e.clientY,
      startRect: { x: parseInt(panel.style.left), y: parseInt(panel.style.top), w: parseInt(panel.style.width), h: parseInt(panel.style.height) },
    };
    panel.classList.add('dragging');
    e.preventDefault();
    return;
  }

  const dragItem = e.target.closest('.drag-item');
  if (dragItem) {
    const zone = dragItem.closest('.drop-zone');
    if (zone) {
      const panel = zone.closest('.panel');
      if (panel) selectPanel(panel.id);
      itemDragState = { el: dragItem, zone, startX: e.clientX, startY: e.clientY, moved: false };
      e.preventDefault();
      return;
    }
  }

  const panel = e.target.closest('.panel');
  if (panel) selectPanel(panel.id);
  else selectPanel(null);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SELECTION + INFO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectPanel(id) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('selected'));
  selectedPanelId = id;
  if (id && panels[id]) {
    panels[id].el.classList.add('selected');
    updateInfoBar(id);
  } else {
    document.getElementById('infoSelected').textContent = 'none';
    document.getElementById('infoPos').textContent = '--';
    document.getElementById('infoSize').textContent = '--';
  }
}

function updateDims(id) {
  const el = panels[id].el;
  const dims = el.querySelector('.dims');
  if (dims) dims.textContent = `${parseInt(el.style.width)}Ã—${parseInt(el.style.height)}`;
}

function updateInfoBar(id) {
  const el = panels[id].el;
  const x = parseInt(el.style.left), y = parseInt(el.style.top);
  const w = parseInt(el.style.width), h = parseInt(el.style.height);
  const cr = canvas.getBoundingClientRect();
  document.getElementById('infoSelected').textContent = panels[id].title;
  document.getElementById('infoPos').textContent = `${x},${y}`;
  document.getElementById('infoSize').textContent = `${w}Ã—${h} (${((w/cr.width)*100).toFixed(0)}%Ã—${((h/cr.height)*100).toFixed(0)}%)`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRESETS / PAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function clearCanvas() {
  Object.keys(panels).forEach(id => { panels[id].el.remove(); });
  panels = {};
  selectedPanelId = null;
  panelCounter = 0;
}

function loadPage(name) {
  clearCanvas();
  const c = canvas.getBoundingClientRect();
  const pad = 16;
  const iw = c.width - pad * 2;

  if (name === 'tutor-setup') {
    createPanel('vault', pad, pad);
    // Stretch vault to fill
    const vEl = panels[Object.keys(panels)[0]].el;
    vEl.style.width = iw + 'px';
    vEl.style.height = Math.floor(c.height * 0.76) + 'px';
    updateDims(Object.keys(panels)[0]);

    const toolY = pad + Math.floor(c.height * 0.76) + 8;
    createPanel('toolbar', pad, toolY);
    const tEl = panels[Object.keys(panels)[1]].el;
    tEl.style.width = iw + 'px';
    updateDims(Object.keys(panels)[1]);

    createPanel('sessions', pad, toolY + 56);
    const sEl = panels[Object.keys(panels)[2]].el;
    sEl.style.width = iw + 'px';
    updateDims(Object.keys(panels)[2]);

    selectPanel(null);
  } else if (name === 'tutor-chat') {
    // Status bar
    createPanel('toolbar', pad, pad);
    const barEl = panels[Object.keys(panels)[0]].el;
    barEl.style.width = iw + 'px';
    barEl.style.height = '36px';
    barEl.querySelector('.title').textContent = 'STATUS BAR';
    updateDims(Object.keys(panels)[0]);

    // Chat
    createPanel('chat', pad, pad + 48);
    const chatEl = panels[Object.keys(panels)[1]].el;
    chatEl.style.width = Math.floor(iw * 0.7) + 'px';
    chatEl.style.height = (c.height - pad * 2 - 56) + 'px';
    updateDims(Object.keys(panels)[1]);

    // Artifacts
    createPanel('artifacts', pad + Math.floor(iw * 0.7) + 8, pad + 48);
    const artEl = panels[Object.keys(panels)[2]].el;
    artEl.style.width = (iw - Math.floor(iw * 0.7) - 8) + 'px';
    artEl.style.height = (c.height - pad * 2 - 56) + 'px';
    updateDims(Object.keys(panels)[2]);

    selectPanel(null);
  } else {
    // Blank
  }
}

function toggleSnap() {
  snap = !snap;
  const btn = document.getElementById('snapBtn');
  btn.textContent = `SNAP: ${snap ? 'ON' : 'OFF'}`;
  btn.classList.toggle('active', snap);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROMPT GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updatePrompt() {
  const c = canvas.getBoundingClientRect();
  const parts = [];
  parts.push('Update the page layout with these specifications:\n');

  const sorted = Object.entries(panels).sort((a,b) => {
    const ay = parseInt(a[1].el.style.top), by = parseInt(b[1].el.style.top);
    return ay - by || parseInt(a[1].el.style.left) - parseInt(b[1].el.style.left);
  });

  sorted.forEach(([id, p]) => {
    const el = p.el;
    const x = parseInt(el.style.left), y = parseInt(el.style.top);
    const w = parseInt(el.style.width), h = parseInt(el.style.height);
    const pW = ((w/c.width)*100).toFixed(0);
    const pH = ((h/c.height)*100).toFixed(0);

    parts.push(`${p.title}:`);
    parts.push(`  Position: (${x}, ${y})  Size: ${w}Ã—${h}px (${pW}%Ã—${pH}%)`);

    // List zone contents
    const zones = el.querySelectorAll('.drop-zone');
    zones.forEach(zone => {
      const items = [...zone.querySelectorAll(':scope > .drag-item')];
      if (items.length > 0) {
        const names = items.map(i => i.textContent.trim().replace(/\s+/g, ' ')).filter(Boolean);
        if (names.length) parts.push(`  Contents: ${names.join(' | ')}`);
      }
    });
    parts.push('');
  });

  document.getElementById('promptText').textContent = parts.join('\n');
}

function copyPrompt() {
  updatePrompt();
  const text = document.getElementById('promptText').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.querySelector('.tb-copy');
    const orig = btn.textContent;
    btn.textContent = 'COPIED!';
    btn.style.background = '#4ade80';
    setTimeout(() => { btn.textContent = orig; btn.style.background = ''; }, 1200);
  });
  document.getElementById('promptBar').classList.add('visible');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', (e) => {
  if (e.key === 'Delete' || e.key === 'Backspace') {
    if (selectedPanelId && !e.target.closest('input,textarea')) {
      removePanel(selectedPanelId);
    }
  }
  if (e.key === 'Escape') selectPanel(null);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  renderPalette();

  const updateCanvasInfo = () => {
    const r = canvas.getBoundingClientRect();
    document.getElementById('infoCanvas').textContent = `${Math.round(r.width)}Ã—${Math.round(r.height)}`;
  };
  updateCanvasInfo();
  window.addEventListener('resize', updateCanvasInfo);

  // Load tutor setup by default
  loadPage('tutor-setup');
}

init();
</script>
</body>
</html>
