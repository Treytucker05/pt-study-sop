import{c as V,j as e,r as o,d as fe,X as je}from"./index-MTSsqH2c.js";import{u as W,p as $,S as ge,B as G,n as ye,o as Se,m as Ce,L as ke}from"./layout-BLlWneDI.js";import{B as T,C as se}from"./badge-BjqRhIi3.js";import{I as w,T as E,a as U,b as Q,P as Z,c as ve,S as _e,d as ce,e as le,M as we,B as Ee,f as ae,g as ne,h as $e,t as _}from"./MaterialUploader-DP8nCIGM.js";import{C as ee}from"./checkbox-BV738j4x.js";import{L as ie}from"./loader-circle-DMqA0QKs.js";import{F as te}from"./file-text-lGV-diJi.js";import{D as Te,M as Ae,r as Oe,F as De}from"./index-3YIGKFbI.js";import{L as Le}from"./link-CaRuecLf.js";import{Z as Me}from"./zap-DiEYBrNQ.js";import{C as Pe}from"./index-B1OSQtUe.js";import{S as Re}from"./send-BQwxBx4B.js";import{M as de}from"./message-square-DyKl2v-1.js";import{C as ue}from"./clock-BSQe0_NZ.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=[["path",{d:"M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z",key:"p7xjir"}]],Fe=V("cloud",Ie);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=[["rect",{width:"20",height:"14",x:"2",y:"5",rx:"2",key:"ynyp8z"}],["line",{x1:"2",x2:"22",y1:"10",y2:"10",key:"1b3vmo"}]],Ne=V("credit-card",qe);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=[["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M17 20v2",key:"1rnc9c"}],["path",{d:"M17 2v2",key:"11trls"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M2 17h2",key:"7oei6x"}],["path",{d:"M2 7h2",key:"asdhe0"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"M20 17h2",key:"1fpfkl"}],["path",{d:"M20 7h2",key:"1o8tra"}],["path",{d:"M7 20v2",key:"4gnj0m"}],["path",{d:"M7 2v2",key:"1i4yhu"}],["rect",{x:"4",y:"4",width:"16",height:"16",rx:"2",key:"1vbyd7"}],["rect",{x:"8",y:"8",width:"8",height:"8",rx:"1",key:"z9xiuo"}]],Ke=V("cpu",Ue);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]],Qe=V("globe",Ge);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ze=[["path",{d:"M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z",key:"169xi5"}],["path",{d:"M15 5.764v15",key:"1pn4in"}],["path",{d:"M9 3.236v15",key:"1uimfh"}]],be=V("map",ze);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xe=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]],Be=V("square",Xe),Ye={pdf:"PDF",docx:"DOC",pptx:"PPT",md:"MD",txt:"TXT"};function Ve({courseId:d,selectedMaterials:i,setSelectedMaterials:S}){const{data:h=[],isLoading:m}=W({queryKey:["tutor-materials",d],queryFn:()=>$.tutor.getMaterials(d?{course_id:d}:void 0)}),A=c=>{S(i.includes(c)?i.filter(M=>M!==c):[...i,c])},N=()=>{i.length===h.length?S([]):S(h.map(c=>c.id))};return m?e.jsx("div",{className:"flex items-center justify-center py-3",children:e.jsx(ie,{className:`${w} animate-spin text-muted-foreground`})}):h.length===0?e.jsx("div",{className:`${E} text-center py-2`,children:"No materials uploaded yet"}):e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:`flex items-center gap-1.5 px-1 py-0.5 ${U} text-muted-foreground hover:text-foreground cursor-pointer border-b border-muted-foreground/10 pb-1`,children:[e.jsx(ee,{checked:h.length>0&&i.length===h.length,onCheckedChange:N,className:"w-3 h-3"}),e.jsx("span",{children:"Select all"}),e.jsxs(T,{variant:"outline",className:`ml-auto ${Q} h-4 px-1`,children:[i.length,"/",h.length]})]}),h.map(c=>e.jsxs("label",{className:`flex items-center gap-1.5 px-1 py-0.5 ${U} text-muted-foreground hover:text-foreground cursor-pointer`,children:[e.jsx(ee,{checked:i.includes(c.id),onCheckedChange:()=>A(c.id),className:"w-3 h-3"}),e.jsx(te,{className:`${w} text-primary/60 shrink-0`}),e.jsx("span",{className:"truncate flex-1",children:c.title}),e.jsx(T,{variant:"outline",className:`${Q} h-4 px-1 shrink-0`,children:Ye[c.file_type]||c.file_type.toUpperCase()})]},c.id))]})}const J=[{value:"arcee-ai/trinity-large-preview:free",label:"Trinity Large (free)"},{value:"qwen/qwen3-coder-next",label:"Qwen3 Coder Next"},{value:"google/gemini-2.5-flash-lite",label:"Gemini 2.5 Flash Lite"}],He=[{value:"Core",label:"LEARN",desc:"Prime + encode"},{value:"Sprint",label:"REVIEW",desc:"Retrieve + refine"},{value:"Quick Sprint",label:"QUICK",desc:"Quick retrieval"},{value:"Light",label:"LIGHT",desc:"Low energy"},{value:"Drill",label:"FIX",desc:"Target weak spots"}],We=["Teaching Sprint","Diagnostic Sprint"],me={Core:"First Exposure (Core)",Sprint:"Review Sprint","Quick Sprint":"Quick Drill",Light:"Low Energy",Drill:"Mastery Review","Teaching Sprint":"First Exposure (Core)","Diagnostic Sprint":"Review Sprint"},xe="tutor.autopick_chain.v1",pe="tutor.last_openrouter_model.v1",he="tutor.last_codex_model.v1";function oe(d){try{return localStorage.getItem(d)}catch{return null}}function re(d,i){try{localStorage.setItem(d,i)}catch{}}function Ze(d,i){const S=oe(d);return S===null?i:S==="true"}function B({children:d,icon:i}){return e.jsxs("div",{className:`${ne} flex items-center gap-1.5 pb-1 border-b border-primary/20 mb-2`,children:[i,d]})}function Je({courseId:d,setCourseId:i,selectedMaterials:S,setSelectedMaterials:h,mode:m,setMode:A,chainId:N,setChainId:c,topic:M,setTopic:b,model:u,setModel:p,webSearch:O,setWebSearch:I,onStartSession:D,isStarting:r,hasActiveSession:l}){const{data:f,isError:n}=W({queryKey:["tutor-content-sources"],queryFn:()=>$.tutor.getContentSources()}),{data:g=[],isError:x}=W({queryKey:["tutor-template-chains"],queryFn:()=>$.tutor.getTemplateChains()}),{data:F=[]}=W({queryKey:["courses-active"],queryFn:()=>$.courses.getActive()}),C=f?.openrouter_enabled??!1,j=u.includes("/")?"openrouter":"codex";o.useEffect(()=>{!C&&j==="openrouter"&&p("codex")},[C,j,p]),o.useEffect(()=>{u&&(u.includes("/")?re(pe,u):re(he,u))},[u]);const[v,z]=o.useState(()=>Ze(xe,!0)),[P,K]=o.useState(null);o.useEffect(()=>{re(xe,String(v))},[v]);const R=me[m],k=o.useMemo(()=>{if(R)return g.find(t=>t.name===R)},[g,R]);o.useEffect(()=>{v&&N===void 0&&k&&P!==m&&(c(k.id),K(m))},[v,N,k?.id,P,m,c]);const q=t=>{if(A(t),!v||N!==void 0)return;const y=me[t];if(!y)return;const a=g.find(s=>s.name===y);a&&(c(a.id),K(t))},Y=()=>{const t=oe(he),y=t&&!t.includes("/")?t:"codex";p(y)},X=()=>{if(!C)return;const t=oe(pe),y=t&&t.includes("/")?t:J[0].value;p(y)};return o.useEffect(()=>{j==="openrouter"&&(J.some(t=>t.value===u)||p(J[0].value))},[j,u,p]),e.jsxs("div",{className:"flex flex-col h-full overflow-hidden",children:[e.jsxs("div",{className:`shrink-0 ${Z} pb-2 border-b-2 border-primary/30`,children:[e.jsx("div",{className:ve,children:"CONTENT FILTER"}),(n||x)&&e.jsxs("div",{className:`${E} text-red-400`,children:["Tutor API unavailable. Start the dashboard via ",e.jsx("span",{className:"font-arcade",children:"Start_Dashboard.bat"}),"."]}),e.jsxs("div",{className:`flex items-center gap-2 mt-1 ${E}`,children:[e.jsx(Te,{className:w}),f?.total_materials??0," materials",e.jsx("span",{className:"text-muted-foreground/40",children:"|"}),f?.total_instructions??0," SOP"]})]}),e.jsx(ge,{className:"flex-1 min-h-0",children:e.jsxs("div",{className:`${Z} ${_e}`,children:[e.jsxs("div",{children:[e.jsx(B,{children:"Mode"}),e.jsx("div",{className:"grid grid-cols-2 gap-1",children:He.map(t=>e.jsxs("button",{onClick:()=>q(t.value),className:`text-left px-2 py-1 border-2 transition-colors ${m===t.value?"border-primary bg-primary/20 text-primary":"border-muted-foreground/30 text-foreground/80 hover:border-muted-foreground/50 hover:text-foreground hover:bg-black/30"}`,children:[e.jsx("div",{className:"font-arcade text-xs leading-tight truncate",children:t.label}),e.jsx("div",{className:`${E} leading-tight truncate`,children:t.desc})]},t.value))}),e.jsx("div",{className:`${E} mt-1`,children:"Auto-picks a chain template. Override below."}),We.includes(m)&&e.jsxs("div",{className:`${E} mt-1`,children:["Legacy mode active: ",m]})]}),e.jsxs("div",{children:[e.jsx(B,{icon:e.jsx(Le,{className:w}),children:"Chain"}),e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-1",children:[e.jsxs("div",{className:`${E} min-w-0`,children:[e.jsx("span",{className:"opacity-70",children:"Recommended:"})," ",k?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-foreground truncate",children:k.name}),e.jsx(T,{variant:"outline",className:`ml-1.5 ${Q} h-4 px-1`,children:k.blocks.length})]}):e.jsx("span",{className:"opacity-70",children:"—"})]}),k&&N!==k.id&&e.jsx(G,{size:"sm",variant:"outline",onClick:()=>c(k.id),className:"rounded-none h-7 px-2 font-arcade text-xs border-primary/50 hover:bg-primary/10",children:"APPLY"})]}),e.jsxs("label",{className:`flex items-center gap-2 ${U} text-muted-foreground mb-1 cursor-pointer`,children:[e.jsx(ee,{checked:v,onCheckedChange:t=>z(t===!0),className:"w-3 h-3"}),e.jsx("span",{className:"select-none",children:"Auto-pick recommended chain"})]}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("button",{onClick:()=>{c(void 0),K(m)},className:`w-full text-left px-2 py-0.5 ${U} border-l-2 transition-colors ${N?"border-transparent text-foreground/80 hover:text-foreground hover:border-muted-foreground/40 hover:bg-black/30":"border-primary text-primary bg-primary/10"}`,children:"Freeform"}),g.map(t=>e.jsxs("button",{onClick:()=>c(t.id),className:`w-full text-left px-2 py-0.5 ${U} border-l-2 transition-colors ${N===t.id?"border-primary text-primary bg-primary/10":"border-transparent text-foreground/80 hover:text-foreground hover:border-muted-foreground/40 hover:bg-black/30"}`,children:[e.jsx("span",{className:"truncate",children:t.name}),e.jsx(T,{variant:"outline",className:`ml-1.5 ${Q} h-4 px-1`,children:t.blocks.length})]},t.id))]})]}),e.jsxs("div",{children:[e.jsx(B,{children:"Topic"}),e.jsx("input",{value:M,onChange:t=>b(t.target.value),placeholder:"e.g. Hip Flexors",className:ce})]}),e.jsxs("div",{children:[e.jsx(B,{children:"Model"}),e.jsxs("div",{className:"grid grid-cols-2 gap-1 mb-1",children:[e.jsxs("button",{onClick:Y,className:`text-left px-2 py-1 border-2 transition-colors ${j==="codex"?"border-primary bg-primary/20 text-primary":"border-muted-foreground/30 text-foreground/80 hover:border-muted-foreground/50 hover:text-foreground hover:bg-black/30"}`,children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Ke,{className:w}),e.jsx("div",{className:"font-arcade text-xs leading-tight",children:"CODEX"})]}),e.jsx("div",{className:`${E} leading-tight`,children:"ChatGPT login"})]}),e.jsxs("button",{onClick:X,disabled:!C,className:`text-left px-2 py-1 border-2 transition-colors ${j==="openrouter"?"border-primary bg-primary/20 text-primary":"border-muted-foreground/30 text-foreground/80 hover:border-muted-foreground/50 hover:text-foreground hover:bg-black/30"} ${C?"":"opacity-50 cursor-not-allowed"}`,children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Fe,{className:w}),e.jsx("div",{className:"font-arcade text-xs leading-tight",children:"OPENROUTER"})]}),e.jsx("div",{className:`${E} leading-tight`,children:C?"API key enabled":"API key missing"})]})]}),j==="openrouter"?e.jsx("select",{value:u,onChange:t=>p(t.target.value),className:le,children:J.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))}):e.jsx("input",{value:u==="codex"?"":u,onChange:t=>p(t.target.value.trim()?t.target.value:"codex"),placeholder:"Codex model override (optional)",className:ce})]}),j==="codex"&&e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx(ee,{checked:O,onCheckedChange:t=>I(!!t)}),e.jsx(Qe,{className:w}),e.jsx("span",{className:U,children:"Web search"})]}),e.jsxs("div",{children:[e.jsx(B,{children:"Course"}),e.jsxs("select",{value:d??"",onChange:t=>i(t.target.value?Number(t.target.value):void 0),className:le,children:[e.jsx("option",{value:"",children:"All courses"}),F.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{children:[e.jsx(B,{icon:e.jsx(te,{className:w}),children:"Materials"}),e.jsx(Ve,{courseId:d,selectedMaterials:S,setSelectedMaterials:h})]}),e.jsxs("div",{className:"border-t border-primary/10 pt-2",children:[e.jsx(B,{children:"Upload"}),e.jsx(we,{courseId:d})]})]})}),e.jsx("div",{className:`shrink-0 ${Z} pt-2 border-t-2 border-primary/30`,children:e.jsxs(G,{onClick:D,disabled:r||l,className:Ee,children:[r?e.jsx(ie,{className:`${ae} animate-spin mr-1.5`}):e.jsx(Me,{className:`${ae} mr-1.5`}),l?"SESSION ACTIVE":"START SESSION"]})})]})}function et({sessionId:d,onArtifactCreated:i,onSessionEnd:S,chainBlocks:h=[],currentBlockIndex:m=0,onAdvanceBlock:A}){const N=h.length>0,c=N&&m>=h.length,[M,b]=o.useState([]),[u,p]=o.useState(""),[O,I]=o.useState(!1),D=o.useRef(null),r=o.useRef(null);o.useEffect(()=>{D.current&&(D.current.scrollTop=D.current.scrollHeight)},[M]),o.useEffect(()=>{r.current?.focus()},[d]);const l=o.useCallback(async()=>{if(!u.trim()||!d||O)return;const n=u.trim();p("");const g=/^\/(note|save)\b/i.test(n),x=/^\/(card|flashcard)\b/i.test(n),F=/^\/(map|diagram)\b/i.test(n);b(C=>[...C,{role:"user",content:n}]),b(C=>[...C,{role:"assistant",content:"",isStreaming:!0}]),I(!0);try{const j=(await fetch(`/api/tutor/session/${d}/turn`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:n})})).body?.getReader(),v=new TextDecoder;if(!j)throw new Error("No response body");let z="",P="",K=[],R;for(;;){const{done:k,value:q}=await j.read();if(k)break;z+=v.decode(q,{stream:!0});const Y=z.split(`
`);z=Y.pop()??"";for(const X of Y){if(!X.startsWith("data: "))continue;const t=X.slice(6);if(t==="[DONE]")break;try{const y=JSON.parse(t);if(y.type==="error"){b(a=>{const s=[...a];return s[s.length-1]={role:"assistant",content:`Error: ${y.content}`},s}),I(!1);return}y.type==="web_search_searching"&&b(a=>{const s=[...a];return s[s.length-1]={...s[s.length-1],content:`Searching the web...

`,isStreaming:!0},s}),y.type==="web_search_completed"&&(P="",b(a=>{const s=[...a];return s[s.length-1]={...s[s.length-1],content:"",isStreaming:!0},s})),y.type==="token"&&y.content&&(P+=y.content,b(a=>{const s=[...a],L=s[s.length-1];return s[s.length-1]={...L,content:L.content+y.content,isStreaming:!0},s})),y.type==="done"&&(K=y.citations??[],R=y.model)}catch{}}}b(k=>{const q=[...k];return q[q.length-1]={role:"assistant",content:P,citations:K,model:R,isStreaming:!1},q}),(g||x||F)&&i({type:g?"note":x?"card":"map",content:P,title:n.replace(/^\/(note|card|flashcard|map|diagram|save)\s*/i,"").trim()})}catch(C){b(j=>{const v=[...j];return v[v.length-1]={role:"assistant",content:`Connection error: ${C instanceof Error?C.message:"Unknown"}`},v})}finally{I(!1)}},[u,d,O,i]),f=n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),l())};return d?e.jsxs("div",{className:"flex flex-col h-full",children:[N&&e.jsxs("div",{className:"shrink-0 px-3 py-2 border-b-2 border-primary/30 bg-black/40",children:[e.jsxs("div",{className:"flex items-center gap-1 overflow-x-auto",children:[h.map((n,g)=>{const x=g<m,F=g===m&&!c;return e.jsxs("div",{className:"flex items-center shrink-0",children:[g>0&&e.jsx(Pe,{className:"w-4 h-4 text-muted-foreground/40 mx-0.5"}),e.jsxs("div",{className:`px-2 py-1 border-2 text-base font-terminal flex items-center gap-1 ${F?"border-primary bg-primary/20 text-primary":x?"border-primary/30 bg-primary/5 text-muted-foreground/70 line-through":"border-primary/20 text-muted-foreground/50"}`,children:[x&&e.jsx(ye,{className:"w-4 h-4"}),n.name]})]},n.id)}),!c&&A&&e.jsx("button",{onClick:A,className:"shrink-0 ml-2 px-3 py-1 border-2 border-primary/60 text-xs font-arcade text-primary hover:bg-primary/20 transition-colors",children:"NEXT"}),c&&e.jsx("span",{className:"shrink-0 ml-2 px-3 py-1 text-xs font-arcade text-green-400 border-2 border-green-400/50",children:"COMPLETE"})]}),!c&&h[m]&&e.jsxs("div",{className:"mt-1 text-base font-terminal text-muted-foreground",children:[e.jsx("span",{className:"text-primary",children:h[m].category.toUpperCase()})," ","· ~",h[m].duration,"min"]})]}),e.jsxs("div",{ref:D,className:"flex-1 overflow-y-auto p-3 space-y-3",children:[M.length===0&&e.jsxs("div",{className:"text-center py-8 space-y-2",children:[e.jsx("div",{className:"font-arcade text-sm text-primary",children:"SESSION STARTED"}),e.jsx("div",{className:"font-terminal text-lg text-muted-foreground",children:"Ask a question to begin learning. Use /note, /card, or /map for artifacts."})]}),M.map((n,g)=>e.jsx("div",{className:`flex ${n.role==="user"?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[85%] px-3 py-2 text-lg font-terminal ${n.role==="user"?"bg-primary/20 border-2 border-primary/50 text-foreground":"bg-black/40 border-2 border-primary/20 text-foreground"}`,children:[n.role==="assistant"?e.jsxs("div",{className:"prose prose-invert prose-lg max-w-none font-terminal [&_p]:my-2 [&_li]:my-1 [&_code]:text-base [&_pre]:text-base",children:[e.jsx(Ae,{remarkPlugins:[Oe],children:n.content||(n.isStreaming?"...":"")}),n.isStreaming&&e.jsx("span",{className:"inline-block w-2 h-3 bg-primary animate-pulse ml-0.5"})]}):e.jsx("div",{children:n.content}),(n.citations?.length||n.model)&&!n.isStreaming?e.jsxs("div",{className:"flex flex-wrap items-center gap-1 mt-2 pt-2 border-t border-primary/20",children:[n.citations?.map(x=>x.url?e.jsx("a",{href:x.url,target:"_blank",rel:"noopener noreferrer",children:e.jsxs(T,{variant:"outline",className:"text-sm rounded-none cursor-pointer hover:bg-primary/10",children:["[",x.index,"] ",x.source]})},x.index):e.jsxs(T,{variant:"outline",className:"text-sm rounded-none",children:["[",x.index,"] ",x.source]},x.index)),n.model&&e.jsx(T,{variant:"outline",className:"text-sm rounded-none text-muted-foreground/60 ml-auto",children:n.model})]}):null]})},g))]}),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-t border-primary/20",children:[e.jsx("span",{className:"text-base font-terminal text-muted-foreground/60",children:"Commands:"}),e.jsxs(T,{variant:"outline",className:"text-sm rounded-none cursor-pointer hover:bg-primary/10",onClick:()=>p("/note "),children:[e.jsx(te,{className:"w-4 h-4 mr-1"}),"/note"]}),e.jsxs(T,{variant:"outline",className:"text-sm rounded-none cursor-pointer hover:bg-primary/10",onClick:()=>p("/card "),children:[e.jsx(Ne,{className:"w-4 h-4 mr-1"}),"/card"]}),e.jsxs(T,{variant:"outline",className:"text-sm rounded-none cursor-pointer hover:bg-primary/10",onClick:()=>p("/map "),children:[e.jsx(be,{className:"w-4 h-4 mr-1"}),"/map"]}),e.jsx("div",{className:"flex-1"}),e.jsxs(G,{variant:"ghost",size:"sm",onClick:S,className:"text-sm font-terminal text-destructive hover:text-destructive h-8 px-3",children:[e.jsx(Be,{className:"w-4 h-4 mr-1"}),"END"]})]}),e.jsxs("div",{className:"flex items-center gap-2 p-3 border-t-2 border-primary/20",children:[e.jsx("input",{ref:r,value:u,onChange:n=>p(n.target.value),onKeyDown:f,placeholder:"Ask a question...",disabled:O,className:"flex-1 bg-black/60 border-2 border-primary/40 rounded-none px-3 py-2 text-lg font-terminal text-foreground placeholder:text-muted-foreground/50 focus:border-primary focus:outline-none disabled:opacity-50"}),e.jsx(G,{onClick:l,disabled:!u.trim()||O,className:"rounded-none border-2 border-primary h-11 w-11 p-0",children:O?e.jsx(ie,{className:"w-5 h-5 animate-spin"}):e.jsx(Re,{className:"w-5 h-5"})})]})]}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("div",{className:"font-arcade text-sm text-muted-foreground",children:"NO ACTIVE SESSION"}),e.jsx("div",{className:"font-terminal text-lg text-muted-foreground/70",children:"Configure content filter and start a session"})]})})}const tt={note:te,card:Ne,map:be},st={note:"text-blue-400",card:"text-yellow-400",map:"text-green-400"};function rt({sessionId:d,artifacts:i,turnCount:S,mode:h,topic:m,startedAt:A,recentSessions:N,onResumeSession:c}){const M=fe(),[b,u]=o.useState(null),[p,O]=o.useState(null),I=async r=>{try{await $.tutor.deleteSession(r),_.success("Session deleted"),M.invalidateQueries({queryKey:["tutor-sessions"]}),u(null)}catch(l){_.error(`Delete failed: ${l instanceof Error?l.message:"Unknown"}`)}},D=async r=>{O(r.session_id);try{const l=await $.tutor.getSession(r.session_id);if(!l.turns||l.turns.length===0){_.error("No turns to save");return}const f=[`# Tutor: ${r.topic||r.mode}`,`**Date:** ${new Date(r.started_at).toLocaleDateString()}`,`**Mode:** ${r.mode} | **Turns:** ${r.turn_count}`,"","---",""];for(const x of l.turns)f.push(`## Q${x.turn_number}`),f.push(x.question),f.push(""),x.answer&&(f.push("**Answer:**"),f.push(x.answer),f.push(""));const g=`Study Sessions/${`Tutor - ${(r.topic||r.mode).replace(/[^a-zA-Z0-9 ]/g,"").trim()}`}.md`;await $.obsidian.append(g,f.join(`
`)),_.success(`Saved to Obsidian: ${g}`)}catch(l){_.error(`Save failed: ${l instanceof Error?l.message:"Unknown"}`)}finally{O(null)}};return e.jsxs("div",{className:"flex flex-col h-full overflow-hidden",children:[e.jsx("div",{className:`shrink-0 ${Z} pb-2 border-b-2 border-secondary/30`,children:e.jsx("div",{className:ve,children:"ARTIFACTS"})}),e.jsx(ge,{className:"flex-1 min-h-0",children:e.jsxs("div",{className:`${Z} space-y-3`,children:[d?e.jsxs("div",{className:"space-y-2 pb-3 border-b border-muted-foreground/20",children:[e.jsxs("div",{className:"flex items-center gap-1.5 flex-wrap",children:[e.jsx(T,{variant:"outline",className:`${Q} h-5 px-1.5`,children:h}),e.jsx(T,{variant:"outline",className:`${Q} h-5 px-1.5 text-primary`,children:"FIRST PASS"})]}),m&&e.jsx("div",{className:`${U} text-sm`,children:m}),e.jsxs("div",{className:`flex items-center gap-3 ${E}`,children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(de,{className:w}),S," turns"]}),A&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ue,{className:w}),new Date(A).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]})]}):e.jsx("div",{className:`${U} text-muted-foreground/50 py-3 text-center`,children:"No active session"}),i.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:ne,children:"Artifacts"}),i.map((r,l)=>{const f=tt[r.type],n=st[r.type];return e.jsxs("div",{className:"border-2 border-muted-foreground/20 p-2.5 hover:border-primary/30 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(f,{className:`${ae} ${n}`}),e.jsx("span",{className:`${U} text-sm truncate flex-1`,children:r.title||`${r.type} #${l+1}`})]}),r.content&&e.jsx("div",{className:`${E} mt-1 line-clamp-2`,children:r.content.slice(0,100)})]},l)})]}),d&&i.length===0&&e.jsxs("div",{className:"text-center space-y-1 py-4",children:[e.jsx(Se,{className:`${$e} text-muted-foreground/30 mx-auto`}),e.jsx("div",{className:`${E} text-muted-foreground/50`,children:"No artifacts yet"}),e.jsx("div",{className:`${E} text-muted-foreground/30`,children:"Use /note, /card, or /map"})]}),N.length>0&&e.jsxs("div",{className:"space-y-2 pt-2 border-t border-muted-foreground/20",children:[e.jsx("div",{className:ne,children:"Recent Sessions"}),N.slice(0,8).map(r=>e.jsxs("div",{className:"border-2 border-muted-foreground/10 hover:border-muted-foreground/30 transition-colors",children:[e.jsxs("button",{onClick:()=>c(r.session_id),className:"w-full text-left px-3 py-2.5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{variant:"outline",className:`${Q} h-5 px-1.5 shrink-0 ${r.status==="active"?"text-green-400 border-green-400/50":"text-muted-foreground"}`,children:r.status==="active"?"LIVE":"DONE"}),e.jsx("span",{className:"font-terminal text-sm truncate flex-1",children:r.topic||r.mode})]}),e.jsxs("div",{className:`flex items-center gap-2 mt-1.5 ${E}`,children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(de,{className:w}),r.turn_count]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ue,{className:w}),new Date(r.started_at).toLocaleDateString()]}),e.jsx(T,{variant:"outline",className:`${Q} h-4 px-1 ml-auto`,children:r.mode})]})]}),e.jsxs("div",{className:"flex items-center border-t border-primary/20 px-2 py-1",children:[e.jsxs(G,{variant:"ghost",size:"sm",className:"h-8 px-3 rounded-none text-muted-foreground hover:text-primary font-terminal text-sm",disabled:p===r.session_id,onClick:l=>{l.stopPropagation(),D(r)},children:[e.jsx(De,{className:`${w} mr-1`}),p===r.session_id?"SAVING...":"SAVE"]}),e.jsx("div",{className:"ml-auto",children:b===r.session_id?e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("span",{className:"font-terminal text-sm text-red-400 mr-1",children:"Delete?"}),e.jsx(G,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 rounded-none text-red-400 hover:text-red-300 hover:bg-red-400/10",onClick:l=>{l.stopPropagation(),I(r.session_id)},children:e.jsx(ye,{className:w})}),e.jsx(G,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 rounded-none text-muted-foreground hover:text-foreground",onClick:l=>{l.stopPropagation(),u(null)},children:e.jsx(je,{className:w})})]}):e.jsx(G,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 rounded-none text-muted-foreground hover:text-red-400",onClick:l=>{l.stopPropagation(),u(r.session_id)},children:e.jsx(Ce,{className:w})})})]})]},r.session_id))]})]})})]})}function yt(){const d=fe(),[i,S]=o.useState(null),[h,m]=o.useState(!1),[A,N]=o.useState(),[c,M]=o.useState([]),[b,u]=o.useState("Core"),[p,O]=o.useState(),[I,D]=o.useState(0),[r,l]=o.useState([]),[f,n]=o.useState(""),[g,x]=o.useState("codex"),[F,C]=o.useState(!1),[j,v]=o.useState([]),[z,P]=o.useState(0),[K,R]=o.useState(null),{data:k=[]}=W({queryKey:["tutor-sessions"],queryFn:()=>$.tutor.listSessions({limit:10})}),q=o.useCallback(async()=>{m(!0);try{const a=await $.tutor.createSession({course_id:A,phase:"first_pass",mode:b,topic:f||void 0,content_filter:{...c.length>0?{material_ids:c}:{},model:g,...F?{web_search:!0}:{}},method_chain_id:p});if(S(a.session_id),R(a.started_at),v([]),P(0),D(a.current_block_index??0),p){const s=await $.tutor.getSession(a.session_id);s.chain_blocks&&l(s.chain_blocks.map(L=>({id:L.id,name:L.name,category:L.category,duration:L.default_duration_min})))}else l([]);_.success("Tutor session started"),d.invalidateQueries({queryKey:["tutor-sessions"]})}catch(a){_.error(`Failed to start session: ${a instanceof Error?a.message:"Unknown"}`)}finally{m(!1)}},[A,b,f,c,g,F,p,d]),Y=o.useCallback(async()=>{if(i)try{await $.tutor.endSession(i),_.success("Session ended"),S(null),v([]),P(0),R(null),D(0),l([]),d.invalidateQueries({queryKey:["tutor-sessions"]})}catch(a){_.error(`Failed to end session: ${a instanceof Error?a.message:"Unknown"}`)}},[i,d]),X=o.useCallback(async a=>{if(i)try{const s=await $.tutor.createArtifact(i,{type:a.type,content:a.content,title:a.title}),L={type:a.type,title:a.title||`${a.type} #${j.length+1}`,content:a.content.slice(0,200),createdAt:new Date().toISOString(),cardId:s.card_id};v(H=>[...H,L]),_.success(`${a.type.charAt(0).toUpperCase()+a.type.slice(1)} created`)}catch(s){_.error(`Failed to create artifact: ${s instanceof Error?s.message:"Unknown"}`)}},[i,j.length]),t=o.useCallback(async()=>{if(i)try{const a=await $.tutor.advanceBlock(i);D(a.block_index),a.complete?_.success("Chain complete!"):_.success(`Advanced to: ${a.block_name}`)}catch(a){_.error(`Failed to advance block: ${a instanceof Error?a.message:"Unknown"}`)}},[i]),y=o.useCallback(async a=>{try{const s=await $.tutor.getSession(a);if(S(s.session_id),P(s.turn_count),R(s.started_at),u(s.mode),n(s.topic||""),N(s.course_id??void 0),s.artifacts_json)try{const L=JSON.parse(s.artifacts_json);Array.isArray(L)&&v(L.map(H=>({type:H.type,title:H.title,content:"",createdAt:H.created_at})))}catch{v([])}_.success("Session resumed")}catch(s){_.error(`Failed to resume session: ${s instanceof Error?s.message:"Unknown"}`)}},[]);return e.jsx(ke,{children:e.jsxs("div",{className:"h-[calc(100vh-140px)] flex gap-2",children:[e.jsx(se,{className:"w-72 shrink-0 bg-black/40 border-2 border-primary rounded-none overflow-y-auto",children:e.jsx(Je,{courseId:A,setCourseId:N,selectedMaterials:c,setSelectedMaterials:M,mode:b,setMode:u,chainId:p,setChainId:O,topic:f,setTopic:n,model:g,setModel:x,webSearch:F,setWebSearch:C,onStartSession:q,isStarting:h,hasActiveSession:!!i})}),e.jsx(se,{className:"flex-1 bg-black/60 border-2 border-primary rounded-none flex flex-col min-w-0",children:e.jsx(et,{sessionId:i,onArtifactCreated:X,onSessionEnd:Y,chainBlocks:r,currentBlockIndex:I,onAdvanceBlock:t})}),e.jsx(se,{className:"w-72 shrink-0 bg-black/40 border-2 border-primary/40 rounded-none overflow-y-auto",children:e.jsx(rt,{sessionId:i,artifacts:j,turnCount:z,mode:b,topic:f,startedAt:K,onCreateArtifact:X,recentSessions:k,onResumeSession:y})})]})})}export{yt as default};
