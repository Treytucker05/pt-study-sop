import{c as ee,j as e,b as Ae,r as a,X as Ce,u as ke}from"./index-Dq2i42cU.js";import{f as J,a as O,S as me,E as pe,F as Oe,B as Q,G as De,o as Se,p as Le,n as Me,L as Re}from"./layout-MVbPqDQb.js";import{B as P,C as ie}from"./badge-BA71vPQw.js";import{I as w,T as g,d as W,e as H,f as se,P as te,g as we,h as he,i as fe,j as Pe,b as Fe}from"./theme-DVlXyDCo.js";import{C as ne}from"./checkbox-DS-B7bFA.js";import{M as Ie,t as A}from"./MaterialUploader-JiY5pk9R.js";import{L as xe}from"./loader-circle-CucYDA9g.js";import{F as oe}from"./file-text-B5MhEYMk.js";import{C as _e,a as qe}from"./index-w1J5KrVK.js";import{C as ce}from"./clock-DNmmqlQe.js";import{D as Ue,M as Ke,r as Ge,F as Be}from"./index-C5llXmyt.js";import{L as Qe}from"./link-tc9zKSjb.js";import{Z as ze}from"./zap-C79aeki9.js";import{S as Xe}from"./send-CZYNsg88.js";import{M as ge}from"./message-square-g8S0jRvh.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=[["path",{d:"M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z",key:"p7xjir"}]],Ve=ee("cloud",Ye);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=[["rect",{width:"20",height:"14",x:"2",y:"5",rx:"2",key:"ynyp8z"}],["line",{x1:"2",x2:"22",y1:"10",y2:"10",key:"1b3vmo"}]],$e=ee("credit-card",He);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const We=[["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M17 20v2",key:"1rnc9c"}],["path",{d:"M17 2v2",key:"11trls"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M2 17h2",key:"7oei6x"}],["path",{d:"M2 7h2",key:"asdhe0"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"M20 17h2",key:"1fpfkl"}],["path",{d:"M20 7h2",key:"1o8tra"}],["path",{d:"M7 20v2",key:"4gnj0m"}],["path",{d:"M7 2v2",key:"1i4yhu"}],["rect",{x:"4",y:"4",width:"16",height:"16",rx:"2",key:"1vbyd7"}],["rect",{x:"8",y:"8",width:"8",height:"8",rx:"1",key:"z9xiuo"}]],Ze=ee("cpu",We);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]],er=ee("globe",Je);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rr=[["path",{d:"M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z",key:"169xi5"}],["path",{d:"M15 5.764v15",key:"1pn4in"}],["path",{d:"M9 3.236v15",key:"1uimfh"}]],Ee=ee("map",rr);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const tr=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]],sr=ee("square",tr);function re({className:l,...o}){return e.jsx("div",{className:Ae("animate-pulse rounded-md bg-primary/10",l),...o})}const ar={pdf:"PDF",docx:"DOC",pptx:"PPT",md:"MD",txt:"TXT"};function nr({courseId:l,selectedMaterials:o,setSelectedMaterials:k}){const{data:N=[],isLoading:p}=J({queryKey:["tutor-materials",l],queryFn:()=>O.tutor.getMaterials(l?{course_id:l}:void 0)}),D=c=>{k(o.includes(c)?o.filter(F=>F!==c):[...o,c])},y=()=>{o.length===N.length?k([]):k(N.map(c=>c.id))};return p?e.jsx("div",{className:"flex items-center justify-center py-3",children:e.jsx(xe,{className:`${w} animate-spin text-muted-foreground`})}):N.length===0?e.jsx("div",{className:`${g} text-center py-2`,children:"No materials uploaded yet"}):e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:`flex items-center gap-1.5 px-1 py-0.5 ${W} text-muted-foreground hover:text-foreground cursor-pointer border-b border-muted-foreground/10 pb-1`,children:[e.jsx(ne,{checked:N.length>0&&o.length===N.length,onCheckedChange:y,className:"w-3 h-3"}),e.jsx("span",{children:"Select all"}),e.jsxs(P,{variant:"outline",className:`ml-auto ${H} h-4 px-1`,children:[o.length,"/",N.length]})]}),N.map(c=>e.jsxs("label",{className:`flex items-center gap-1.5 px-1 py-0.5 ${W} text-muted-foreground hover:text-foreground cursor-pointer`,children:[e.jsx(ne,{checked:o.includes(c.id),onCheckedChange:()=>D(c.id),className:"w-3 h-3"}),e.jsx(oe,{className:`${w} text-primary/60 shrink-0`}),e.jsx("span",{className:"truncate flex-1",children:c.title}),e.jsx(P,{variant:"outline",className:`${H} h-4 px-1 shrink-0`,children:ar[c.file_type]||c.file_type.toUpperCase()})]},c.id))]})}const ye=["prepare","encode","interrogate","retrieve","refine","overlearn"];function or({selectedBlockIds:l,setSelectedBlockIds:o}){const{data:k=[],isLoading:N}=J({queryKey:["tutor-method-blocks"],queryFn:()=>O.tutor.getMethodBlocks()}),[p,D]=a.useState(new Set),[y,c]=a.useState(null),[F,C]=a.useState(null),$=a.useMemo(()=>{const t=new Map;for(const s of k)t.set(s.id,s);return t},[k]),E=a.useMemo(()=>{const t={};for(const s of ye)t[s]=[];for(const s of k)t[s.category]||(t[s.category]=[]),t[s.category].push(s);return t},[k]),x=a.useMemo(()=>l.map(t=>$.get(t)).filter(Boolean),[l,$]),_=a.useMemo(()=>x.reduce((t,s)=>t+(s.default_duration_min||0),0),[x]),M=t=>{D(s=>{const h=new Set(s);return h.has(t)?h.delete(t):h.add(t),h})},n=t=>{o([...l,t])},u=t=>{o(l.filter((s,h)=>h!==t))},b=t=>{c(t)},i=(t,s)=>{t.preventDefault(),C(s)},v=t=>{if(y===null||y===t){c(null),C(null);return}const s=[...l],[h]=s.splice(y,1);s.splice(t,0,h),o(s),c(null),C(null)},f=()=>{c(null),C(null)};return N?e.jsx("div",{className:`${g} p-2`,children:"Loading blocks..."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:`${se} text-xs`,children:"BLOCK PICKER"}),e.jsx(me,{className:"h-36 border-2 border-primary/30 bg-black/20",children:e.jsx("div",{className:"p-1",children:ye.map(t=>{const s=E[t]||[];if(s.length===0)return null;const h=p.has(t),L=pe[t];return e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>M(t),className:"w-full flex items-center gap-1 px-2 py-1 text-left hover:bg-black/30 transition-colors",children:[h?e.jsx(_e,{className:"w-3 h-3",style:{color:L}}):e.jsx(qe,{className:"w-3 h-3",style:{color:L}}),e.jsxs("span",{className:"font-arcade text-[10px] uppercase",style:{color:L},children:[Oe[t]," (",s.length,")"]})]}),!h&&e.jsx("div",{className:"pl-4 pb-1 space-y-0.5",children:s.map(R=>e.jsxs("button",{onClick:()=>n(R.id),className:"w-full text-left px-2 py-1 text-xs font-terminal text-foreground/80 hover:bg-primary/10 hover:text-foreground transition-colors flex items-center justify-between",children:[e.jsx("span",{className:"truncate",children:R.name}),e.jsxs("span",{className:`${g} text-[10px] shrink-0 ml-2`,children:["~",R.default_duration_min,"m"]})]},R.id))})]},t)})})}),e.jsxs("div",{className:`${se} text-xs flex items-center justify-between`,children:[e.jsx("span",{children:"YOUR CHAIN"}),x.length>0&&e.jsx(Q,{variant:"ghost",size:"sm",onClick:()=>o([]),className:"h-5 px-2 text-[10px] font-arcade text-destructive hover:text-destructive",children:"CLEAR"})]}),e.jsx("div",{className:"border-2 border-primary/30 bg-black/20 min-h-[60px]",children:x.length===0?e.jsx("div",{className:`${g} text-xs p-3 text-center`,children:"Click blocks above to build your study chain"}):e.jsx("div",{className:"p-1 space-y-0.5",children:x.map((t,s)=>{const h=pe[t.category]||"#888";return e.jsxs("div",{draggable:!0,onDragStart:()=>b(s),onDragOver:L=>i(L,s),onDrop:()=>v(s),onDragEnd:f,className:`flex items-center gap-1 px-2 py-1 border transition-all ${F===s?"border-primary bg-primary/20":"border-primary/20 bg-black/30"}`,children:[e.jsx(De,{className:"w-3 h-3 text-muted-foreground/40 cursor-grab shrink-0"}),e.jsx(P,{variant:"outline",className:"text-[9px] rounded-none px-1 h-4 shrink-0",style:{borderColor:h,color:h},children:t.category.slice(0,3).toUpperCase()}),e.jsx("span",{className:"font-terminal text-xs text-foreground/80 truncate flex-1",children:t.name}),e.jsxs("span",{className:`${g} text-[10px] shrink-0`,children:["~",t.default_duration_min,"m"]}),e.jsx("button",{onClick:()=>u(s),className:"shrink-0 text-muted-foreground/40 hover:text-destructive transition-colors",children:e.jsx(Ce,{className:"w-3 h-3"})})]},`${t.id}-${s}`)})})}),x.length>0&&e.jsxs("div",{className:"flex items-center justify-between px-1",children:[e.jsxs("span",{className:`${g} text-xs`,children:[x.length," block",x.length!==1?"s":""]}),e.jsxs("span",{className:"flex items-center gap-1 font-terminal text-xs text-primary",children:[e.jsx(ce,{className:w}),"~",_," min"]})]})]})}const ae=[{value:"arcee-ai/trinity-large-preview:free",label:"Trinity Large (free)"},{value:"qwen/qwen3-coder-next",label:"Qwen3 Coder Next"},{value:"google/gemini-2.5-flash-lite",label:"Gemini 2.5 Flash Lite"}],ir=["Teaching Sprint","Diagnostic Sprint"],be={Core:"First Exposure (Core)",Sprint:"Review Sprint","Quick Sprint":"Quick Drill",Light:"Low Energy",Drill:"Mastery Review","Teaching Sprint":"First Exposure (Core)","Diagnostic Sprint":"Review Sprint"},ve="tutor.autopick_chain.v1",je="tutor.last_openrouter_model.v1",Ne="tutor.last_codex_model.v1";function de(l){try{return localStorage.getItem(l)}catch{return null}}function le(l,o){try{localStorage.setItem(l,o)}catch{}}function lr(l,o){const k=de(l);return k===null?o:k==="true"}function V({children:l,icon:o}){return e.jsxs("div",{className:`${se} flex items-center gap-1.5 pb-1 border-b border-primary/20 mb-2`,children:[o,l]})}function cr({courseId:l,setCourseId:o,selectedMaterials:k,setSelectedMaterials:N,mode:p,setMode:D,chainId:y,setChainId:c,customBlockIds:F,setCustomBlockIds:C,topic:$,setTopic:E,model:x,setModel:_,webSearch:M,setWebSearch:n,onStartSession:u,isStarting:b,hasActiveSession:i}){const{data:v,isLoading:f,isError:t}=J({queryKey:["tutor-content-sources"],queryFn:()=>O.tutor.getContentSources()}),{data:s=[],isLoading:h,isError:L}=J({queryKey:["tutor-template-chains"],queryFn:()=>O.tutor.getTemplateChains()}),{data:R=[],isLoading:U}=J({queryKey:["courses-active"],queryFn:()=>O.courses.getActive()}),K=v?.openrouter_enabled??!1,S=x.includes("/")?"openrouter":"codex";a.useEffect(()=>{!K&&S==="openrouter"&&_("codex")},[K,S,_]),a.useEffect(()=>{x&&(x.includes("/")?le(je,x):le(Ne,x))},[x]);const[I,G]=a.useState(()=>lr(ve,!0)),[Y,z]=a.useState(null),[X,T]=a.useState("templates");a.useEffect(()=>{le(ve,String(I))},[I]);const q=be[p],m=a.useMemo(()=>{if(q)return s.find(r=>r.name===q)},[s,q]);a.useEffect(()=>{I&&y===void 0&&m&&Y!==p&&(c(m.id),z(p))},[I,y,m?.id,Y,p,c]);const d=r=>{if(D(r),!I||y!==void 0)return;const Z=be[r];if(!Z)return;const ue=s.find(Te=>Te.name===Z);ue&&(c(ue.id),z(r))},j=()=>{const r=de(Ne),Z=r&&!r.includes("/")?r:"codex";_(Z)},B=()=>{if(!K)return;const r=de(je),Z=r&&r.includes("/")?r:ae[0].value;_(Z)};return a.useEffect(()=>{S==="openrouter"&&(ae.some(r=>r.value===x)||_(ae[0].value))},[S,x,_]),e.jsxs("div",{className:"flex flex-col h-full overflow-hidden",children:[e.jsxs("div",{className:`shrink-0 ${te} pb-2 border-b-2 border-primary/30`,children:[e.jsx("div",{className:we,children:"CONTENT FILTER"}),(t||L)&&e.jsxs("div",{className:`${g} text-destructive`,children:["Tutor API unavailable. Start the dashboard via ",e.jsx("span",{className:"font-arcade",children:"Start_Dashboard.bat"}),"."]}),e.jsxs("div",{className:`flex items-center gap-2 mt-1 ${g}`,children:[e.jsx(Ue,{className:w}),v?.total_materials??0," materials",e.jsx("span",{className:"text-muted-foreground/40",children:"|"}),v?.total_instructions??0," SOP"]})]}),e.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto",children:e.jsxs("div",{className:`${te} space-y-2`,children:[e.jsxs("div",{children:[e.jsx(V,{children:"Mode"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-1",children:[e.jsxs("button",{onClick:()=>d("Core"),className:`text-left px-2 py-2 border-2 transition-colors ${p==="Core"?"border-primary bg-primary/20 text-primary":"border-primary/30 text-foreground/80 hover:border-primary/50 hover:text-foreground hover:bg-black/30"}`,children:[e.jsx("div",{className:"font-arcade text-xs leading-tight truncate",children:"LEARN"}),e.jsx("div",{className:`${g} text-xs leading-tight truncate`,children:"Prime + encode"})]}),e.jsxs("button",{onClick:()=>d("Quick Sprint"),className:`text-left px-2 py-2 border-2 transition-colors ${p==="Quick Sprint"?"border-primary bg-primary/20 text-primary":"border-primary/30 text-foreground/80 hover:border-primary/50 hover:text-foreground hover:bg-black/30"}`,children:[e.jsx("div",{className:"font-arcade text-xs leading-tight truncate",children:"QUICK"}),e.jsx("div",{className:`${g} text-xs leading-tight truncate`,children:"Quick retrieval"})]})]}),e.jsx("button",{onClick:()=>d("Drill"),className:`w-full text-left px-2 py-2 border-2 transition-colors ${p==="Drill"?"border-primary bg-primary/20 text-primary":"border-primary/30 text-foreground/80 hover:border-primary/50 hover:text-foreground hover:bg-black/30"}`,children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-arcade text-xs leading-tight",children:"FIX"}),e.jsx("div",{className:`${g} text-xs leading-tight`,children:"Target weak spots"})]})})}),e.jsxs("div",{className:"grid grid-cols-2 gap-1",children:[e.jsxs("button",{onClick:()=>d("Sprint"),className:`text-left px-2 py-2 border-2 transition-colors ${p==="Sprint"?"border-primary bg-primary/20 text-primary":"border-primary/30 text-foreground/80 hover:border-primary/50 hover:text-foreground hover:bg-black/30"}`,children:[e.jsx("div",{className:"font-arcade text-xs leading-tight truncate",children:"REVIEW"}),e.jsx("div",{className:`${g} text-xs leading-tight truncate`,children:"Retrieve + refine"})]}),e.jsxs("button",{onClick:()=>d("Light"),className:`text-left px-2 py-2 border-2 transition-colors ${p==="Light"?"border-primary bg-primary/20 text-primary":"border-primary/30 text-foreground/80 hover:border-primary/50 hover:text-foreground hover:bg-black/30"}`,children:[e.jsx("div",{className:"font-arcade text-xs leading-tight truncate",children:"LIGHT"}),e.jsx("div",{className:`${g} text-xs leading-tight truncate`,children:"Low energy"})]})]})]}),e.jsx("div",{className:`${g} text-xs mt-2`,children:"Auto-picks a chain template. Override below."}),ir.includes(p)&&e.jsxs("div",{className:`${g} text-xs mt-1`,children:["Legacy mode active: ",p]})]}),e.jsxs("div",{children:[e.jsx(V,{icon:e.jsx(Qe,{className:w}),children:"Chain"}),e.jsxs("div",{className:"grid grid-cols-2 gap-1 mb-2 min-w-0",children:[e.jsx("button",{onClick:()=>T("templates"),className:`px-1.5 py-1 border-2 font-arcade text-[10px] truncate transition-colors ${X==="templates"?"border-primary bg-primary/20 text-primary":"border-primary/30 text-foreground/80 hover:border-primary/50"}`,children:"TEMPLATES"}),e.jsx("button",{onClick:()=>{T("custom"),c(void 0)},className:`px-1.5 py-1 border-2 font-arcade text-[10px] truncate transition-colors ${X==="custom"?"border-primary bg-primary/20 text-primary":"border-primary/30 text-foreground/80 hover:border-primary/50"}`,children:"CUSTOM"})]}),X==="templates"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-2",children:[e.jsxs("div",{className:`${g} text-xs min-w-0 truncate`,children:[e.jsx("span",{className:"opacity-70",children:"Rec:"})," ",m?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-foreground font-medium",children:m.name}),e.jsxs(P,{variant:"outline",className:`ml-1 ${H} h-4 px-1.5 text-xs`,children:[m.blocks.length," blocks"]})]}):h?e.jsx(re,{className:"inline-block w-20 h-4 bg-primary/10"}):e.jsx("span",{className:"opacity-70",children:"—"})]}),m&&y!==m.id&&e.jsx(Q,{size:"sm",onClick:()=>c(m.id),className:"rounded-none h-6 px-2 font-arcade text-[10px] bg-primary text-primary-foreground hover:bg-primary/90 border border-primary",children:"APPLY"})]}),e.jsxs("label",{className:`flex items-center gap-2 ${W} text-muted-foreground mb-2 cursor-pointer`,children:[e.jsx(ne,{checked:I,onCheckedChange:r=>G(r===!0),className:"w-3 h-3"}),e.jsx("span",{className:"select-none text-xs",children:"Auto-pick recommended chain"})]}),e.jsx(me,{className:"h-40 border-2 border-primary/30 bg-black/20",children:e.jsxs("div",{className:"p-1 space-y-1",children:[e.jsx("button",{onClick:()=>{c(void 0),z(p)},className:`w-full text-left px-3 py-2 border-2 transition-all ${y?"border-primary/20 text-foreground/80 hover:border-primary/40 hover:text-foreground hover:bg-black/30":"border-primary bg-primary/20 text-primary"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-arcade text-xs",children:"FREEFORM"}),e.jsx("div",{className:`${g} text-xs`,children:"No template"})]}),!y&&e.jsx("div",{className:"w-2 h-2 rounded-full bg-primary"})]})}),h?e.jsxs("div",{className:"space-y-2 p-2",children:[e.jsx(re,{className:"w-full h-10 bg-primary/10"}),e.jsx(re,{className:"w-full h-10 bg-primary/10"}),e.jsx(re,{className:"w-full h-10 bg-primary/10"})]}):s.map(r=>e.jsx("button",{onClick:()=>c(r.id),className:`w-full text-left px-3 py-2 border-2 transition-all ${y===r.id?"border-primary bg-primary/20 text-primary":"border-primary/20 text-foreground/80 hover:border-primary/40 hover:text-foreground hover:bg-black/30"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"font-arcade text-xs truncate",children:r.name.toUpperCase()}),e.jsxs("div",{className:`${g} text-xs`,children:[r.blocks.length," blocks"]})]}),y===r.id&&e.jsx("div",{className:"w-2 h-2 rounded-full bg-primary ml-2"})]})},r.id))]})})]}):e.jsx(or,{selectedBlockIds:F,setSelectedBlockIds:C})]}),e.jsxs("div",{children:[e.jsx(V,{children:"Topic"}),e.jsx("input",{value:$,onChange:r=>E(r.target.value),placeholder:"e.g. Hip Flexors",className:`${he} border-2 border-primary/30`})]}),e.jsxs("div",{children:[e.jsx(V,{children:"Model"}),e.jsxs("div",{className:"space-y-1 mb-2",children:[e.jsx("button",{onClick:j,className:`w-full text-left px-3 py-2 border-2 transition-colors ${S==="codex"?"border-primary bg-primary/20 text-primary":"border-primary/30 text-foreground/80 hover:border-primary/50 hover:text-foreground hover:bg-black/30"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ze,{className:w}),e.jsxs("div",{children:[e.jsx("div",{className:"font-arcade text-xs leading-tight",children:"CODEX"}),e.jsx("div",{className:`${g} text-xs leading-tight`,children:"ChatGPT login"})]})]}),S==="codex"&&e.jsx("div",{className:"w-2 h-2 rounded-full bg-primary"})]})}),e.jsx("button",{onClick:B,disabled:!K,className:`w-full text-left px-3 py-2 border-2 transition-colors ${S==="openrouter"?"border-primary bg-primary/20 text-primary":"border-primary/30 text-foreground/80 hover:border-primary/50 hover:text-foreground hover:bg-black/30"} ${K?"":"opacity-50 cursor-not-allowed"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ve,{className:w}),e.jsxs("div",{children:[e.jsx("div",{className:"font-arcade text-xs leading-tight",children:"OPENROUTER"}),e.jsx("div",{className:`${g} text-xs leading-tight`,children:K?"API key enabled":"API key missing"})]})]}),S==="openrouter"&&e.jsx("div",{className:"w-2 h-2 rounded-full bg-primary"})]})})]}),S==="openrouter"?e.jsx("select",{value:x,onChange:r=>_(r.target.value),className:`${fe} border-2 border-primary/30`,children:ae.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))}):e.jsx("input",{value:x==="codex"?"":x,onChange:r=>_(r.target.value.trim()?r.target.value:"codex"),placeholder:"Codex model override (optional)",className:`${he} border-2 border-primary/30`})]}),e.jsxs("label",{className:`flex items-center gap-2 cursor-pointer ${S!=="codex"?"opacity-50":""}`,children:[e.jsx(ne,{checked:M,onCheckedChange:r=>S==="codex"&&n(!!r),disabled:S!=="codex"}),e.jsx(er,{className:w}),e.jsx("span",{className:`${W} text-xs`,children:"Web search"}),S!=="codex"&&e.jsx("span",{className:"text-[10px] text-muted-foreground",children:"(Codex only)"})]}),e.jsxs("div",{children:[e.jsx(V,{children:"Course"}),U?e.jsx(re,{className:"w-full h-10 bg-primary/10"}):e.jsxs("select",{value:l??"",onChange:r=>o(r.target.value?Number(r.target.value):void 0),className:`${fe} border-2 border-primary/30`,children:[e.jsx("option",{value:"",children:"All courses"}),R.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]})]}),e.jsxs("div",{children:[e.jsx(V,{icon:e.jsx(oe,{className:w}),children:"Materials"}),e.jsx(nr,{courseId:l,selectedMaterials:k,setSelectedMaterials:N})]}),e.jsxs("div",{className:"border-t border-primary/10 pt-2",children:[e.jsx(V,{children:"Upload"}),e.jsx(Ie,{courseId:l})]})]})}),e.jsx("div",{className:`shrink-0 ${te} pt-2 border-t-2 border-primary/30`,children:e.jsxs(Q,{onClick:u,disabled:b||i,className:`w-full rounded-none border-2 font-arcade text-xs h-9 ${i?"border-success/50 bg-success/10 text-success cursor-default":b?"border-primary/50 bg-primary/10 text-primary cursor-wait":"border-primary bg-primary/10 hover:bg-primary/20"}`,children:[b?e.jsx(xe,{className:`${w} animate-spin mr-1`}):i?e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-success animate-pulse"}),"SESSION ACTIVE"]}):e.jsx(ze,{className:`${w} mr-1`}),!b&&!i&&"START SESSION"]})})]})}function dr({sessionId:l,onArtifactCreated:o,onSessionEnd:k,chainBlocks:N=[],currentBlockIndex:p=0,onAdvanceBlock:D}){const y=N.length>0,c=y&&p>=N.length,[F,C]=a.useState([]),[$,E]=a.useState(""),[x,_]=a.useState(!1),M=a.useRef(null),n=a.useRef(null);a.useEffect(()=>{M.current&&(M.current.scrollTop=M.current.scrollHeight)},[F]),a.useEffect(()=>{n.current?.focus()},[l]);const u=a.useCallback(async()=>{if(!$.trim()||!l||x)return;const i=$.trim();E("");const v=/^\/(note|save)\b/i.test(i),f=/^\/(card|flashcard)\b/i.test(i),t=/^\/(map|diagram)\b/i.test(i);C(s=>[...s,{role:"user",content:i}]),C(s=>[...s,{role:"assistant",content:"",isStreaming:!0}]),_(!0);try{const h=(await fetch(`/api/tutor/session/${l}/turn`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:i})})).body?.getReader(),L=new TextDecoder;if(!h)throw new Error("No response body");let R="",U="",K=[],S;for(;;){const{done:I,value:G}=await h.read();if(I)break;R+=L.decode(G,{stream:!0});const Y=R.split(`
`);R=Y.pop()??"";for(const z of Y){if(!z.startsWith("data: "))continue;const X=z.slice(6);if(X==="[DONE]")break;try{const T=JSON.parse(X);if(T.type==="error"){C(q=>{const m=[...q];return m[m.length-1]={role:"assistant",content:`Error: ${T.content}`},m}),_(!1);return}T.type==="web_search_searching"&&C(q=>{const m=[...q];return m[m.length-1]={...m[m.length-1],content:`Searching the web...

`,isStreaming:!0},m}),T.type==="web_search_completed"&&(U="",C(q=>{const m=[...q];return m[m.length-1]={...m[m.length-1],content:"",isStreaming:!0},m})),T.type==="token"&&T.content&&(U+=T.content,C(q=>{const m=[...q],d=m[m.length-1];return m[m.length-1]={...d,content:d.content+T.content,isStreaming:!0},m})),T.type==="done"&&(K=T.citations??[],S=T.model)}catch{}}}C(I=>{const G=[...I];return G[G.length-1]={role:"assistant",content:U,citations:K,model:S,isStreaming:!1},G}),(v||f||t)&&o({type:v?"note":f?"card":"map",content:U,title:i.replace(/^\/(note|card|flashcard|map|diagram|save)\s*/i,"").trim()})}catch(s){C(h=>{const L=[...h];return L[L.length-1]={role:"assistant",content:`Connection error: ${s instanceof Error?s.message:"Unknown"}`},L})}finally{_(!1)}},[$,l,x,o]),b=i=>{i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),u())};return l?e.jsxs("div",{className:"flex flex-col h-full",children:[y&&e.jsxs("div",{className:"shrink-0 px-3 py-2 border-b-2 border-primary/30 bg-black/40",children:[e.jsxs("div",{className:"flex items-center gap-1 overflow-x-auto",children:[N.map((i,v)=>{const f=v<p,t=v===p&&!c;return e.jsxs("div",{className:"flex items-center shrink-0",children:[v>0&&e.jsx(_e,{className:"w-4 h-4 text-muted-foreground/40 mx-0.5"}),e.jsxs("div",{className:`px-2 py-1 border-2 text-base font-terminal flex items-center gap-1 ${t?"border-primary bg-primary/20 text-primary":f?"border-primary/30 bg-primary/5 text-muted-foreground/70 line-through":"border-primary/20 text-muted-foreground/50"}`,children:[f&&e.jsx(Se,{className:"w-4 h-4"}),i.name]})]},i.id)}),!c&&D&&e.jsx("button",{onClick:D,className:"shrink-0 ml-2 px-3 py-1 border-2 border-primary/60 text-xs font-arcade text-primary hover:bg-primary/20 transition-colors",children:"NEXT"}),c&&e.jsx("span",{className:"shrink-0 ml-2 px-3 py-1 text-xs font-arcade text-green-400 border-2 border-green-400/50",children:"COMPLETE"})]}),!c&&N[p]&&e.jsxs("div",{className:"mt-1 text-base font-terminal text-muted-foreground",children:[e.jsx("span",{className:"text-primary",children:N[p].category.toUpperCase()})," ","· ~",N[p].duration,"min"]})]}),e.jsxs("div",{ref:M,className:"flex-1 overflow-y-auto p-3 space-y-3",children:[F.length===0&&e.jsxs("div",{className:"text-center py-8 space-y-2",children:[e.jsx("div",{className:"font-arcade text-sm text-primary",children:"SESSION STARTED"}),e.jsx("div",{className:"font-terminal text-lg text-muted-foreground",children:"Ask a question to begin learning. Use /note, /card, or /map for artifacts."})]}),F.map((i,v)=>e.jsx("div",{className:`flex ${i.role==="user"?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[85%] px-3 py-2 text-lg font-terminal ${i.role==="user"?"bg-primary/20 border-2 border-primary/50 text-foreground":"bg-black/40 border-2 border-primary/20 text-foreground"}`,children:[i.role==="assistant"?e.jsxs("div",{className:"prose prose-invert prose-lg max-w-none font-terminal [&_p]:my-2 [&_li]:my-1 [&_code]:text-base [&_pre]:text-base",children:[e.jsx(Ke,{remarkPlugins:[Ge],children:i.content||(i.isStreaming?"...":"")}),i.isStreaming&&e.jsx("span",{className:"inline-block w-2 h-3 bg-primary animate-pulse ml-0.5"})]}):e.jsx("div",{children:i.content}),(i.citations?.length||i.model)&&!i.isStreaming?e.jsxs("div",{className:"flex flex-wrap items-center gap-1 mt-2 pt-2 border-t border-primary/20",children:[i.citations?.map(f=>f.url?e.jsx("a",{href:f.url,target:"_blank",rel:"noopener noreferrer",children:e.jsxs(P,{variant:"outline",className:"text-sm rounded-none cursor-pointer hover:bg-primary/10",children:["[",f.index,"] ",f.source]})},f.index):e.jsxs(P,{variant:"outline",className:"text-sm rounded-none",children:["[",f.index,"] ",f.source]},f.index)),i.model&&e.jsx(P,{variant:"outline",className:"text-sm rounded-none text-muted-foreground/60 ml-auto",children:i.model})]}):null]})},v))]}),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-t border-primary/20",children:[e.jsx("span",{className:"text-base font-terminal text-muted-foreground/60",children:"Commands:"}),e.jsxs(P,{variant:"outline",className:"text-sm rounded-none cursor-pointer hover:bg-primary/10",onClick:()=>E("/note "),children:[e.jsx(oe,{className:"w-4 h-4 mr-1"}),"/note"]}),e.jsxs(P,{variant:"outline",className:"text-sm rounded-none cursor-pointer hover:bg-primary/10",onClick:()=>E("/card "),children:[e.jsx($e,{className:"w-4 h-4 mr-1"}),"/card"]}),e.jsxs(P,{variant:"outline",className:"text-sm rounded-none cursor-pointer hover:bg-primary/10",onClick:()=>E("/map "),children:[e.jsx(Ee,{className:"w-4 h-4 mr-1"}),"/map"]}),e.jsx("div",{className:"flex-1"}),e.jsxs(Q,{variant:"ghost",size:"sm",onClick:k,className:"text-sm font-terminal text-destructive hover:text-destructive h-8 px-3",children:[e.jsx(sr,{className:"w-4 h-4 mr-1"}),"END"]})]}),e.jsxs("div",{className:"flex items-center gap-2 p-3 border-t-2 border-primary/20",children:[e.jsx("input",{ref:n,value:$,onChange:i=>E(i.target.value),onKeyDown:b,placeholder:"Ask a question...",disabled:x,className:"flex-1 bg-black/60 border-2 border-primary/40 rounded-none px-3 py-2 text-lg font-terminal text-foreground placeholder:text-muted-foreground/50 focus:border-primary focus:outline-none disabled:opacity-50"}),e.jsx(Q,{onClick:u,disabled:!$.trim()||x,className:"rounded-none border-2 border-primary h-11 w-11 p-0",children:x?e.jsx(xe,{className:"w-5 h-5 animate-spin"}):e.jsx(Xe,{className:"w-5 h-5"})})]})]}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("div",{className:"font-arcade text-sm text-muted-foreground",children:"NO ACTIVE SESSION"}),e.jsx("div",{className:"font-terminal text-lg text-muted-foreground/70",children:"Configure content filter and start a session"})]})})}const mr={note:oe,card:$e,map:Ee},xr={note:"text-blue-400",card:"text-yellow-400",map:"text-green-400"};function ur({sessionId:l,artifacts:o,turnCount:k,mode:N,topic:p,startedAt:D,recentSessions:y,onResumeSession:c}){const F=ke(),[C,$]=a.useState(null),[E,x]=a.useState(null),_=async n=>{try{await O.tutor.deleteSession(n),A.success("Session deleted"),F.invalidateQueries({queryKey:["tutor-sessions"]}),$(null)}catch(u){A.error(`Delete failed: ${u instanceof Error?u.message:"Unknown"}`)}},M=async n=>{x(n.session_id);try{const u=await O.tutor.getSession(n.session_id);if(!u.turns||u.turns.length===0){A.error("No turns to save");return}const b=[`# Tutor: ${n.topic||n.mode}`,`**Date:** ${new Date(n.started_at).toLocaleDateString()}`,`**Mode:** ${n.mode} | **Turns:** ${n.turn_count}`,"","---",""];for(const f of u.turns)b.push(`## Q${f.turn_number}`),b.push(f.question),b.push(""),f.answer&&(b.push("**Answer:**"),b.push(f.answer),b.push(""));const v=`Study Sessions/${`Tutor - ${(n.topic||n.mode).replace(/[^a-zA-Z0-9 ]/g,"").trim()}`}.md`;await O.obsidian.append(v,b.join(`
`)),A.success(`Saved to Obsidian: ${v}`)}catch(u){A.error(`Save failed: ${u instanceof Error?u.message:"Unknown"}`)}finally{x(null)}};return e.jsxs("div",{className:"flex flex-col h-full overflow-hidden",children:[e.jsx("div",{className:`shrink-0 ${te} pb-2 border-b-2 border-primary/30`,children:e.jsx("div",{className:we,children:"ARTIFACTS"})}),e.jsx(me,{className:"flex-1 min-h-0",children:e.jsxs("div",{className:`${te} space-y-3`,children:[l?e.jsxs("div",{className:"space-y-2 pb-3 border-b border-muted-foreground/20",children:[e.jsxs("div",{className:"flex items-center gap-1.5 flex-wrap",children:[e.jsx(P,{variant:"outline",className:`${H} h-5 px-1.5`,children:N}),e.jsx(P,{variant:"outline",className:`${H} h-5 px-1.5 text-primary`,children:"FIRST PASS"})]}),p&&e.jsx("div",{className:`${W} text-sm`,children:p}),e.jsxs("div",{className:`flex items-center gap-3 ${g}`,children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ge,{className:w}),k," turns"]}),D&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ce,{className:w}),new Date(D).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]})]}):e.jsx("div",{className:`${W} text-muted-foreground/50 py-3 text-center`,children:"No active session"}),o.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:se,children:"Artifacts"}),o.map((n,u)=>{const b=mr[n.type],i=xr[n.type];return e.jsxs("div",{className:"border-2 border-muted-foreground/20 p-2.5 hover:border-primary/30 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(b,{className:`${Pe} ${i}`}),e.jsx("span",{className:`${W} text-sm truncate flex-1`,children:n.title||`${n.type} #${u+1}`})]}),n.content&&e.jsx("div",{className:`${g} mt-1 line-clamp-2`,children:n.content.slice(0,100)})]},u)})]}),l&&o.length===0&&e.jsxs("div",{className:"text-center space-y-1 py-4",children:[e.jsx(Le,{className:`${Fe} text-muted-foreground/30 mx-auto`}),e.jsx("div",{className:`${g} text-muted-foreground/50`,children:"No artifacts yet"}),e.jsx("div",{className:`${g} text-muted-foreground/30`,children:"Use /note, /card, or /map"})]}),y.length>0&&e.jsxs("div",{className:"space-y-2 pt-2 border-t border-muted-foreground/20",children:[e.jsx("div",{className:se,children:"Recent Sessions"}),y.slice(0,8).map(n=>e.jsxs("div",{className:"border-2 border-muted-foreground/10 hover:border-muted-foreground/30 transition-colors",children:[e.jsxs("button",{onClick:()=>c(n.session_id),className:"w-full text-left px-3 py-2.5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(P,{variant:"outline",className:`${H} h-5 px-1.5 shrink-0 ${n.status==="active"?"text-green-400 border-green-400/50":"text-muted-foreground"}`,children:n.status==="active"?"LIVE":"DONE"}),e.jsx("span",{className:"font-terminal text-sm truncate flex-1",children:n.topic||n.mode})]}),e.jsxs("div",{className:`flex items-center gap-2 mt-1.5 ${g}`,children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ge,{className:w}),n.turn_count]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ce,{className:w}),new Date(n.started_at).toLocaleDateString()]}),e.jsx(P,{variant:"outline",className:`${H} h-4 px-1 ml-auto`,children:n.mode})]})]}),e.jsxs("div",{className:"flex items-center border-t border-primary/20 px-2 py-1",children:[e.jsxs(Q,{variant:"ghost",size:"sm",className:"h-8 px-3 rounded-none text-muted-foreground hover:text-primary font-terminal text-sm",disabled:E===n.session_id,onClick:u=>{u.stopPropagation(),M(n)},children:[e.jsx(Be,{className:`${w} mr-1`}),E===n.session_id?"SAVING...":"SAVE"]}),e.jsx("div",{className:"ml-auto",children:C===n.session_id?e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("span",{className:"font-terminal text-sm text-red-400 mr-1",children:"Delete?"}),e.jsx(Q,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 rounded-none text-red-400 hover:text-red-300 hover:bg-red-400/10",onClick:u=>{u.stopPropagation(),_(n.session_id)},children:e.jsx(Se,{className:w})}),e.jsx(Q,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 rounded-none text-muted-foreground hover:text-foreground",onClick:u=>{u.stopPropagation(),$(null)},children:e.jsx(Ce,{className:w})})]}):e.jsx(Q,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 rounded-none text-muted-foreground hover:text-red-400",onClick:u=>{u.stopPropagation(),$(n.session_id)},children:e.jsx(Me,{className:w})})})]})]},n.session_id))]})]})})]})}function Er(){const l=ke(),[o,k]=a.useState(null),[N,p]=a.useState(!1),[D,y]=a.useState(),[c,F]=a.useState([]),[C,$]=a.useState("Core"),[E,x]=a.useState(),[_,M]=a.useState(0),[n,u]=a.useState([]),[b,i]=a.useState([]),[v,f]=a.useState(""),[t,s]=a.useState("codex"),[h,L]=a.useState(!1),[R,U]=a.useState([]),[K,S]=a.useState(0),[I,G]=a.useState(null),{data:Y=[]}=J({queryKey:["tutor-sessions"],queryFn:()=>O.tutor.listSessions({limit:10})}),z=a.useCallback(async()=>{p(!0);try{let d=E;!d&&b.length>0&&(d=(await O.tutor.createCustomChain(b,`Custom ${v||"Chain"}`)).id);const j=await O.tutor.createSession({course_id:D,phase:"first_pass",mode:C,topic:v||void 0,content_filter:{...c.length>0?{material_ids:c}:{},model:t,...h?{web_search:!0}:{}},method_chain_id:d});if(k(j.session_id),G(j.started_at),U([]),S(0),M(j.current_block_index??0),E){const B=await O.tutor.getSession(j.session_id);B.chain_blocks&&u(B.chain_blocks.map(r=>({id:r.id,name:r.name,category:r.category,duration:r.default_duration_min})))}else u([]);A.success("Tutor session started"),l.invalidateQueries({queryKey:["tutor-sessions"]})}catch(d){A.error(`Failed to start session: ${d instanceof Error?d.message:"Unknown"}`)}finally{p(!1)}},[D,C,v,c,t,h,E,b,l]),X=a.useCallback(async()=>{if(o)try{await O.tutor.endSession(o),A.success("Session ended"),k(null),U([]),S(0),G(null),M(0),u([]),l.invalidateQueries({queryKey:["tutor-sessions"]})}catch(d){A.error(`Failed to end session: ${d instanceof Error?d.message:"Unknown"}`)}},[o,l]),T=a.useCallback(async d=>{if(o)try{const j=await O.tutor.createArtifact(o,{type:d.type,content:d.content,title:d.title}),B={type:d.type,title:d.title||`${d.type} #${R.length+1}`,content:d.content.slice(0,200),createdAt:new Date().toISOString(),cardId:j.card_id};U(r=>[...r,B]),A.success(`${d.type.charAt(0).toUpperCase()+d.type.slice(1)} created`)}catch(j){A.error(`Failed to create artifact: ${j instanceof Error?j.message:"Unknown"}`)}},[o,R.length]),q=a.useCallback(async()=>{if(o)try{const d=await O.tutor.advanceBlock(o);M(d.block_index),d.complete?A.success("Chain complete!"):A.success(`Advanced to: ${d.block_name}`)}catch(d){A.error(`Failed to advance block: ${d instanceof Error?d.message:"Unknown"}`)}},[o]),m=a.useCallback(async d=>{try{const j=await O.tutor.getSession(d);if(k(j.session_id),S(j.turn_count),G(j.started_at),$(j.mode),f(j.topic||""),y(j.course_id??void 0),j.artifacts_json)try{const B=JSON.parse(j.artifacts_json);Array.isArray(B)&&U(B.map(r=>({type:r.type,title:r.title,content:"",createdAt:r.created_at})))}catch{U([])}A.success("Session resumed")}catch(j){A.error(`Failed to resume session: ${j instanceof Error?j.message:"Unknown"}`)}},[]);return e.jsx(Re,{children:e.jsxs("div",{className:"h-[calc(100vh-140px)] flex gap-2",children:[e.jsx(ie,{className:"w-80 shrink-0 bg-black/40 border-2 border-primary rounded-none overflow-hidden",children:e.jsx(cr,{courseId:D,setCourseId:y,selectedMaterials:c,setSelectedMaterials:F,mode:C,setMode:$,chainId:E,setChainId:x,customBlockIds:b,setCustomBlockIds:i,topic:v,setTopic:f,model:t,setModel:s,webSearch:h,setWebSearch:L,onStartSession:z,isStarting:N,hasActiveSession:!!o})}),e.jsx(ie,{className:"flex-1 bg-black/60 border-2 border-primary rounded-none flex flex-col min-w-0",children:e.jsx(dr,{sessionId:o,onArtifactCreated:T,onSessionEnd:X,chainBlocks:n,currentBlockIndex:_,onAdvanceBlock:q})}),e.jsx(ie,{className:"w-80 shrink-0 bg-black/40 border-2 border-primary rounded-none overflow-hidden",children:e.jsx(ur,{sessionId:o,artifacts:R,turnCount:K,mode:C,topic:v,startedAt:I,onCreateArtifact:T,recentSessions:Y,onResumeSession:m})})]})})}export{Er as default};
