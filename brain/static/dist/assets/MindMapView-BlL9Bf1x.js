import{r as c,j as s,b as V}from"./index-BlYeaXO_.js";import{F as se}from"./react-force-graph-2d-BYgm8vpY.js";import{f as W,S as te,a as q}from"./layout-gVyc4PHV.js";import{c as ne,T as oe,a as Y}from"./tldraw-CBAQPAcn.js";import{C as T}from"./checkbox-Cf1cptsE.js";import"./zoom-DwwqPMg_.js";import"./select-QEDRTD4h.js";import"./index-k9OrQCuz.js";import"./tabs-3gssYqFA.js";const re={course:"#22d3ee",module:"#facc15",lo:"#4ade80"},ae={course:"rgba(34,211,238,0.15)",module:"rgba(250,204,21,0.12)",lo:"rgba(74,222,128,0.08)"},G=200,K=40,ce=260,le=52;function de(j,P){const{nodes:v,links:O}=P;if(v.length===0)return;const D={course:0,module:1,lo:2},C={course:0,module:0,lo:0},w=new Map;for(const a of v){const y=D[a.type],m=C[a.type]++,u=y*ce+40,N=m*le+40;w.set(a.id,{x:u,y:N})}const h=j.getCurrentPageShapes().filter(a=>String(a.id).includes("mind-")).map(a=>a.id);h.length>0&&j.deleteShapes(h);const R=v.map(a=>Y(`mind-${a.id}`));j.createShapes(v.map((a,y)=>{const m=w.get(a.id);return{id:R[y],type:"note",x:m.x,y:m.y,props:{text:a.name}}}));const x=[];O.forEach((a,y)=>{const m=w.get(a.source),u=w.get(a.target);if(!m||!u)return;const N=m.x+G/2,L=m.y+K/2,I=u.x+G/2,i=u.y+K/2,M=Math.min(N,I)-20,S=Math.min(L,i)-20;x.push({id:Y(`mind-arrow-${y}`),type:"arrow",x:M,y:S,props:{start:{x:N-M,y:L-S},end:{x:I-M,y:i-S}}})}),x.length>0&&j.createShapes(x)}function ge(){const j=c.useRef(null),P=c.useRef(null),v=c.useRef(!1),[O,D]=c.useState(null),[C,w]=c.useState(new Set),[h,R]=c.useState(new Set),[x,a]=c.useState(!0),[y,m]=c.useState(null),[u,N]=c.useState("force"),L=c.useMemo(()=>ne(),[]),I=c.useRef(null),{data:i=[]}=W({queryKey:["courses"],queryFn:()=>q.courses.getActive()}),M=i.map(e=>e.id).sort(),{data:S=[]}=W({queryKey:["modules","all",M],queryFn:async()=>(await Promise.all(i.map(t=>q.modules.getByCourse(t.id)))).flat(),enabled:i.length>0}),{data:B=[]}=W({queryKey:["learningObjectives","all",M,x],queryFn:async()=>(await Promise.all(i.map(t=>q.learningObjectives.getByCourse(t.id)))).flat(),enabled:i.length>0&&x});c.useEffect(()=>{const e=j.current;if(!e)return;const t=()=>{const l=e.getBoundingClientRect();D({width:Math.max(1,Math.floor(l.width)-2),height:Math.max(1,Math.floor(l.height)-2)})};t();const n=new ResizeObserver(t);return n.observe(e),()=>n.disconnect()},[]),c.useEffect(()=>{i.length>0&&!v.current&&(v.current=!0,w(new Set(i.map(e=>e.id))))},[i]);const b=c.useMemo(()=>{const e=[],t=[],n=new Map;for(const o of S){const r=n.get(o.courseId)??[];r.push(o),n.set(o.courseId,r)}const l=new Map;for(const o of B){if(o.moduleId==null)continue;const r=l.get(o.moduleId)??[];r.push(o),l.set(o.moduleId,r)}for(const o of i){if(!C.has(o.id))continue;const r=`course-${o.id}`;e.push({id:r,name:o.name,type:"course"});const p=n.get(o.id)??[];for(const d of p){if(h.size>0&&!h.has(d.id))continue;const f=`module-${d.id}`;if(e.push({id:f,name:d.name,type:"module"}),t.push({source:r,target:f}),x){const E=l.get(d.id)??[];for(const g of E){const k=`lo-${g.id}`;e.push({id:k,name:`${g.loCode}: ${g.title}`,type:"lo"}),t.push({source:f,target:k})}}}}return{nodes:e,links:t}},[i,S,B,C,h,x]),U=e=>{w(t=>{const n=new Set(t);return n.has(e)?n.delete(e):n.add(e),n})},X=e=>{R(t=>{const n=new Set(t);return n.has(e)?n.delete(e):n.add(e),n})},Q=c.useCallback((e,t,n)=>{const l=re[e.type]||"#6366f1",o=ae[e.type]||"rgba(99,102,241,0.1)",r=y===e.id,p=e.x||0,d=e.y||0,f=e.type==="course"?14:e.type==="module"?11:9,E=Math.max(f/n,2);t.font=`${e.type==="course"?"bold ":""}${E}px monospace`;const g=e.type==="lo"?50:35,k=e.name.length>g?e.name.slice(0,g)+"...":e.name,$=t.measureText(k).width,z=8/n,F=5/n,_=$+z*2,H=E+F*2,ee=4/n;t.beginPath(),t.roundRect(p-_/2,d-H/2,_,H,ee),t.fillStyle=r?l:o,t.fill(),t.strokeStyle=r?"#ffffff":l,t.lineWidth=(e.type==="course"?2:1)/n,t.stroke(),t.textAlign="center",t.textBaseline="middle",t.fillStyle=r?"#000000":l,t.fillText(k,p,d)},[y]),J=c.useCallback((e,t,n,l)=>{const o=e.x||0,r=e.y||0,d=(e.type==="course"?60:e.type==="module"?45:30)/l;n.fillStyle=t,n.fillRect(o-d/2,r-d/2,d,d)},[]),Z=c.useCallback((e,t,n)=>{const l=e.source,o=e.target;if(!l||!o)return;const r=l.x||0,p=l.y||0,d=o.x||0,f=o.y||0,E=(r+d)/2,g=(p+f)/2,k=d-r,$=f-p,z=E-$*.15,F=g+k*.15;t.beginPath(),t.moveTo(r,p),t.quadraticCurveTo(z,F,d,f),t.strokeStyle="rgba(148, 163, 184, 0.25)",t.lineWidth=Math.max(1.5/n,.3),t.stroke()},[]),A=S.filter(e=>C.has(e.courseId));return s.jsxs("div",{className:"flex h-full",children:[s.jsx("div",{className:"w-[220px] shrink-0 border-r border-secondary/30 bg-black/60",children:s.jsx(te,{className:"h-full",children:s.jsxs("div",{className:"p-3 space-y-4",children:[s.jsxs("div",{children:[s.jsx("div",{className:"font-arcade text-[10px] text-primary mb-2",children:"COURSES"}),i.map(e=>s.jsxs("label",{className:"flex items-center gap-2 py-1 cursor-pointer",children:[s.jsx(T,{checked:C.has(e.id),onCheckedChange:()=>U(e.id),className:"border-cyan-500 data-[state=checked]:bg-cyan-500"}),s.jsx("span",{className:"font-terminal text-xs text-cyan-300",children:e.name})]},e.id))]}),A.length>0&&s.jsxs("div",{children:[s.jsx("div",{className:"font-arcade text-[10px] text-yellow-400 mb-2",children:"MODULES"}),s.jsxs("label",{className:"flex items-center gap-2 py-1 cursor-pointer mb-1",children:[s.jsx(T,{checked:h.size===0,onCheckedChange:()=>R(new Set),className:"border-yellow-500 data-[state=checked]:bg-yellow-500"}),s.jsx("span",{className:"font-terminal text-xs text-yellow-200",children:"All Modules"})]}),A.map(e=>s.jsxs("label",{className:"flex items-center gap-2 py-0.5 cursor-pointer",children:[s.jsx(T,{checked:h.size===0||h.has(e.id),onCheckedChange:()=>X(e.id),className:"border-yellow-500 data-[state=checked]:bg-yellow-500"}),s.jsx("span",{className:"font-terminal text-[10px] text-yellow-100 truncate",children:e.name})]},e.id))]}),s.jsx("div",{children:s.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[s.jsx(T,{checked:x,onCheckedChange:e=>a(!!e),className:"border-green-500 data-[state=checked]:bg-green-500"}),s.jsx("span",{className:"font-terminal text-xs text-green-300",children:"Show Learning Objectives"})]})}),s.jsxs("div",{className:"pt-2 border-t border-secondary/30 space-y-1",children:[s.jsx("div",{className:"font-arcade text-[10px] text-muted-foreground mb-1",children:"LEGEND"}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-3 h-3 rounded-sm border-2 border-cyan-400 bg-cyan-400/15"}),s.jsx("span",{className:"font-terminal text-[10px] text-cyan-300",children:"Course"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-3 h-3 rounded-sm border border-yellow-400 bg-yellow-400/12"}),s.jsx("span",{className:"font-terminal text-[10px] text-yellow-300",children:"Module"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-3 h-3 rounded-sm border border-green-400 bg-green-400/8"}),s.jsx("span",{className:"font-terminal text-[10px] text-green-300",children:"Learning Objective"})]})]}),s.jsxs("div",{className:"pt-2 border-t border-secondary/30 font-terminal text-[10px] text-muted-foreground",children:[s.jsxs("div",{children:["Nodes: ",b.nodes.length]}),s.jsxs("div",{children:["Links: ",b.links.length]})]})]})})}),s.jsxs("div",{className:"flex-1 flex flex-col min-h-0 bg-black/80",children:[s.jsxs("div",{className:"section-block flex items-center gap-2 px-2 py-1.5 border-b border-secondary/30 shrink-0",children:[s.jsx("span",{className:"font-arcade text-[10px] text-muted-foreground uppercase mr-1",children:"View"}),s.jsx("button",{type:"button",onClick:()=>N("force"),className:V("tab-sub-item text-xs",u==="force"&&"active"),children:"Force graph"}),s.jsx("button",{type:"button",onClick:()=>N("whiteboard"),className:V("tab-sub-item text-xs",u==="whiteboard"&&"active"),children:"Whiteboard"}),u==="whiteboard"&&s.jsx("button",{type:"button",onClick:()=>{const e=I.current;e&&b.nodes.length>0&&de(e,b)},className:"tab-sub-item text-xs ml-2",disabled:b.nodes.length===0,children:"Seed from selection"})]}),s.jsxs("div",{ref:j,className:"flex-1 relative overflow-hidden min-h-0",children:[u==="force"&&s.jsxs(s.Fragment,{children:[O&&b.nodes.length>0&&s.jsx(se,{ref:P,graphData:b,width:O.width,height:O.height,dagMode:"lr",dagLevelDistance:120,nodeCanvasObject:Q,nodePointerAreaPaint:J,linkCanvasObject:Z,onNodeHover:e=>m(e?.id??null),linkColor:()=>"transparent",linkWidth:0,backgroundColor:"transparent",cooldownTicks:100,d3AlphaDecay:.025,d3VelocityDecay:.35}),b.nodes.length===0&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center font-terminal text-xs text-muted-foreground",children:"Select courses to build mind map"})]}),u==="whiteboard"&&s.jsx("div",{className:"absolute inset-0",children:s.jsx(oe,{store:L,onMount:e=>{I.current=e,e.user.updateUserPreferences({colorScheme:"dark"})}})})]})]})]})}export{ge as MindMapView};
