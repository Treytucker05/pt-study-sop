import{c as W,j as e,b as ke,r as n,d as ye,X as Ce}from"./index-8rMNjECY.js";import{u as Z,p as w,S as ne,B as X,n as be,o as _e,m as we,L as Ee}from"./layout-BwacGF7r.js";import{B as E,C as se}from"./badge-CxLbmKmN.js";import{I as S,T as _,a as K,b as Y,P as J,c as ve,S as $e,d as de,e as me,M as Te,f as oe,g as ie,h as Ae,t as j}from"./MaterialUploader-CZdr6j12.js";import{C as te}from"./checkbox-Ce-Lp09F.js";import{L as ce}from"./loader-circle-BIBqvGsk.js";import{F as re}from"./file-text-BSz7Svei.js";import{D as Le,M as Oe,r as De,F as Me}from"./index-DcH5g2P5.js";import{L as Pe}from"./link-C8M0rGu7.js";import{Z as Re}from"./zap-BYKo_UuF.js";import{C as Ie}from"./index-Dg8-1gjW.js";import{S as Fe}from"./send-CbrGajIs.js";import{M as ue}from"./message-square-CVVu3JFO.js";import{C as xe}from"./clock-BzBHGgBX.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=[["path",{d:"M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z",key:"p7xjir"}]],Ue=W("cloud",qe);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=[["rect",{width:"20",height:"14",x:"2",y:"5",rx:"2",key:"ynyp8z"}],["line",{x1:"2",x2:"22",y1:"10",y2:"10",key:"1b3vmo"}]],Ne=W("credit-card",Ke);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=[["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M17 20v2",key:"1rnc9c"}],["path",{d:"M17 2v2",key:"11trls"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M2 17h2",key:"7oei6x"}],["path",{d:"M2 7h2",key:"asdhe0"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"M20 17h2",key:"1fpfkl"}],["path",{d:"M20 7h2",key:"1o8tra"}],["path",{d:"M7 20v2",key:"4gnj0m"}],["path",{d:"M7 2v2",key:"1i4yhu"}],["rect",{x:"4",y:"4",width:"16",height:"16",rx:"2",key:"1vbyd7"}],["rect",{x:"8",y:"8",width:"8",height:"8",rx:"1",key:"z9xiuo"}]],Qe=W("cpu",Ge);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ze=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]],Xe=W("globe",ze);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=[["path",{d:"M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z",key:"169xi5"}],["path",{d:"M15 5.764v15",key:"1pn4in"}],["path",{d:"M9 3.236v15",key:"1uimfh"}]],je=W("map",Ye);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]],Ve=W("square",Be);function H({className:l,...a}){return e.jsx("div",{className:ke("animate-pulse rounded-md bg-primary/10",l),...a})}const He={pdf:"PDF",docx:"DOC",pptx:"PPT",md:"MD",txt:"TXT"};function We({courseId:l,selectedMaterials:a,setSelectedMaterials:N}){const{data:p=[],isLoading:u}=Z({queryKey:["tutor-materials",l],queryFn:()=>w.tutor.getMaterials(l?{course_id:l}:void 0)}),$=c=>{N(a.includes(c)?a.filter(D=>D!==c):[...a,c])},y=()=>{a.length===p.length?N([]):N(p.map(c=>c.id))};return u?e.jsx("div",{className:"flex items-center justify-center py-3",children:e.jsx(ce,{className:`${S} animate-spin text-muted-foreground`})}):p.length===0?e.jsx("div",{className:`${_} text-center py-2`,children:"No materials uploaded yet"}):e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:`flex items-center gap-1.5 px-1 py-0.5 ${K} text-muted-foreground hover:text-foreground cursor-pointer border-b border-muted-foreground/10 pb-1`,children:[e.jsx(te,{checked:p.length>0&&a.length===p.length,onCheckedChange:y,className:"w-3 h-3"}),e.jsx("span",{children:"Select all"}),e.jsxs(E,{variant:"outline",className:`ml-auto ${Y} h-4 px-1`,children:[a.length,"/",p.length]})]}),p.map(c=>e.jsxs("label",{className:`flex items-center gap-1.5 px-1 py-0.5 ${K} text-muted-foreground hover:text-foreground cursor-pointer`,children:[e.jsx(te,{checked:a.includes(c.id),onCheckedChange:()=>$(c.id),className:"w-3 h-3"}),e.jsx(re,{className:`${S} text-primary/60 shrink-0`}),e.jsx("span",{className:"truncate flex-1",children:c.title}),e.jsx(E,{variant:"outline",className:`${Y} h-4 px-1 shrink-0`,children:He[c.file_type]||c.file_type.toUpperCase()})]},c.id))]})}const ee=[{value:"arcee-ai/trinity-large-preview:free",label:"Trinity Large (free)"},{value:"qwen/qwen3-coder-next",label:"Qwen3 Coder Next"},{value:"google/gemini-2.5-flash-lite",label:"Gemini 2.5 Flash Lite"}],Ze=[{value:"Core",label:"LEARN",desc:"Prime + encode"},{value:"Sprint",label:"REVIEW",desc:"Retrieve + refine"},{value:"Quick Sprint",label:"QUICK",desc:"Quick retrieval"},{value:"Light",label:"LIGHT",desc:"Low energy"},{value:"Drill",label:"FIX",desc:"Target weak spots"}],Je=["Teaching Sprint","Diagnostic Sprint"],pe={Core:"First Exposure (Core)",Sprint:"Review Sprint","Quick Sprint":"Quick Drill",Light:"Low Energy",Drill:"Mastery Review","Teaching Sprint":"First Exposure (Core)","Diagnostic Sprint":"Review Sprint"},he="tutor.autopick_chain.v1",fe="tutor.last_openrouter_model.v1",ge="tutor.last_codex_model.v1";function le(l){try{return localStorage.getItem(l)}catch{return null}}function ae(l,a){try{localStorage.setItem(l,a)}catch{}}function et(l,a){const N=le(l);return N===null?a:N==="true"}function B({children:l,icon:a}){return e.jsxs("div",{className:`${ie} flex items-center gap-1.5 pb-1 border-b border-primary/20 mb-2`,children:[a,l]})}function tt({courseId:l,setCourseId:a,selectedMaterials:N,setSelectedMaterials:p,mode:u,setMode:$,chainId:y,setChainId:c,topic:D,setTopic:b,model:m,setModel:x,webSearch:A,setWebSearch:q,onStartSession:L,isStarting:r,hasActiveSession:i}){const{data:h,isLoading:o,isError:v}=Z({queryKey:["tutor-content-sources"],queryFn:()=>w.tutor.getContentSources()}),{data:d=[],isLoading:I,isError:M}=Z({queryKey:["tutor-template-chains"],queryFn:()=>w.tutor.getTemplateChains()}),{data:F=[],isLoading:T}=Z({queryKey:["courses-active"],queryFn:()=>w.courses.getActive()}),O=h?.openrouter_enabled??!1,f=m.includes("/")?"openrouter":"codex";n.useEffect(()=>{!O&&f==="openrouter"&&x("codex")},[O,f,x]),n.useEffect(()=>{m&&(m.includes("/")?ae(fe,m):ae(ge,m))},[m]);const[P,G]=n.useState(()=>et(he,!0)),[U,R]=n.useState(null);n.useEffect(()=>{ae(he,String(P))},[P]);const Q=pe[u],k=n.useMemo(()=>{if(Q)return d.find(t=>t.name===Q)},[d,Q]);n.useEffect(()=>{P&&y===void 0&&k&&U!==u&&(c(k.id),R(u))},[P,y,k?.id,U,u,c]);const V=t=>{if($(t),!P||y!==void 0)return;const g=pe[t];if(!g)return;const z=d.find(Se=>Se.name===g);z&&(c(z.id),R(t))},C=()=>{const t=le(ge),g=t&&!t.includes("/")?t:"codex";x(g)},s=()=>{if(!O)return;const t=le(fe),g=t&&t.includes("/")?t:ee[0].value;x(g)};return n.useEffect(()=>{f==="openrouter"&&(ee.some(t=>t.value===m)||x(ee[0].value))},[f,m,x]),e.jsxs("div",{className:"flex flex-col h-full overflow-hidden",children:[e.jsxs("div",{className:`shrink-0 ${J} pb-2 border-b-2 border-primary/30`,children:[e.jsx("div",{className:ve,children:"CONTENT FILTER"}),(v||M)&&e.jsxs("div",{className:`${_} text-red-400`,children:["Tutor API unavailable. Start the dashboard via ",e.jsx("span",{className:"font-arcade",children:"Start_Dashboard.bat"}),"."]}),e.jsxs("div",{className:`flex items-center gap-2 mt-1 ${_}`,children:[e.jsx(Le,{className:S}),h?.total_materials??0," materials",e.jsx("span",{className:"text-muted-foreground/40",children:"|"}),h?.total_instructions??0," SOP"]})]}),e.jsx(ne,{className:"flex-1 min-h-0",children:e.jsxs("div",{className:`${J} ${$e}`,children:[e.jsxs("div",{children:[e.jsx(B,{children:"Mode"}),e.jsx("div",{className:"grid grid-cols-2 gap-1.5",children:Ze.map(t=>e.jsxs("button",{onClick:()=>V(t.value),className:`text-left px-2 py-1.5 border-2 transition-colors ${u===t.value?"border-primary bg-primary/20 text-primary":"border-muted-foreground/30 text-foreground/80 hover:border-muted-foreground/50 hover:text-foreground hover:bg-black/30"}`,children:[e.jsx("div",{className:"font-arcade text-sm leading-tight truncate",children:t.label}),e.jsx("div",{className:`${_} text-sm leading-tight truncate`,children:t.desc})]},t.value))}),e.jsx("div",{className:`${_} text-sm mt-2`,children:"Auto-picks a chain template. Override below."}),Je.includes(u)&&e.jsxs("div",{className:`${_} text-sm mt-1`,children:["Legacy mode active: ",u]})]}),e.jsxs("div",{children:[e.jsx(B,{icon:e.jsx(Pe,{className:S}),children:"Chain"}),e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-2",children:[e.jsxs("div",{className:`${_} text-sm min-w-0`,children:[e.jsx("span",{className:"opacity-70",children:"Recommended:"})," ",k?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-foreground truncate",children:k.name}),e.jsx(E,{variant:"outline",className:`ml-1.5 ${Y} h-4 px-1`,children:k.blocks.length})]}):I?e.jsx(H,{className:"inline-block w-20 h-4 bg-primary/10"}):e.jsx("span",{className:"opacity-70",children:"—"})]}),k&&y!==k.id&&e.jsx(X,{size:"sm",onClick:()=>c(k.id),className:"rounded-none h-7 px-3 font-arcade text-xs bg-primary text-primary-foreground hover:bg-primary/90",children:"APPLY"})]}),e.jsxs("label",{className:`flex items-center gap-2 ${K} text-muted-foreground mb-2 cursor-pointer`,children:[e.jsx(te,{checked:P,onCheckedChange:t=>G(t===!0),className:"w-3 h-3"}),e.jsx("span",{className:"select-none text-sm",children:"Auto-pick recommended chain"})]}),e.jsx(ne,{className:"h-48 border border-primary/20",children:e.jsxs("div",{className:"space-y-0.5 p-1",children:[e.jsx("button",{onClick:()=>{c(void 0),R(u)},className:`w-full text-left px-2 py-1 ${K} text-sm border-l-2 transition-colors ${y?"border-transparent text-foreground/80 hover:text-foreground hover:border-muted-foreground/40 hover:bg-black/30":"border-primary text-primary bg-primary/10"}`,children:"Freeform"}),I?e.jsxs("div",{className:"space-y-1 p-2",children:[e.jsx(H,{className:"w-full h-5 bg-primary/10"}),e.jsx(H,{className:"w-full h-5 bg-primary/10"}),e.jsx(H,{className:"w-full h-5 bg-primary/10"}),e.jsx(H,{className:"w-full h-5 bg-primary/10"})]}):d.map(t=>e.jsxs("button",{onClick:()=>c(t.id),className:`w-full text-left px-2 py-1 ${K} text-sm border-l-2 transition-colors ${y===t.id?"border-primary text-primary bg-primary/10":"border-transparent text-foreground/80 hover:text-foreground hover:border-muted-foreground/40 hover:bg-black/30"}`,children:[e.jsx("span",{className:"truncate",children:t.name}),e.jsx(E,{variant:"outline",className:`ml-1.5 ${Y} h-4 px-1`,children:t.blocks.length})]},t.id))]})})]}),e.jsxs("div",{children:[e.jsx(B,{children:"Topic"}),e.jsx("input",{value:D,onChange:t=>b(t.target.value),placeholder:"e.g. Hip Flexors",className:de})]}),e.jsxs("div",{children:[e.jsx(B,{children:"Model"}),e.jsxs("div",{className:"grid grid-cols-2 gap-1 mb-1",children:[e.jsxs("button",{onClick:C,className:`text-left px-2 py-1 border-2 transition-colors ${f==="codex"?"border-primary bg-primary/20 text-primary":"border-muted-foreground/30 text-foreground/80 hover:border-muted-foreground/50 hover:text-foreground hover:bg-black/30"}`,children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Qe,{className:S}),e.jsx("div",{className:"font-arcade text-xs leading-tight",children:"CODEX"})]}),e.jsx("div",{className:`${_} leading-tight`,children:"ChatGPT login"})]}),e.jsxs("button",{onClick:s,disabled:!O,className:`text-left px-2 py-1 border-2 transition-colors ${f==="openrouter"?"border-primary bg-primary/20 text-primary":"border-muted-foreground/30 text-foreground/80 hover:border-muted-foreground/50 hover:text-foreground hover:bg-black/30"} ${O?"":"opacity-50 cursor-not-allowed"}`,children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Ue,{className:S}),e.jsx("div",{className:"font-arcade text-xs leading-tight",children:"OPENROUTER"})]}),e.jsx("div",{className:`${_} leading-tight`,children:O?"API key enabled":"API key missing"})]})]}),f==="openrouter"?e.jsx("select",{value:m,onChange:t=>x(t.target.value),className:me,children:ee.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))}):e.jsx("input",{value:m==="codex"?"":m,onChange:t=>x(t.target.value.trim()?t.target.value:"codex"),placeholder:"Codex model override (optional)",className:de})]}),e.jsxs("label",{className:`flex items-center gap-2 cursor-pointer ${f!=="codex"?"opacity-50":""}`,children:[e.jsx(te,{checked:A,onCheckedChange:t=>f==="codex"&&q(!!t),disabled:f!=="codex"}),e.jsx(Xe,{className:S}),e.jsx("span",{className:`${K} text-sm`,children:"Web search"}),f!=="codex"&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"(Codex only)"})]}),e.jsxs("div",{children:[e.jsx(B,{children:"Course"}),T?e.jsx(H,{className:"w-full h-10 bg-primary/10"}):e.jsxs("select",{value:l??"",onChange:t=>a(t.target.value?Number(t.target.value):void 0),className:me,children:[e.jsx("option",{value:"",children:"All courses"}),F.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{children:[e.jsx(B,{icon:e.jsx(re,{className:S}),children:"Materials"}),e.jsx(We,{courseId:l,selectedMaterials:N,setSelectedMaterials:p})]}),e.jsxs("div",{className:"border-t border-primary/10 pt-2",children:[e.jsx(B,{children:"Upload"}),e.jsx(Te,{courseId:l})]})]})}),e.jsx("div",{className:`shrink-0 ${J} pt-2 border-t-2 border-primary/30`,children:e.jsxs(X,{onClick:L,disabled:r||i,className:`w-full rounded-none border-2 font-arcade text-sm h-10 ${i?"border-green-500/50 bg-green-500/10 text-green-400 cursor-default":r?"border-primary/50 bg-primary/10 text-primary cursor-wait":"border-primary bg-primary/10 hover:bg-primary/20"}`,children:[r?e.jsx(ce,{className:`${oe} animate-spin mr-1.5`}):i?e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-green-400 animate-pulse"}),"SESSION ACTIVE"]}):e.jsx(Re,{className:`${oe} mr-1.5`}),!r&&!i&&"START SESSION"]})})]})}function rt({sessionId:l,onArtifactCreated:a,onSessionEnd:N,chainBlocks:p=[],currentBlockIndex:u=0,onAdvanceBlock:$}){const y=p.length>0,c=y&&u>=p.length,[D,b]=n.useState([]),[m,x]=n.useState(""),[A,q]=n.useState(!1),L=n.useRef(null),r=n.useRef(null);n.useEffect(()=>{L.current&&(L.current.scrollTop=L.current.scrollHeight)},[D]),n.useEffect(()=>{r.current?.focus()},[l]);const i=n.useCallback(async()=>{if(!m.trim()||!l||A)return;const o=m.trim();x("");const v=/^\/(note|save)\b/i.test(o),d=/^\/(card|flashcard)\b/i.test(o),I=/^\/(map|diagram)\b/i.test(o);b(M=>[...M,{role:"user",content:o}]),b(M=>[...M,{role:"assistant",content:"",isStreaming:!0}]),q(!0);try{const F=(await fetch(`/api/tutor/session/${l}/turn`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:o})})).body?.getReader(),T=new TextDecoder;if(!F)throw new Error("No response body");let O="",f="",P=[],G;for(;;){const{done:U,value:R}=await F.read();if(U)break;O+=T.decode(R,{stream:!0});const Q=O.split(`
`);O=Q.pop()??"";for(const k of Q){if(!k.startsWith("data: "))continue;const V=k.slice(6);if(V==="[DONE]")break;try{const C=JSON.parse(V);if(C.type==="error"){b(s=>{const t=[...s];return t[t.length-1]={role:"assistant",content:`Error: ${C.content}`},t}),q(!1);return}C.type==="web_search_searching"&&b(s=>{const t=[...s];return t[t.length-1]={...t[t.length-1],content:`Searching the web...

`,isStreaming:!0},t}),C.type==="web_search_completed"&&(f="",b(s=>{const t=[...s];return t[t.length-1]={...t[t.length-1],content:"",isStreaming:!0},t})),C.type==="token"&&C.content&&(f+=C.content,b(s=>{const t=[...s],g=t[t.length-1];return t[t.length-1]={...g,content:g.content+C.content,isStreaming:!0},t})),C.type==="done"&&(P=C.citations??[],G=C.model)}catch{}}}b(U=>{const R=[...U];return R[R.length-1]={role:"assistant",content:f,citations:P,model:G,isStreaming:!1},R}),(v||d||I)&&a({type:v?"note":d?"card":"map",content:f,title:o.replace(/^\/(note|card|flashcard|map|diagram|save)\s*/i,"").trim()})}catch(M){b(F=>{const T=[...F];return T[T.length-1]={role:"assistant",content:`Connection error: ${M instanceof Error?M.message:"Unknown"}`},T})}finally{q(!1)}},[m,l,A,a]),h=o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),i())};return l?e.jsxs("div",{className:"flex flex-col h-full",children:[y&&e.jsxs("div",{className:"shrink-0 px-3 py-2 border-b-2 border-primary/30 bg-black/40",children:[e.jsxs("div",{className:"flex items-center gap-1 overflow-x-auto",children:[p.map((o,v)=>{const d=v<u,I=v===u&&!c;return e.jsxs("div",{className:"flex items-center shrink-0",children:[v>0&&e.jsx(Ie,{className:"w-4 h-4 text-muted-foreground/40 mx-0.5"}),e.jsxs("div",{className:`px-2 py-1 border-2 text-base font-terminal flex items-center gap-1 ${I?"border-primary bg-primary/20 text-primary":d?"border-primary/30 bg-primary/5 text-muted-foreground/70 line-through":"border-primary/20 text-muted-foreground/50"}`,children:[d&&e.jsx(be,{className:"w-4 h-4"}),o.name]})]},o.id)}),!c&&$&&e.jsx("button",{onClick:$,className:"shrink-0 ml-2 px-3 py-1 border-2 border-primary/60 text-xs font-arcade text-primary hover:bg-primary/20 transition-colors",children:"NEXT"}),c&&e.jsx("span",{className:"shrink-0 ml-2 px-3 py-1 text-xs font-arcade text-green-400 border-2 border-green-400/50",children:"COMPLETE"})]}),!c&&p[u]&&e.jsxs("div",{className:"mt-1 text-base font-terminal text-muted-foreground",children:[e.jsx("span",{className:"text-primary",children:p[u].category.toUpperCase()})," ","· ~",p[u].duration,"min"]})]}),e.jsxs("div",{ref:L,className:"flex-1 overflow-y-auto p-3 space-y-3",children:[D.length===0&&e.jsxs("div",{className:"text-center py-8 space-y-2",children:[e.jsx("div",{className:"font-arcade text-sm text-primary",children:"SESSION STARTED"}),e.jsx("div",{className:"font-terminal text-lg text-muted-foreground",children:"Ask a question to begin learning. Use /note, /card, or /map for artifacts."})]}),D.map((o,v)=>e.jsx("div",{className:`flex ${o.role==="user"?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[85%] px-3 py-2 text-lg font-terminal ${o.role==="user"?"bg-primary/20 border-2 border-primary/50 text-foreground":"bg-black/40 border-2 border-primary/20 text-foreground"}`,children:[o.role==="assistant"?e.jsxs("div",{className:"prose prose-invert prose-lg max-w-none font-terminal [&_p]:my-2 [&_li]:my-1 [&_code]:text-base [&_pre]:text-base",children:[e.jsx(Oe,{remarkPlugins:[De],children:o.content||(o.isStreaming?"...":"")}),o.isStreaming&&e.jsx("span",{className:"inline-block w-2 h-3 bg-primary animate-pulse ml-0.5"})]}):e.jsx("div",{children:o.content}),(o.citations?.length||o.model)&&!o.isStreaming?e.jsxs("div",{className:"flex flex-wrap items-center gap-1 mt-2 pt-2 border-t border-primary/20",children:[o.citations?.map(d=>d.url?e.jsx("a",{href:d.url,target:"_blank",rel:"noopener noreferrer",children:e.jsxs(E,{variant:"outline",className:"text-sm rounded-none cursor-pointer hover:bg-primary/10",children:["[",d.index,"] ",d.source]})},d.index):e.jsxs(E,{variant:"outline",className:"text-sm rounded-none",children:["[",d.index,"] ",d.source]},d.index)),o.model&&e.jsx(E,{variant:"outline",className:"text-sm rounded-none text-muted-foreground/60 ml-auto",children:o.model})]}):null]})},v))]}),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-t border-primary/20",children:[e.jsx("span",{className:"text-base font-terminal text-muted-foreground/60",children:"Commands:"}),e.jsxs(E,{variant:"outline",className:"text-sm rounded-none cursor-pointer hover:bg-primary/10",onClick:()=>x("/note "),children:[e.jsx(re,{className:"w-4 h-4 mr-1"}),"/note"]}),e.jsxs(E,{variant:"outline",className:"text-sm rounded-none cursor-pointer hover:bg-primary/10",onClick:()=>x("/card "),children:[e.jsx(Ne,{className:"w-4 h-4 mr-1"}),"/card"]}),e.jsxs(E,{variant:"outline",className:"text-sm rounded-none cursor-pointer hover:bg-primary/10",onClick:()=>x("/map "),children:[e.jsx(je,{className:"w-4 h-4 mr-1"}),"/map"]}),e.jsx("div",{className:"flex-1"}),e.jsxs(X,{variant:"ghost",size:"sm",onClick:N,className:"text-sm font-terminal text-destructive hover:text-destructive h-8 px-3",children:[e.jsx(Ve,{className:"w-4 h-4 mr-1"}),"END"]})]}),e.jsxs("div",{className:"flex items-center gap-2 p-3 border-t-2 border-primary/20",children:[e.jsx("input",{ref:r,value:m,onChange:o=>x(o.target.value),onKeyDown:h,placeholder:"Ask a question...",disabled:A,className:"flex-1 bg-black/60 border-2 border-primary/40 rounded-none px-3 py-2 text-lg font-terminal text-foreground placeholder:text-muted-foreground/50 focus:border-primary focus:outline-none disabled:opacity-50"}),e.jsx(X,{onClick:i,disabled:!m.trim()||A,className:"rounded-none border-2 border-primary h-11 w-11 p-0",children:A?e.jsx(ce,{className:"w-5 h-5 animate-spin"}):e.jsx(Fe,{className:"w-5 h-5"})})]})]}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("div",{className:"font-arcade text-sm text-muted-foreground",children:"NO ACTIVE SESSION"}),e.jsx("div",{className:"font-terminal text-lg text-muted-foreground/70",children:"Configure content filter and start a session"})]})})}const st={note:re,card:Ne,map:je},at={note:"text-blue-400",card:"text-yellow-400",map:"text-green-400"};function nt({sessionId:l,artifacts:a,turnCount:N,mode:p,topic:u,startedAt:$,recentSessions:y,onResumeSession:c}){const D=ye(),[b,m]=n.useState(null),[x,A]=n.useState(null),q=async r=>{try{await w.tutor.deleteSession(r),j.success("Session deleted"),D.invalidateQueries({queryKey:["tutor-sessions"]}),m(null)}catch(i){j.error(`Delete failed: ${i instanceof Error?i.message:"Unknown"}`)}},L=async r=>{A(r.session_id);try{const i=await w.tutor.getSession(r.session_id);if(!i.turns||i.turns.length===0){j.error("No turns to save");return}const h=[`# Tutor: ${r.topic||r.mode}`,`**Date:** ${new Date(r.started_at).toLocaleDateString()}`,`**Mode:** ${r.mode} | **Turns:** ${r.turn_count}`,"","---",""];for(const d of i.turns)h.push(`## Q${d.turn_number}`),h.push(d.question),h.push(""),d.answer&&(h.push("**Answer:**"),h.push(d.answer),h.push(""));const v=`Study Sessions/${`Tutor - ${(r.topic||r.mode).replace(/[^a-zA-Z0-9 ]/g,"").trim()}`}.md`;await w.obsidian.append(v,h.join(`
`)),j.success(`Saved to Obsidian: ${v}`)}catch(i){j.error(`Save failed: ${i instanceof Error?i.message:"Unknown"}`)}finally{A(null)}};return e.jsxs("div",{className:"flex flex-col h-full overflow-hidden",children:[e.jsx("div",{className:`shrink-0 ${J} pb-2 border-b-2 border-secondary/30`,children:e.jsx("div",{className:ve,children:"ARTIFACTS"})}),e.jsx(ne,{className:"flex-1 min-h-0",children:e.jsxs("div",{className:`${J} space-y-3`,children:[l?e.jsxs("div",{className:"space-y-2 pb-3 border-b border-muted-foreground/20",children:[e.jsxs("div",{className:"flex items-center gap-1.5 flex-wrap",children:[e.jsx(E,{variant:"outline",className:`${Y} h-5 px-1.5`,children:p}),e.jsx(E,{variant:"outline",className:`${Y} h-5 px-1.5 text-primary`,children:"FIRST PASS"})]}),u&&e.jsx("div",{className:`${K} text-sm`,children:u}),e.jsxs("div",{className:`flex items-center gap-3 ${_}`,children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ue,{className:S}),N," turns"]}),$&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(xe,{className:S}),new Date($).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]})]}):e.jsx("div",{className:`${K} text-muted-foreground/50 py-3 text-center`,children:"No active session"}),a.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:ie,children:"Artifacts"}),a.map((r,i)=>{const h=st[r.type],o=at[r.type];return e.jsxs("div",{className:"border-2 border-muted-foreground/20 p-2.5 hover:border-primary/30 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(h,{className:`${oe} ${o}`}),e.jsx("span",{className:`${K} text-sm truncate flex-1`,children:r.title||`${r.type} #${i+1}`})]}),r.content&&e.jsx("div",{className:`${_} mt-1 line-clamp-2`,children:r.content.slice(0,100)})]},i)})]}),l&&a.length===0&&e.jsxs("div",{className:"text-center space-y-1 py-4",children:[e.jsx(_e,{className:`${Ae} text-muted-foreground/30 mx-auto`}),e.jsx("div",{className:`${_} text-muted-foreground/50`,children:"No artifacts yet"}),e.jsx("div",{className:`${_} text-muted-foreground/30`,children:"Use /note, /card, or /map"})]}),y.length>0&&e.jsxs("div",{className:"space-y-2 pt-2 border-t border-muted-foreground/20",children:[e.jsx("div",{className:ie,children:"Recent Sessions"}),y.slice(0,8).map(r=>e.jsxs("div",{className:"border-2 border-muted-foreground/10 hover:border-muted-foreground/30 transition-colors",children:[e.jsxs("button",{onClick:()=>c(r.session_id),className:"w-full text-left px-3 py-2.5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{variant:"outline",className:`${Y} h-5 px-1.5 shrink-0 ${r.status==="active"?"text-green-400 border-green-400/50":"text-muted-foreground"}`,children:r.status==="active"?"LIVE":"DONE"}),e.jsx("span",{className:"font-terminal text-sm truncate flex-1",children:r.topic||r.mode})]}),e.jsxs("div",{className:`flex items-center gap-2 mt-1.5 ${_}`,children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ue,{className:S}),r.turn_count]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(xe,{className:S}),new Date(r.started_at).toLocaleDateString()]}),e.jsx(E,{variant:"outline",className:`${Y} h-4 px-1 ml-auto`,children:r.mode})]})]}),e.jsxs("div",{className:"flex items-center border-t border-primary/20 px-2 py-1",children:[e.jsxs(X,{variant:"ghost",size:"sm",className:"h-8 px-3 rounded-none text-muted-foreground hover:text-primary font-terminal text-sm",disabled:x===r.session_id,onClick:i=>{i.stopPropagation(),L(r)},children:[e.jsx(Me,{className:`${S} mr-1`}),x===r.session_id?"SAVING...":"SAVE"]}),e.jsx("div",{className:"ml-auto",children:b===r.session_id?e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("span",{className:"font-terminal text-sm text-red-400 mr-1",children:"Delete?"}),e.jsx(X,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 rounded-none text-red-400 hover:text-red-300 hover:bg-red-400/10",onClick:i=>{i.stopPropagation(),q(r.session_id)},children:e.jsx(be,{className:S})}),e.jsx(X,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 rounded-none text-muted-foreground hover:text-foreground",onClick:i=>{i.stopPropagation(),m(null)},children:e.jsx(Ce,{className:S})})]}):e.jsx(X,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 rounded-none text-muted-foreground hover:text-red-400",onClick:i=>{i.stopPropagation(),m(r.session_id)},children:e.jsx(we,{className:S})})})]})]},r.session_id))]})]})})]})}function vt(){const l=ye(),[a,N]=n.useState(null),[p,u]=n.useState(!1),[$,y]=n.useState(),[c,D]=n.useState([]),[b,m]=n.useState("Core"),[x,A]=n.useState(),[q,L]=n.useState(0),[r,i]=n.useState([]),[h,o]=n.useState(""),[v,d]=n.useState("codex"),[I,M]=n.useState(!1),[F,T]=n.useState([]),[O,f]=n.useState(0),[P,G]=n.useState(null),{data:U=[]}=Z({queryKey:["tutor-sessions"],queryFn:()=>w.tutor.listSessions({limit:10})}),R=n.useCallback(async()=>{u(!0);try{const s=await w.tutor.createSession({course_id:$,phase:"first_pass",mode:b,topic:h||void 0,content_filter:{...c.length>0?{material_ids:c}:{},model:v,...I?{web_search:!0}:{}},method_chain_id:x});if(N(s.session_id),G(s.started_at),T([]),f(0),L(s.current_block_index??0),x){const t=await w.tutor.getSession(s.session_id);t.chain_blocks&&i(t.chain_blocks.map(g=>({id:g.id,name:g.name,category:g.category,duration:g.default_duration_min})))}else i([]);j.success("Tutor session started"),l.invalidateQueries({queryKey:["tutor-sessions"]})}catch(s){j.error(`Failed to start session: ${s instanceof Error?s.message:"Unknown"}`)}finally{u(!1)}},[$,b,h,c,v,I,x,l]),Q=n.useCallback(async()=>{if(a)try{await w.tutor.endSession(a),j.success("Session ended"),N(null),T([]),f(0),G(null),L(0),i([]),l.invalidateQueries({queryKey:["tutor-sessions"]})}catch(s){j.error(`Failed to end session: ${s instanceof Error?s.message:"Unknown"}`)}},[a,l]),k=n.useCallback(async s=>{if(a)try{const t=await w.tutor.createArtifact(a,{type:s.type,content:s.content,title:s.title}),g={type:s.type,title:s.title||`${s.type} #${F.length+1}`,content:s.content.slice(0,200),createdAt:new Date().toISOString(),cardId:t.card_id};T(z=>[...z,g]),j.success(`${s.type.charAt(0).toUpperCase()+s.type.slice(1)} created`)}catch(t){j.error(`Failed to create artifact: ${t instanceof Error?t.message:"Unknown"}`)}},[a,F.length]),V=n.useCallback(async()=>{if(a)try{const s=await w.tutor.advanceBlock(a);L(s.block_index),s.complete?j.success("Chain complete!"):j.success(`Advanced to: ${s.block_name}`)}catch(s){j.error(`Failed to advance block: ${s instanceof Error?s.message:"Unknown"}`)}},[a]),C=n.useCallback(async s=>{try{const t=await w.tutor.getSession(s);if(N(t.session_id),f(t.turn_count),G(t.started_at),m(t.mode),o(t.topic||""),y(t.course_id??void 0),t.artifacts_json)try{const g=JSON.parse(t.artifacts_json);Array.isArray(g)&&T(g.map(z=>({type:z.type,title:z.title,content:"",createdAt:z.created_at})))}catch{T([])}j.success("Session resumed")}catch(t){j.error(`Failed to resume session: ${t instanceof Error?t.message:"Unknown"}`)}},[]);return e.jsx(Ee,{children:e.jsxs("div",{className:"h-[calc(100vh-140px)] flex gap-2",children:[e.jsx(se,{className:"w-72 shrink-0 bg-black/40 border-2 border-primary rounded-none overflow-hidden",children:e.jsx(tt,{courseId:$,setCourseId:y,selectedMaterials:c,setSelectedMaterials:D,mode:b,setMode:m,chainId:x,setChainId:A,topic:h,setTopic:o,model:v,setModel:d,webSearch:I,setWebSearch:M,onStartSession:R,isStarting:p,hasActiveSession:!!a})}),e.jsx(se,{className:"flex-1 bg-black/60 border-2 border-primary rounded-none flex flex-col min-w-0",children:e.jsx(rt,{sessionId:a,onArtifactCreated:k,onSessionEnd:Q,chainBlocks:r,currentBlockIndex:q,onAdvanceBlock:V})}),e.jsx(se,{className:"w-72 shrink-0 bg-black/40 border-2 border-primary/40 rounded-none overflow-y-auto",children:e.jsx(nt,{sessionId:a,artifacts:F,turnCount:O,mode:b,topic:h,startedAt:P,onCreateArtifact:k,recentSessions:U,onResumeSession:C})})]})})}export{vt as default};
