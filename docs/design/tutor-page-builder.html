<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Arcade Page Builder â€” Flow Layout</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  :root {
    --primary: #ef4444;
    --primary-dim: rgba(239,68,68,0.3);
    --primary-bg: rgba(239,68,68,0.08);
    --bg: #0a0a0a;
    --surface: rgba(0,0,0,0.7);
    --border: rgba(239,68,68,0.4);
    --text: #e5e5e5;
    --muted: #737373;
    --yellow: #eab308;
    --blue: #60a5fa;
    --green: #4ade80;
    --font-arcade: 'Courier New', monospace;
    --font-terminal: 'Consolas', 'Courier New', monospace;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-terminal);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    user-select: none;
  }

  /* â•â•â• TOOLBAR â•â•â• */
  .toolbar {
    height: 40px;
    background: #111;
    border-bottom: 2px solid var(--primary);
    display: flex;
    align-items: center;
    padding: 0 10px;
    gap: 8px;
    flex-shrink: 0;
    z-index: 100;
  }
  .toolbar h1 {
    font-family: var(--font-arcade);
    font-size: 12px;
    color: var(--primary);
    letter-spacing: 2px;
    white-space: nowrap;
  }
  .sep { width: 1px; height: 18px; background: var(--primary-dim); }
  .tb-btn {
    background: transparent;
    border: 1px solid var(--primary-dim);
    color: var(--text);
    font-family: var(--font-arcade);
    font-size: 10px;
    padding: 4px 10px;
    cursor: pointer;
    letter-spacing: 1px;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .tb-btn:hover { background: var(--primary-bg); border-color: var(--primary); color: var(--primary); }
  .tb-copy {
    margin-left: auto;
    background: var(--primary);
    color: #000;
    border: none;
    font-family: var(--font-arcade);
    font-size: 10px;
    padding: 5px 14px;
    cursor: pointer;
    letter-spacing: 1px;
    font-weight: bold;
  }
  .tb-copy:hover { filter: brightness(1.2); }

  /* â•â•â• MAIN â•â•â• */
  .main {
    flex: 1;
    display: flex;
    min-height: 0;
  }

  /* â•â•â• PALETTE â•â•â• */
  .palette {
    width: 200px;
    background: #0d0d0d;
    border-right: 2px solid var(--primary-dim);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    overflow: hidden;
  }
  .palette-header {
    padding: 8px 10px;
    font-family: var(--font-arcade);
    font-size: 10px;
    color: var(--primary);
    letter-spacing: 2px;
    border-bottom: 1px solid var(--primary-dim);
  }
  .palette-scroll {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
  }
  .palette-scroll::-webkit-scrollbar { width: 4px; }
  .palette-scroll::-webkit-scrollbar-thumb { background: var(--primary-dim); }

  .pal-section-header {
    padding: 6px 10px;
    font-family: var(--font-arcade);
    font-size: 9px;
    color: var(--muted);
    letter-spacing: 2px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    border-bottom: 1px solid rgba(239,68,68,0.08);
  }
  .pal-section-header:hover { color: var(--primary); }
  .pal-section-body { padding: 4px 8px 8px; display: flex; flex-direction: column; gap: 3px; }
  .pal-section-body.closed { display: none; }

  .pal-item {
    padding: 5px 8px;
    background: rgba(0,0,0,0.4);
    border: 1px solid rgba(255,255,255,0.05);
    cursor: grab;
    font-size: 10px;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: border-color 0.12s;
  }
  .pal-item:hover { border-color: var(--primary-dim); background: rgba(239,68,68,0.04); }
  .pal-item:active { cursor: grabbing; }
  .pal-item .icon { font-size: 12px; width: 16px; text-align: center; flex-shrink: 0; }
  .pal-item .label { font-size: 10px; }

  /* â•â•â• CANVAS â•â•â• */
  .canvas {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 12px;
    gap: 0;
    overflow: hidden;
    position: relative;
    background:
      repeating-linear-gradient(0deg, transparent, transparent 7px, rgba(239,68,68,0.025) 8px),
      repeating-linear-gradient(90deg, transparent, transparent 7px, rgba(239,68,68,0.025) 8px);
  }

  /* â•â•â• SECTION â•â•â• */
  .section {
    border: 2px solid var(--primary);
    background: var(--surface);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-height: 36px;
    position: relative;
    transition: opacity 0.15s;
  }
  .section.drag-over-above { border-top: 3px solid var(--green); }
  .section.drag-over-below { border-bottom: 3px solid var(--green); }
  .section.dragging { opacity: 0.4; }
  .section.selected { box-shadow: 0 0 0 2px rgba(239,68,68,0.5), 0 0 12px rgba(239,68,68,0.15); z-index: 10; }

  .section-header {
    display: flex;
    align-items: center;
    padding: 3px 8px;
    background: rgba(239,68,68,0.1);
    border-bottom: 1px solid var(--primary-dim);
    cursor: grab;
    min-height: 26px;
    gap: 8px;
    flex-shrink: 0;
  }
  .section-header:active { cursor: grabbing; }
  .section-header .grip {
    color: var(--muted);
    font-size: 11px;
    letter-spacing: 2px;
    flex-shrink: 0;
  }
  .section-header .title {
    font-family: var(--font-arcade);
    font-size: 10px;
    color: var(--primary);
    letter-spacing: 2px;
    flex-shrink: 0;
  }
  .section-header .dims {
    font-size: 9px;
    color: var(--muted);
    margin-left: auto;
    flex-shrink: 0;
  }
  .section-header .close-btn {
    width: 14px; height: 14px;
    display: flex; align-items: center; justify-content: center;
    font-size: 10px; color: var(--muted);
    cursor: pointer; border: none; background: none;
    opacity: 0; transition: opacity 0.15s;
  }
  .section-header:hover .close-btn { opacity: 1; }
  .section-header .close-btn:hover { color: var(--primary); }

  .section-body {
    flex: 1;
    display: flex;
    overflow: auto;
    min-height: 0;
    padding: 6px;
    gap: 4px;
  }
  .section-body.flow-v { flex-direction: column; }
  .section-body.flow-h { flex-direction: row; flex-wrap: wrap; align-items: center; }

  /* â•â•â• DIVIDER between sections â•â•â• */
  .divider {
    height: 6px;
    cursor: row-resize;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    position: relative;
    z-index: 5;
  }
  .divider::after {
    content: '';
    width: 40px;
    height: 2px;
    background: var(--primary-dim);
    border-radius: 1px;
    transition: background 0.15s, width 0.15s;
  }
  .divider:hover::after { background: var(--primary); width: 80px; }
  .divider.active::after { background: var(--green); width: 120px; }

  /* â•â•â• ITEMS inside sections â•â•â• */
  .item {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    cursor: grab;
    transition: outline 0.1s, opacity 0.15s;
    position: relative;
    flex-shrink: 0;
  }
  .item:active { cursor: grabbing; }
  .item.dragging { opacity: 0.3; }
  .item.drag-over-before { outline-left: 2px solid var(--green); }

  /* Drop indicator line */
  .drop-indicator {
    position: absolute;
    background: var(--green);
    z-index: 50;
    pointer-events: none;
    display: none;
    border-radius: 1px;
  }
  .drop-indicator.horizontal { height: 2px; left: 0; right: 0; }
  .drop-indicator.vertical { width: 2px; top: 0; bottom: 0; }

  /* â•â•â• COMPONENT STYLES â•â•â• */
  .c-btn-primary {
    padding: 4px 14px; font-family: var(--font-arcade); font-size: 10px;
    letter-spacing: 1px; background: var(--primary); border: 2px solid var(--primary);
    color: #000; font-weight: bold; white-space: nowrap;
  }
  .c-btn-ghost {
    padding: 4px 12px; font-family: var(--font-terminal); font-size: 11px;
    background: transparent; border: 1px solid var(--primary-dim); color: var(--text); white-space: nowrap;
  }
  .c-btn-outline {
    padding: 4px 12px; font-family: var(--font-arcade); font-size: 10px;
    letter-spacing: 1px; background: transparent; border: 2px solid var(--primary);
    color: var(--primary); white-space: nowrap;
  }
  .c-input {
    padding: 4px 10px; font-family: var(--font-terminal); font-size: 11px;
    background: rgba(0,0,0,0.5); border: 1px solid var(--primary-dim);
    color: var(--muted); white-space: nowrap; min-width: 80px;
  }
  .c-select {
    padding: 4px 10px; font-family: var(--font-terminal); font-size: 11px;
    background: rgba(0,0,0,0.5); border: 1px solid var(--primary-dim);
    color: var(--text); white-space: nowrap;
  }
  .c-chip {
    padding: 3px 10px; font-family: var(--font-arcade); font-size: 9px;
    letter-spacing: 1px; border: 2px solid var(--primary-dim);
    background: rgba(0,0,0,0.5); color: rgba(239,68,68,0.8); white-space: nowrap;
  }
  .c-chip.on { background: var(--primary); color: #000; border-color: var(--primary); }
  .c-badge { padding: 1px 6px; font-family: var(--font-arcade); font-size: 9px; letter-spacing: 1px; border: 1px solid var(--primary-dim); color: var(--primary); }
  .c-badge.green { border-color: rgba(74,222,128,0.5); color: var(--green); }
  .c-badge.blue { border-color: rgba(96,165,250,0.5); color: var(--blue); }
  .c-toggle-group { display: inline-flex; }
  .c-toggle-btn {
    padding: 3px 10px; font-family: var(--font-terminal); font-size: 10px;
    border: 1px solid var(--primary-dim); background: rgba(0,0,0,0.5); color: var(--muted);
  }
  .c-toggle-btn.on { background: var(--primary-bg); color: var(--primary); border-color: var(--primary); }
  .c-check {
    display: inline-flex; align-items: center; gap: 5px;
    font-family: var(--font-terminal); font-size: 11px; color: var(--muted); white-space: nowrap;
  }
  .c-check .box {
    width: 13px; height: 13px; border: 1px solid var(--primary-dim);
    background: rgba(0,0,0,0.4); display: inline-flex; align-items: center; justify-content: center;
  }
  .c-label {
    font-family: var(--font-arcade); font-size: 10px; color: var(--primary);
    letter-spacing: 2px; white-space: nowrap;
  }
  .c-label-muted {
    font-family: var(--font-arcade); font-size: 9px; color: var(--muted);
    letter-spacing: 1px; white-space: nowrap;
  }
  .c-text { font-family: var(--font-terminal); font-size: 11px; color: var(--text); white-space: nowrap; }
  .c-text-muted { font-family: var(--font-terminal); font-size: 11px; color: var(--muted); white-space: nowrap; }
  .c-tree-folder {
    display: flex; align-items: center; gap: 4px; padding: 2px 0;
    font-family: var(--font-terminal); font-size: 11px; white-space: nowrap; width: 100%;
  }
  .c-tree-file {
    display: flex; align-items: center; gap: 4px; padding: 2px 0 2px 14px;
    font-family: var(--font-terminal); font-size: 11px; white-space: nowrap; width: 100%;
  }
  .c-tree-folder .box, .c-tree-file .box {
    width: 11px; height: 11px; border: 1px solid var(--primary-dim);
    background: rgba(0,0,0,0.4); flex-shrink: 0;
  }
  .c-session {
    display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px;
    border: 1px solid rgba(255,255,255,0.1);
    font-family: var(--font-terminal); font-size: 10px; color: var(--muted); white-space: nowrap;
  }
  .c-session .dot { width: 5px; height: 5px; border-radius: 50%; }
  .c-session .dot.green { background: var(--green); }
  .c-session .dot.gray { background: var(--muted); }
  .c-divider { height: 1px; background: var(--primary-dim); width: 100%; flex-shrink: 0; }

  /* â•â•â• GHOST â•â•â• */
  .drag-ghost {
    position: fixed;
    pointer-events: none;
    z-index: 10000;
    opacity: 0.85;
    background: rgba(239,68,68,0.12);
    border: 2px solid var(--primary);
    padding: 4px 10px;
    font-family: var(--font-terminal);
    font-size: 10px;
    color: var(--text);
    max-width: 300px;
    overflow: hidden;
    display: none;
  }

  /* â•â•â• INFO BAR â•â•â• */
  .info-bar {
    height: 32px;
    background: #111;
    border-top: 1px solid var(--primary-dim);
    display: flex;
    align-items: center;
    padding: 0 12px;
    gap: 16px;
    font-size: 10px;
    color: var(--muted);
    flex-shrink: 0;
    z-index: 100;
  }
  .info-bar .val { color: var(--primary); font-weight: bold; }

  /* â•â•â• PROMPT BAR â•â•â• */
  .prompt-bar {
    background: #111;
    border-top: 1px solid var(--primary-dim);
    padding: 6px 12px;
    display: none;
    font-size: 10px;
    gap: 8px;
    align-items: flex-start;
    flex-shrink: 0;
    max-height: 160px;
  }
  .prompt-bar.visible { display: flex; }
  .prompt-bar pre {
    flex: 1; white-space: pre-wrap; font-family: var(--font-terminal);
    font-size: 10px; max-height: 140px; overflow-y: auto;
  }
  .prompt-bar button {
    background: var(--primary-dim); border: none; color: var(--text);
    font-size: 9px; padding: 2px 8px; cursor: pointer; font-family: var(--font-arcade);
  }
</style>
</head>
<body>

<div class="toolbar">
  <h1>PAGE BUILDER</h1>
  <div class="sep"></div>
  <button class="tb-btn" onclick="loadPreset('tutor-setup')">TUTOR SETUP</button>
  <button class="tb-btn" onclick="loadPreset('tutor-chat')">TUTOR CHAT</button>
  <button class="tb-btn" onclick="loadPreset('blank')">BLANK</button>
  <div class="sep"></div>
  <button class="tb-btn" onclick="deleteSelected()">DELETE</button>
  <button class="tb-copy" onclick="copyLayout()">COPY LAYOUT</button>
</div>

<div class="main">
  <div class="palette">
    <div class="palette-header">SECTIONS</div>
    <div class="palette-scroll" id="paletteScroll"></div>
  </div>

  <div class="canvas" id="canvas"></div>
</div>

<div class="info-bar">
  <span>Canvas: <span class="val" id="infoCanvas">--</span></span>
  <span>Selected: <span class="val" id="infoSelected">none</span></span>
  <span>Size: <span class="val" id="infoSize">--</span></span>
  <span style="margin-left:auto;color:var(--muted)">Drag headers to reorder sections â€¢ Drag dividers to resize â€¢ Drag items to rearrange</span>
</div>

<div class="prompt-bar" id="promptBar">
  <pre id="promptText"></pre>
  <button onclick="document.getElementById('promptBar').classList.remove('visible')">CLOSE</button>
</div>

<div class="drag-ghost" id="dragGhost"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas = document.getElementById('canvas');
const ghost = document.getElementById('dragGhost');
let selectedId = null;
let sectionCounter = 0;
let sections = {}; // id â†’ { el, title, flexBasis }

let dragState = null; // { type: 'section'|'item'|'divider'|'palette', ... }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SECTION TEMPLATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SECTION_TEMPLATES = {
  vault: {
    title: 'VAULT FILES', flex: 1, flow: 'v',
    items: [
      { flow: 'h', children: [
        '<span class="c-chip on">EBP</span>',
        '<span class="c-chip">ExPhys</span>',
        '<span class="c-chip">MS1</span>',
        '<span class="c-chip">Neuro</span>',
        '<span class="c-chip">TI</span>',
        '<span class="c-input">ğŸ” Filter...</span>',
      ]},
      { flow: 'v', fill: true, children: [
        '<div class="c-tree-folder"><span class="box"></span><span style="color:var(--muted);font-size:9px">â–¼</span><span style="color:var(--yellow)">ğŸ“‚</span>Evidence Based Practice</div>',
        '<div class="c-tree-file"><span class="box"></span><span style="color:var(--blue)">ğŸ“„</span>Week 1 - Intro to EBP.md</div>',
        '<div class="c-tree-file"><span class="box"></span><span style="color:var(--blue)">ğŸ“„</span>Week 2 - PICO Framework.md</div>',
        '<div class="c-tree-file"><span class="box"></span><span style="color:var(--blue)">ğŸ“„</span>Week 3 - Study Designs.md</div>',
        '<div class="c-tree-folder"><span class="box"></span><span style="color:var(--muted);font-size:9px">â–¶</span><span style="color:var(--yellow)">ğŸ“</span>Exercise Physiology</div>',
        '<div class="c-tree-folder"><span class="box"></span><span style="color:var(--muted);font-size:9px">â–¶</span><span style="color:var(--yellow)">ğŸ“</span>Movement Science 1</div>',
        '<div class="c-tree-folder"><span class="box"></span><span style="color:var(--muted);font-size:9px">â–¼</span><span style="color:var(--yellow)">ğŸ“‚</span>Neuroscience</div>',
        '<div class="c-tree-file"><span class="box"></span><span style="color:var(--blue)">ğŸ“„</span>Cranial Nerves.md</div>',
        '<div class="c-tree-file"><span class="box"></span><span style="color:var(--blue)">ğŸ“„</span>Spinal Cord Anatomy.md</div>',
        '<div class="c-tree-folder"><span class="box"></span><span style="color:var(--muted);font-size:9px">â–¶</span><span style="color:var(--yellow)">ğŸ“</span>Therapeutic Intervention</div>',
      ]},
      { flow: 'h', children: [
        '<span class="c-text-muted">3 folders, 2 files</span>',
        '<span class="c-btn-ghost">âœ• CLEAR</span>',
      ]},
    ],
  },
  toolbar: {
    title: 'TOOLBAR', flex: 0, height: 48, flow: 'h',
    items: [
      '<span class="c-select">Mode: LEARN â–¾</span>',
      '<span class="c-select">Chain: First Exposure â–¾</span>',
      '<span class="c-input">Topic...</span>',
      '<span class="c-toggle-group"><span class="c-toggle-btn on">codex</span><span class="c-toggle-btn">OR</span></span>',
      '<span class="c-check"><span class="box"></span>Web</span>',
      '<span class="c-btn-primary">START</span>',
    ],
  },
  sessions: {
    title: 'RECENT SESSIONS', flex: 0, height: 40, flow: 'h',
    items: [
      '<span class="c-label-muted">RECENT:</span>',
      '<span class="c-session"><span class="dot green"></span>Core<span style="opacity:0.5">5t</span></span>',
      '<span class="c-session"><span class="dot gray"></span>EBP Sprint<span style="opacity:0.5">3t</span></span>',
      '<span class="c-session"><span class="dot gray"></span>Neuro Fix<span style="opacity:0.5">8t</span></span>',
      '<span class="c-session"><span class="dot gray"></span>MS1 Review<span style="opacity:0.5">2t</span></span>',
    ],
  },
  chat: {
    title: 'CHAT', flex: 1, flow: 'v',
    items: [
      { flow: 'v', fill: true, children: [
        '<div class="c-chat-user" style="padding:6px 10px;background:rgba(239,68,68,0.1);border:1px solid var(--primary-dim);font-size:11px;max-width:80%;align-self:flex-end">What is the PICO framework?</div>',
        '<div class="c-chat-ai" style="padding:6px 10px;background:rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.08);font-size:11px;max-width:80%;align-self:flex-start">PICO stands for Patient/Problem, Intervention, Comparison, and Outcome.</div>',
      ]},
      { flow: 'h', children: [
        '<span class="c-input" style="flex:1">Type your message...</span>',
        '<span class="c-btn-primary">SEND</span>',
      ]},
    ],
  },
  artifacts: {
    title: 'ARTIFACTS', flex: 0, width: '30%', flow: 'v',
    items: [
      '<div style="padding:4px 8px;border:1px solid var(--primary-dim);width:100%"><span class="c-badge blue">CARD</span> <span class="c-text" style="margin-left:4px">Brachial Plexus</span></div>',
      '<div style="padding:4px 8px;border:1px solid rgba(255,255,255,0.06);width:100%"><span class="c-badge">NOTE</span> <span class="c-text" style="margin-left:4px">Muscle Origins</span></div>',
      '<div style="padding:4px 8px;border:1px solid rgba(255,255,255,0.06);width:100%"><span class="c-badge green">MAP</span> <span class="c-text" style="margin-left:4px">Spinal Nerves</span></div>',
    ],
  },
  stats: {
    title: 'STATS', flex: 0, height: 70, flow: 'h',
    items: [
      '<span class="c-stat" style="display:inline-flex;flex-direction:column;align-items:center;gap:2px;padding:6px 12px;border:1px solid var(--primary-dim)"><span style="font-family:var(--font-arcade);font-size:16px;color:var(--primary)">42</span><span style="font-size:9px;color:var(--muted)">TURNS</span></span>',
      '<span class="c-stat" style="display:inline-flex;flex-direction:column;align-items:center;gap:2px;padding:6px 12px;border:1px solid var(--primary-dim)"><span style="font-family:var(--font-arcade);font-size:16px;color:var(--primary)">87%</span><span style="font-size:9px;color:var(--muted)">SCORE</span></span>',
      '<span class="c-stat" style="display:inline-flex;flex-direction:column;align-items:center;gap:2px;padding:6px 12px;border:1px solid var(--primary-dim)"><span style="font-family:var(--font-arcade);font-size:16px;color:var(--primary)">156</span><span style="font-size:9px;color:var(--muted)">CARDS</span></span>',
    ],
  },
  settings: {
    title: 'SETTINGS', flex: 0, width: '280px', flow: 'v',
    items: [
      '<span class="c-label">MODE</span>',
      '<span class="c-select" style="width:100%">Core â–¾</span>',
      '<span class="c-label">CHAIN</span>',
      '<span class="c-select" style="width:100%">First Exposure â–¾</span>',
      '<span class="c-label">MODEL</span>',
      '<span class="c-toggle-group"><span class="c-toggle-btn on">codex</span><span class="c-toggle-btn">OR</span></span>',
      '<span class="c-divider"></span>',
      '<span class="c-check"><span class="box"></span>Web Search</span>',
      '<span class="c-btn-primary" style="width:100%;text-align:center">START SESSION</span>',
    ],
  },
  empty: {
    title: 'PANEL', flex: 0, height: 120, flow: 'v',
    items: [],
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER PALETTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPalette() {
  const el = document.getElementById('paletteScroll');
  const list = [
    { id: 'vault', icon: 'ğŸ“', label: 'Vault Picker' },
    { id: 'toolbar', icon: 'ğŸ”§', label: 'Toolbar Strip' },
    { id: 'sessions', icon: 'ğŸ•', label: 'Session List' },
    { id: 'chat', icon: 'ğŸ’¬', label: 'Chat Window' },
    { id: 'artifacts', icon: 'ğŸ“‹', label: 'Artifacts Panel' },
    { id: 'stats', icon: 'ğŸ“Š', label: 'Stats Card' },
    { id: 'settings', icon: 'âš™', label: 'Settings Panel' },
    { id: 'empty', icon: 'â—»', label: 'Empty Panel' },
  ];

  const body = document.createElement('div');
  body.className = 'pal-section-body';

  list.forEach(item => {
    const row = document.createElement('div');
    row.className = 'pal-item';
    row.dataset.template = item.id;
    row.innerHTML = `<span class="icon">${item.icon}</span><span class="label">${item.label}</span>`;
    row.addEventListener('mousedown', startPaletteDrag);
    body.appendChild(row);
  });

  el.appendChild(body);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CREATE SECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function createSection(templateId, insertBefore) {
  const tmpl = SECTION_TEMPLATES[templateId];
  if (!tmpl) return null;

  const id = 's' + (++sectionCounter);
  const el = document.createElement('div');
  el.className = 'section';
  el.dataset.sectionId = id;

  // Flex sizing
  if (tmpl.flex > 0) {
    el.style.flex = tmpl.flex;
    el.style.minHeight = '60px';
  } else if (tmpl.height) {
    el.style.height = tmpl.height + 'px';
    el.style.flexShrink = '0';
  }

  // Header
  const header = document.createElement('div');
  header.className = 'section-header';
  header.innerHTML = `<span class="grip">â‹®â‹®</span><span class="title">${tmpl.title}</span><span class="dims">--</span><button class="close-btn" title="Delete">âœ•</button>`;
  header.querySelector('.close-btn').onclick = (e) => { e.stopPropagation(); removeSection(id); };
  el.appendChild(header);

  // Body
  const body = document.createElement('div');
  body.className = `section-body flow-${tmpl.flow}`;

  function addItems(container, items, flow) {
    items.forEach(item => {
      if (typeof item === 'string') {
        const wrapper = document.createElement('div');
        wrapper.className = 'item';
        wrapper.innerHTML = item;
        container.appendChild(wrapper);
      } else if (item.flow) {
        const sub = document.createElement('div');
        sub.className = 'section-body flow-' + item.flow;
        sub.style.padding = '0';
        sub.style.gap = '4px';
        if (item.fill) { sub.style.flex = '1'; sub.style.overflow = 'auto'; sub.style.minHeight = '0'; }
        addItems(sub, item.children, item.flow);
        container.appendChild(sub);
      }
    });
  }
  addItems(body, tmpl.items, tmpl.flow);
  el.appendChild(body);

  // Insert into canvas
  const divider = document.createElement('div');
  divider.className = 'divider';
  divider.dataset.sectionAbove = id;

  if (insertBefore && canvas.contains(insertBefore)) {
    canvas.insertBefore(el, insertBefore);
    canvas.insertBefore(divider, insertBefore);
  } else {
    // Add divider before section if there are existing sections
    const existing = canvas.querySelectorAll('.section');
    if (existing.length > 0) {
      canvas.appendChild(divider);
    }
    canvas.appendChild(el);
  }

  sections[id] = { el, title: tmpl.title, templateId };
  updateDims(id);
  return id;
}

function removeSection(id) {
  const sec = sections[id];
  if (!sec) return;

  // Remove adjacent divider
  const prev = sec.el.previousElementSibling;
  const next = sec.el.nextElementSibling;
  if (prev && prev.classList.contains('divider')) prev.remove();
  else if (next && next.classList.contains('divider')) next.remove();

  sec.el.remove();
  delete sections[id];
  if (selectedId === id) selectSection(null);
}

function deleteSelected() {
  if (selectedId) removeSection(selectedId);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DIMENSIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateAllDims() {
  Object.keys(sections).forEach(updateDims);
}

function updateDims(id) {
  const sec = sections[id];
  if (!sec) return;
  const rect = sec.el.getBoundingClientRect();
  const dims = sec.el.querySelector('.dims');
  if (dims) dims.textContent = `${Math.round(rect.width)}Ã—${Math.round(rect.height)}`;
}

function updateInfoBar() {
  const cr = canvas.getBoundingClientRect();
  document.getElementById('infoCanvas').textContent = `${Math.round(cr.width)}Ã—${Math.round(cr.height)}`;
  if (selectedId && sections[selectedId]) {
    const rect = sections[selectedId].el.getBoundingClientRect();
    document.getElementById('infoSelected').textContent = sections[selectedId].title;
    document.getElementById('infoSize').textContent =
      `${Math.round(rect.width)}Ã—${Math.round(rect.height)} (${((rect.width/cr.width)*100).toFixed(0)}%w Ã— ${((rect.height/cr.height)*100).toFixed(0)}%h)`;
  } else {
    document.getElementById('infoSelected').textContent = 'none';
    document.getElementById('infoSize').textContent = '--';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SELECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectSection(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('selected'));
  selectedId = id;
  if (id && sections[id]) sections[id].el.classList.add('selected');
  updateInfoBar();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DIVIDER DRAG (resize sections)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
canvas.addEventListener('mousedown', (e) => {
  // Divider drag
  const divider = e.target.closest('.divider');
  if (divider) {
    const above = divider.previousElementSibling;
    const below = divider.nextElementSibling;
    if (!above || !below) return;

    divider.classList.add('active');
    const aboveRect = above.getBoundingClientRect();
    const belowRect = below.getBoundingClientRect();

    dragState = {
      type: 'divider',
      divider,
      above,
      below,
      startY: e.clientY,
      aboveH: aboveRect.height,
      belowH: belowRect.height,
    };
    e.preventDefault();
    return;
  }

  // Section header drag (reorder)
  const header = e.target.closest('.section-header');
  if (header && !e.target.closest('.close-btn')) {
    const section = header.closest('.section');
    const id = section.dataset.sectionId;
    selectSection(id);

    dragState = {
      type: 'section',
      sectionId: id,
      el: section,
      startY: e.clientY,
      moved: false,
    };
    e.preventDefault();
    return;
  }

  // Item drag (reorder within/between sections)
  const item = e.target.closest('.item');
  if (item) {
    const section = item.closest('.section');
    if (section) selectSection(section.dataset.sectionId);

    dragState = {
      type: 'item',
      el: item,
      container: item.parentElement,
      startX: e.clientX,
      startY: e.clientY,
      moved: false,
    };
    e.preventDefault();
    return;
  }

  // Click on section body
  const section = e.target.closest('.section');
  if (section) selectSection(section.dataset.sectionId);
  else selectSection(null);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PALETTE DRAG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startPaletteDrag(e) {
  const template = e.currentTarget.dataset.template;
  ghost.textContent = e.currentTarget.querySelector('.label').textContent;
  ghost.style.display = 'block';
  ghost.style.left = (e.clientX + 10) + 'px';
  ghost.style.top = (e.clientY + 10) + 'px';

  dragState = {
    type: 'palette',
    template,
    startX: e.clientX,
    startY: e.clientY,
    moved: false,
  };
  e.preventDefault();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOUSEMOVE â€” all drag types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('mousemove', (e) => {
  if (!dragState) return;

  if (dragState.type === 'divider') {
    const dy = e.clientY - dragState.startY;
    const newAboveH = Math.max(36, dragState.aboveH + dy);
    const newBelowH = Math.max(36, dragState.belowH - dy);

    // Apply heights: convert flex sections to fixed during resize
    dragState.above.style.flex = 'none';
    dragState.above.style.height = newAboveH + 'px';
    dragState.below.style.flex = 'none';
    dragState.below.style.height = newBelowH + 'px';

    updateAllDims();
    updateInfoBar();
    return;
  }

  if (dragState.type === 'section') {
    const dy = e.clientY - dragState.startY;
    if (!dragState.moved && Math.abs(dy) > 6) {
      dragState.moved = true;
      dragState.el.classList.add('dragging');
      ghost.textContent = sections[dragState.sectionId].title;
      ghost.style.display = 'block';
    }
    if (dragState.moved) {
      ghost.style.left = (e.clientX + 10) + 'px';
      ghost.style.top = (e.clientY + 10) + 'px';

      // Show drop indicator on other sections
      document.querySelectorAll('.section').forEach(s => {
        s.classList.remove('drag-over-above', 'drag-over-below');
      });
      const allSections = [...canvas.querySelectorAll('.section')];
      for (const sec of allSections) {
        if (sec === dragState.el) continue;
        const rect = sec.getBoundingClientRect();
        const mid = rect.top + rect.height / 2;
        if (e.clientY < mid) {
          sec.classList.add('drag-over-above');
          break;
        } else if (e.clientY >= mid) {
          // Check if this is the last or if next section is farther
          const idx = allSections.indexOf(sec);
          const next = allSections[idx + 1];
          if (!next || next === dragState.el || e.clientY < next.getBoundingClientRect().top + next.getBoundingClientRect().height / 2) {
            sec.classList.add('drag-over-below');
            break;
          }
        }
      }
    }
    return;
  }

  if (dragState.type === 'item') {
    const dx = e.clientX - dragState.startX;
    const dy = e.clientY - dragState.startY;
    if (!dragState.moved && (Math.abs(dx) > 5 || Math.abs(dy) > 5)) {
      dragState.moved = true;
      dragState.el.classList.add('dragging');
    }
    if (dragState.moved) {
      // Find drop target
      const allItems = [...document.querySelectorAll('.item:not(.dragging)')];
      const allBodies = [...document.querySelectorAll('.section-body')];

      for (const item of allItems) {
        const rect = item.getBoundingClientRect();
        const parent = item.parentElement;
        const isVert = parent.classList.contains('flow-v');
        const mid = isVert ? rect.top + rect.height / 2 : rect.left + rect.width / 2;
        const pos = isVert ? e.clientY : e.clientX;

        if (pos < mid) {
          parent.insertBefore(dragState.el, item);
          break;
        } else if (item === allItems[allItems.length - 1] || !allItems[allItems.indexOf(item) + 1] || allItems[allItems.indexOf(item) + 1].parentElement !== parent) {
          if (item.nextSibling) parent.insertBefore(dragState.el, item.nextSibling);
          else parent.appendChild(dragState.el);
        }
      }
    }
    return;
  }

  if (dragState.type === 'palette') {
    ghost.style.left = (e.clientX + 10) + 'px';
    ghost.style.top = (e.clientY + 10) + 'px';
    if (!dragState.moved) {
      const dx = e.clientX - dragState.startX;
      const dy = e.clientY - dragState.startY;
      if (Math.abs(dx) > 5 || Math.abs(dy) > 5) dragState.moved = true;
    }
    if (dragState.moved) {
      // Show drop indicators on sections
      document.querySelectorAll('.section').forEach(s => {
        s.classList.remove('drag-over-above', 'drag-over-below');
      });
      const allSections = [...canvas.querySelectorAll('.section')];
      if (allSections.length === 0) return;

      for (const sec of allSections) {
        const rect = sec.getBoundingClientRect();
        const mid = rect.top + rect.height / 2;
        if (e.clientY < mid) {
          sec.classList.add('drag-over-above');
          break;
        } else {
          const idx = allSections.indexOf(sec);
          if (idx === allSections.length - 1) {
            sec.classList.add('drag-over-below');
            break;
          }
        }
      }
    }
    return;
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOUSEUP â€” all drag types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('mouseup', (e) => {
  if (!dragState) return;

  if (dragState.type === 'divider') {
    dragState.divider.classList.remove('active');
    updateAllDims();
    dragState = null;
    return;
  }

  if (dragState.type === 'section' && dragState.moved) {
    ghost.style.display = 'none';
    dragState.el.classList.remove('dragging');

    // Find drop target
    const target = document.querySelector('.section.drag-over-above, .section.drag-over-below');
    if (target && target !== dragState.el) {
      const isAbove = target.classList.contains('drag-over-above');

      // Remove section and its divider from current position
      const prevDiv = dragState.el.previousElementSibling;
      const nextDiv = dragState.el.nextElementSibling;
      if (prevDiv && prevDiv.classList.contains('divider')) prevDiv.remove();
      else if (nextDiv && nextDiv.classList.contains('divider')) nextDiv.remove();
      dragState.el.remove();

      // Insert at new position
      const newDivider = document.createElement('div');
      newDivider.className = 'divider';

      if (isAbove) {
        canvas.insertBefore(dragState.el, target);
        canvas.insertBefore(newDivider, target);
      } else {
        const after = target.nextElementSibling;
        if (after && after.classList.contains('divider')) {
          canvas.insertBefore(dragState.el, after.nextElementSibling);
          canvas.insertBefore(newDivider, dragState.el);
        } else {
          canvas.appendChild(newDivider);
          canvas.appendChild(dragState.el);
        }
      }
    }

    document.querySelectorAll('.section').forEach(s => {
      s.classList.remove('drag-over-above', 'drag-over-below');
    });
    updateAllDims();
    dragState = null;
    return;
  }

  if (dragState.type === 'item') {
    dragState.el.classList.remove('dragging');
    dragState = null;
    return;
  }

  if (dragState.type === 'palette' && dragState.moved) {
    ghost.style.display = 'none';

    // Find drop position
    const target = document.querySelector('.section.drag-over-above, .section.drag-over-below');
    document.querySelectorAll('.section').forEach(s => {
      s.classList.remove('drag-over-above', 'drag-over-below');
    });

    if (target) {
      const isAbove = target.classList.contains('drag-over-above');
      // Temporarily create section at end, then move
      const id = createSection(dragState.template);
      if (id) {
        const sec = sections[id];
        const prevDiv = sec.el.previousElementSibling;

        // Remove from end
        if (prevDiv && prevDiv.classList.contains('divider')) prevDiv.remove();
        sec.el.remove();

        // Insert at target
        const newDivider = document.createElement('div');
        newDivider.className = 'divider';

        if (isAbove) {
          canvas.insertBefore(sec.el, target);
          canvas.insertBefore(newDivider, target);
        } else {
          const after = target.nextElementSibling;
          if (after && after.classList.contains('divider')) {
            canvas.insertBefore(sec.el, after.nextElementSibling);
            canvas.insertBefore(newDivider, sec.el);
          } else {
            canvas.appendChild(newDivider);
            canvas.appendChild(sec.el);
          }
        }
        updateAllDims();
      }
    } else {
      createSection(dragState.template);
      updateAllDims();
    }

    dragState = null;
    return;
  }

  ghost.style.display = 'none';
  dragState = null;
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRESETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function clearCanvas() {
  canvas.innerHTML = '';
  sections = {};
  sectionCounter = 0;
  selectedId = null;
}

function loadPreset(name) {
  clearCanvas();

  if (name === 'tutor-setup') {
    createSection('vault');
    createSection('toolbar');
    createSection('sessions');
  } else if (name === 'tutor-chat') {
    createSection('toolbar');
    createSection('chat');
    createSection('sessions');
  }

  selectSection(null);
  requestAnimationFrame(updateAllDims);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COPY LAYOUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyLayout() {
  const cr = canvas.getBoundingClientRect();
  const parts = ['Layout specification from the Arcade Page Builder:\n'];

  const secs = canvas.querySelectorAll('.section');
  secs.forEach(sec => {
    const id = sec.dataset.sectionId;
    const info = sections[id];
    if (!info) return;
    const rect = sec.getBoundingClientRect();
    const wPct = ((rect.width / cr.width) * 100).toFixed(0);
    const hPct = ((rect.height / cr.height) * 100).toFixed(0);

    parts.push(`${info.title}:`);
    parts.push(`  Size: ${Math.round(rect.width)}Ã—${Math.round(rect.height)}px (${wPct}%w Ã— ${hPct}%h)`);
    parts.push(`  Flex: ${sec.style.flex || 'none'}  Height: ${sec.style.height || 'auto'}`);

    // List contents
    const items = sec.querySelectorAll('.item');
    if (items.length > 0) {
      const names = [...items].map(i => i.textContent.trim().replace(/\s+/g, ' ')).filter(Boolean).slice(0, 10);
      if (names.length) parts.push(`  Contents: ${names.join(' | ')}`);
    }
    parts.push('');
  });

  const text = parts.join('\n');
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.querySelector('.tb-copy');
    const orig = btn.textContent;
    btn.textContent = 'COPIED!';
    btn.style.background = '#4ade80';
    setTimeout(() => { btn.textContent = orig; btn.style.background = ''; }, 1200);
  });

  document.getElementById('promptText').textContent = text;
  document.getElementById('promptBar').classList.add('visible');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', (e) => {
  if ((e.key === 'Delete' || e.key === 'Backspace') && selectedId && !e.target.closest('input,textarea')) {
    removeSection(selectedId);
  }
  if (e.key === 'Escape') selectSection(null);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESIZE OBSERVER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const resizeObs = new ResizeObserver(() => {
  updateAllDims();
  updateInfoBar();
});
resizeObs.observe(canvas);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderPalette();
loadPreset('tutor-setup');
</script>
</body>
</html>
